<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Spirit Guide App â€” Stable Build</title>
  <link rel="stylesheet" href="style.css"/>
  <style>
    /* Minimal safe styles in case style.css is missing */
    body{font-family: system-ui, Arial, sans-serif;background:#0b0b0f;color:#eef;line-height:1.5;margin:0}
    .wrap{max-width:960px;margin:0 auto;padding:20px}
    h1{margin:0 0 8px;font-size:28px}
    .card{background:#12121a;border:1px solid #222;border-radius:12px;padding:16px;margin:12px 0}
    label{display:block;margin:.6rem 0 .25rem}
    input,select,button,textarea{font:inherit;border-radius:8px;border:1px solid #333;background:#0f0f15;color:#eef;padding:.6rem}
    button{cursor:pointer}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row > *{flex:1 1 260px}
    .muted{opacity:.8}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
    .kpi{background:#0f111a;border:1px solid #242636;border-radius:10px;padding:10px}
    .kpi h3{margin:0 0 4px;font-size:14px;color:#9dd}
    .kpi div{font-weight:700;font-size:18px}
    .long {white-space: pre-line; background:#0d0f16; border:1px solid #222; padding:12px; border-radius:10px}
    .success{color:#7dffa3}
    .error{color:#ff8f8f}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ðŸ”® Spirit Guide App</h1>
    <p class="muted">Stable build with expanded numerology meanings + cacheâ€‘busting JSON fetch.</p>

    <!-- INPUTS -->
    <div class="card">
      <div class="row">
        <div>
          <label for="name">Your Name</label>
          <input id="name" placeholder="e.g., Steven Abbott"/>
        </div>
        <div>
          <label for="dob">Date of Birth</label>
          <input id="dob" type="date"/>
        </div>
      </div>
      <div class="row">
        <div>
          <label for="ambient">Ambient sound</label>
          <select id="ambient">
            <option value="">None</option>
            <option value="ambient/rain.mp3">Rain</option>
            <option value="ambient/choir.mp3">Choir</option>
            <option value="ambient/drone.mp3">Drone</option>
          </select>
          <button id="stopAudio">Stop</button>
        </div>
        <div>
          <label>&nbsp;</label>
          <div class="row">
            <button id="demoBtn">Demo</button>
            <button id="calcBtn">Calculate</button>
            <button id="resetBtn">Reset</button>
            <button id="copyBtn">Copy summary</button>
          </div>
        </div>
      </div>
    </div>

    <!-- RESULTS -->
    <div class="card" id="resultsCard" style="display:none">
      <h2 id="guideName">Your Spirit Guide</h2>
      <div class="grid">
        <div class="kpi"><h3>Life Path</h3><div id="lifePath" class="mono">â€”</div></div>
        <div class="kpi"><h3>Expression</h3><div id="expression" class="mono">â€”</div></div>
        <div class="kpi"><h3>Soul Urge</h3><div id="soulUrge" class="mono">â€”</div></div>
        <div class="kpi"><h3>Personality</h3><div id="personality" class="mono">â€”</div></div>
        <div class="kpi"><h3>Birthday</h3><div id="birthday" class="mono">â€”</div></div>
        <div class="kpi"><h3>Maturity</h3><div id="maturity" class="mono">â€”</div></div>
        <div class="kpi"><h3>Karmic Debts</h3><div id="karmicDebts" class="mono">â€”</div></div>
        <div class="kpi"><h3>Karmic Lessons</h3><div id="karmicLessons" class="mono">â€”</div></div>
        <div class="kpi"><h3>Balance</h3><div id="balance" class="mono">â€”</div></div>
      </div>
      <h3 style="margin-top:16px">ðŸ“– Life Path â€“ Deep Meaning</h3>
      <div id="lifePathLong" class="long">â€”</div>
    </div>

    <!-- EMAIL + CONSENT -->
    <div class="card" id="emailCard" style="display:none">
      <h3>Send my result</h3>
      <div class="row">
        <input id="email" type="email" placeholder="you@example.com"/>
        <label><input type="checkbox" id="consent"/> I agree to be contacted about my result.</label>
        <button id="sendBtn">Send</button>
      </div>
      <div id="sendStatus" class="muted"></div>
    </div>

    <!-- COUNTDOWN -->
    <div class="card" id="countdownCard" style="display:none">
      <strong>ðŸ•’ Backstory unlocks in: <span id="countdown">â€”</span></strong>
      <div class="muted">(24 hours after first calculation on this device)</div>
    </div>

    <div class="card muted">
      <small>Build includes: cacheâ€‘busting JSON fetch, localStorage caching, demo workflow, ambient controls, Apps Script submission.</small>
    </div>
  </div>

  <audio id="player" preload="none"></audio>

  <script>
  /************** CONFIG **************/
  const SHEETS_URL = "https://script.google.com/macros/s/AKfycbxlNWaWtYEnn4rizDRYRhkxey6CfGczi2oYkmDgRKs7rUHvnyWs0FTaQr1XB8FzJmhi/exec";

  /************** UTIL **************/
  const $ = (id)=>document.getElementById(id);
  function onlyLetters(str){ return (str||'').toUpperCase().replace(/[^A-Z]/g,''); }
  function sumDigits(n){ n = String(n).replace(/[^0-9]/g,''); return n.split('').reduce((a,b)=>a+Number(b),0); }
  function reduceNum(n){ n = Number(n); while (![11,22,33].includes(n) && n>9){ n = sumDigits(n); } return n; }
  function nameNumber(name, type){
    // Pythagorean mapping A=1..I=9,J=1.. etc.
    const map = {A:1,B:2,C:3,D:4,E:5,F:6,G:7,H:8,I:9,J:1,K:2,L:3,M:4,N:5,O:6,P:7,Q:8,R:9,S:1,T:2,U:3,V:4,W:5,X:6,Y:7,Z:8};
    const vowels = new Set(['A','E','I','O','U','Y']); // treat Y as vowel for Soul Urge here
    let cleaned = onlyLetters(name);
    let val = 0;
    for(const ch of cleaned){
      const v = map[ch]||0;
      if(type==='vowels' && vowels.has(ch)) val += v;
      else if(type==='consonants' && !vowels.has(ch)) val += v;
      else if(type==='all') val += v;
    }
    return reduceNum(val);
  }
  function dateToNumbers(dstr){
    const d = new Date(dstr);
    if(isNaN(d)) return {lifePath:null,birthday:null};
    const yyyy = d.getUTCFullYear(), mm = d.getUTCMonth()+1, dd = d.getUTCDate();
    const lifePath = reduceNum(sumDigits(yyyy)+sumDigits(mm)+sumDigits(dd));
    const birthday = reduceNum(dd);
    return {lifePath,birthday};
  }
  function formatKarmicDebts(totalStr){
    // very simple flag: 13/14/16/19 if appear in raw DOB components
    const debts = [];
    if(totalStr.includes('13')) debts.push(13);
    if(totalStr.includes('14')) debts.push(14);
    if(totalStr.includes('16')) debts.push(16);
    if(totalStr.includes('19')) debts.push(19);
    return debts.length? debts.join(', ') : 'None';
  }
  function timeLeftString(ms){
    if(ms<=0) return "0m";
    const s = Math.floor(ms/1000);
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    const sc = s%60;
    return h + "h " + m + "m " + sc + "s";
  }
  function deterministicGuide(name,dob){
    // Simple hash â†’ pick from sample names (you can expand later)
    const guides = ["Zoriel","Nymera","Elarion","Serapha","Kael","Aven","Lyra","Thalen","Mireth","Orin"];
    const seed = (onlyLetters(name)+dob).split('').reduce((a,c)=>a + c.charCodeAt(0),0);
    return guides[ seed % guides.length ];
  }

  /************** STATE **************/
  const STORAGE_KEY = "spirit-guide-state-v2";
  let longDB = null;
  let countdownTimer = null;

  /************** INIT **************/
  (function init(){
    // attach events
    $("calcBtn").addEventListener("click", onCalculate);
    $("demoBtn").addEventListener("click", onDemo);
    $("resetBtn").addEventListener("click", onReset);
    $("copyBtn").addEventListener("click", onCopy);
    $("sendBtn").addEventListener("click", onSend);
    $("ambient").addEventListener("change", onAmbientChange);
    $("stopAudio").addEventListener("click", ()=>{ const a=$("player"); a.pause(); a.currentTime=0; });

    // preload JSON (with cache-bust) for long descriptions
    fetch('numerology_descriptions.json?v=' + Date.now())
      .then(r=>r.json())
      .then(db=>{ longDB = db; console.log("Loaded numerology JSON", db); })
      .catch(err=>console.error("Failed to load numerology JSON", err));

    // restore state if present
    const saved = localStorage.getItem(STORAGE_KEY);
    if(saved){
      try{
        const s = JSON.parse(saved);
        $("name").value = s.name || "";
        $("dob").value = s.dob || "";
        if(s.results){
          renderResults(s.results);
          $("resultsCard").style.display = "block";
          $("emailCard").style.display = "block";
          setupCountdown(s.firstCalcAt);
        }
      }catch(e){ console.warn("Bad saved state", e); }
    }
  })();

  /************** CORE **************/
  function onDemo(){
    $("name").value = "Alex Example";
    $("dob").value = "1990-07-14";
  }

  function onCalculate(){
    const name = $("name").value.trim();
    const dob = $("dob").value;
    if(!name || !dob){ alert("Please enter your name and date of birth."); return; }

    const {lifePath,birthday} = dateToNumbers(dob);
    const expression = nameNumber(name,'all');
    const soulUrge = nameNumber(name,'vowels');
    const personality = nameNumber(name,'consonants');
    const maturity = reduceNum(lifePath + expression);
    const balance = reduceNum(nameNumber(name[0]||'','all') + (new Date(dob)).getUTCDate());
    const karmicLessons = "â€”"; // placeholder; computing exact missing letters is optional here
    const karmicDebts = formatKarmicDebts(dob.replace(/-/g,''));

    const guide = deterministicGuide(name, dob);

    const results = {
      name, dob, guide,
      lifePath, expression, soulUrge, personality, birthday, maturity, karmicDebts, karmicLessons, balance
    };
    renderResults(results);

    const firstCalcAt = Date.now();
    localStorage.setItem(STORAGE_KEY, JSON.stringify({name, dob, results, firstCalcAt}));

    $("resultsCard").style.display = "block";
    $("emailCard").style.display = "block";
    setupCountdown(firstCalcAt);
  }

  function renderResults(r){
    $("guideName").textContent = "Your Spirit Guide: " + r.guide;
    $("lifePath").textContent = r.lifePath;
    $("expression").textContent = r.expression;
    $("soulUrge").textContent = r.soulUrge;
    $("personality").textContent = r.personality;
    $("birthday").textContent = r.birthday;
    $("maturity").textContent = r.maturity;
    $("karmicDebts").textContent = r.karmicDebts;
    $("karmicLessons").textContent = r.karmicLessons;
    $("balance").textContent = r.balance;

    // Long description for Life Path
    if(longDB && longDB.numbers){
      const info = longDB.numbers[String(r.lifePath)] || null;
      if(info){
        $("lifePathLong").textContent = [
          info.overview, info.strengths, info.challenges, info.relationships, info.watchouts, info.coaching
        ].join("\n\n");
      }else{
        $("lifePathLong").textContent = "Detailed meaning unavailable for Life Path " + r.lifePath + ".";
      }
    }else{
      $("lifePathLong").textContent = "Loading meaningsâ€¦ (If this message remains, numerology_descriptions.json did not load.)";
    }
  }

  function setupCountdown(firstCalcAt){
    // 24 hours unlock
    const unlockAt = firstCalcAt + 24*60*60*1000;
    $("countdownCard").style.display = "block";
    if(countdownTimer) clearInterval(countdownTimer);
    countdownTimer = setInterval(()=>{
      const left = unlockAt - Date.now();
      $("countdown").textContent = timeLeftString(left);
      if(left <= 0){ clearInterval(countdownTimer); $("countdown").textContent = "0m"; }
    }, 1000);
  }

  function onReset(){
    localStorage.removeItem(STORAGE_KEY);
    location.reload();
  }

  function onCopy(){
    const saved = localStorage.getItem(STORAGE_KEY);
    if(!saved){ alert("Nothing to copy yet. Calculate your guide first."); return; }
    navigator.clipboard.writeText(saved).then(()=>{
      alert("Copied your summary to clipboard.");
    });
  }

  function onAmbientChange(e){
    const src = e.target.value;
    const p = $("player");
    if(!src){ p.pause(); return; }
    p.src = src; p.loop = true; p.play().catch(console.warn);
  }

  async function onSend(){
    const email = $("email").value.trim();
    const consent = $("consent").checked;
    if(!email){ $("sendStatus").innerHTML = '<span class="error">Enter an email.</span>'; return; }
    if(!consent){ $("sendStatus").innerHTML = '<span class="error">Please tick consent.</span>'; return; }

    const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
    const payload = {
      email, consent: true,
      timestamp: new Date().toISOString(),
      result: saved.results || null
    };

    $("sendStatus").textContent = "Sendingâ€¦";
    try{
      const res = await fetch(SHEETS_URL, {
        method: "POST",
        mode: "no-cors",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });
      $("sendStatus").innerHTML = '<span class="success">Saved. We will follow up by email.</span>';
    }catch(err){
      console.error(err);
      $("sendStatus").innerHTML = '<span class="error">Could not send. Try again later.</span>';
    }
  }
  </script>
</body>
</html>
