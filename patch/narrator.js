class Narrator{constructor(){this.voices=[];this.selectedVoiceName=localStorage.getItem("voice.name")||"";this.forceEnglish="true"===localStorage.getItem("voice.forceEnglish");this.rate=parseFloat(localStorage.getItem("voice.rate")||"0.95");this.pitch=parseFloat(localStorage.getItem("voice.pitch")||"1.0");this.pauseMs=parseInt(localStorage.getItem("voice.pauseMs")||"260",10);this.isSpeaking=!1;this.queue=[];this.currentUtterance=null;this.preferredEnglishNames=["Microsoft Sonia Online (Natural) - English (United Kingdom)","Microsoft Ryan Online (Natural) - English (United Kingdom)","Microsoft Libby Online (Natural) - English (United Kingdom)","Microsoft Thomas Online (Natural) - English (United Kingdom)","Google UK English Female","Google UK English Male","Google English (Great Britain)","Daniel","Serena","Moira","Samantha"];this.bindUI();this.initVoices()}bindUI(){this.$select=document.getElementById("voiceSelect");this.$test=document.getElementById("testVoiceBtn");this.$force=document.getElementById("forceEnglish");this.$stop=document.getElementById("stopNarrationBtn");this.$rate=document.getElementById("rateSlider");this.$pitch=document.getElementById("pitchSlider");this.$pause=document.getElementById("pauseSlider");this.$preset=document.getElementById("naturalPresetBtn");this.$force&&(this.$force.checked=this.forceEnglish,this.$force.addEventListener("change",(()=>{this.forceEnglish=!!this.$force.checked,localStorage.setItem("voice.forceEnglish",String(this.forceEnglish))})));const e=(e,t)=>localStorage.setItem(e,String(t));this.$rate&&(this.$rate.value=this.rate,this.$rate.addEventListener("input",(()=>{this.rate=parseFloat(this.$rate.value),e("voice.rate",this.rate)}))),this.$pitch&&(this.$pitch.value=this.pitch,this.$pitch.addEventListener("input",(()=>{this.pitch=parseFloat(this.$pitch.value),e("voice.pitch",this.pitch)}))),this.$pause&&(this.$pause.value=this.pauseMs,this.$pause.addEventListener("input",(()=>{this.pauseMs=parseInt(this.$pause.value,10),localStorage.setItem("voice.pauseMs",String(this.pauseMs))}))),this.$preset&&this.$preset.addEventListener("click",(()=>{this.rate=.95,this.pitch=1,this.pauseMs=260,this.$rate&&(this.$rate.value=this.rate),this.$pitch&&(this.$pitch.value=this.pitch),this.$pause&&(this.$pause.value=this.pauseMs),localStorage.setItem("voice.rate",String(this.rate)),localStorage.setItem("voice.pitch",String(this.pitch)),localStorage.setItem("voice.pauseMs",String(this.pauseMs))})),this.$test&&this.$test.addEventListener("click",(()=>{const e=this.getSelectedVoice(),t=this.forceEnglish?"Hello. This is the natural voice test. Does this sound smoother to you?":"Hello. This is the natural voice test. Does this sound smoother to you?";this.speak(t,{interrupt:!0,voice:e})})),this.$stop&&this.$stop.addEventListener("click",(()=>this.stop(!0))),this.$select&&this.$select.addEventListener("change",(()=>{const e=this.$select.value;localStorage.setItem("voice.name",e)}))}initVoices(){const e=()=>{const e=speechSynthesis.getVoices();return!!(e&&e.length)&&(this.voices=e.slice().sort(((e,t)=>((e.name||"").localeCompare(t.name||"")))),this.populateSelect(),!0)};e()||(window.speechSynthesis.onvoiceschanged=()=>e(),setTimeout((()=>e()),400),setTimeout((()=>e()),1200),setTimeout((()=>e()),2400))}populateSelect(){if(!this.$select)return;this.$select.innerHTML="";const e=e=>{const t=document.createElement("option");return t.value=e.name,t.textContent=`${e.name} â€” ${e.lang}${e.default?" (default)":"")}`,t};this.voices.forEach((t=>this.$select.appendChild(e(t))));const t=this.selectedVoiceName;if(t&&this.voices.find((e=>e.name===t)))this.$select.value=t;else{const t=this.pickPreferredEnglish()||this.voices[0];t&&(this.$select.value=t.name,localStorage.setItem("voice.name",t.name))}}pickPreferredEnglish(){for(const e of this.preferredEnglishNames){const t=this.voices.find((t=>t.name===e));if(t)return t}const e=this.voices.find((e=>/^en[-_](GB|UK)/i.test(e.lang)));return e||this.voices.find((e=>/^en[-_]/i.test(e.lang)))}getSelectedVoice(){const e=this.$select&&this.$select.value||this.selectedVoiceName;return this.voices.find((t=>t.name===e))||null}speak(e,t={}){const{interrupt:s=!1,voice:i=null,rate:o=null,pitch:a=null,volume:n=1}=t;if(!e||"string"!=typeof e)return;s&&this.stop(!1);const l=new SpeechSynthesisUtterance(e),r=i||this.getSelectedVoice();r&&(l.voice=r),l.lang=this.forceEnglish?(this.voices.find((e=>/^en[-_](GB|UK)/i.test(e.lang)))?.lang||"en-GB"):r?.lang||l.lang,l.rate=null!=o?o:this.rate,l.pitch=null!=a?a:this.pitch,l.volume=n,l.onstart=(()=>{this.isSpeaking=!0,this.currentUtterance=l,document.body.classList.add("is-speaking")});const c=()=>{this.isSpeaking=!1,this.currentUtterance=null,document.body.classList.remove("is-speaking");const e=this.queue.shift();e&&(e.pause?setTimeout((()=>this.speak(e.text,e.opts)),e.pause):this.speak(e.text,e.opts))};l.onend=c,l.onerror=c;try{speechSynthesis.speak(l)}catch(e){console.error(e),c()}}readNaturally(e){if(!e)return;const t=this.segment(e);t.forEach(((e,t)=>{const s={interrupt:!1};this.queue.push({text:e,opts:s,pause:0===t?0:this.pauseMs})})),this.isSpeaking||((e=this.queue.shift())&&(e.pause?setTimeout((()=>this.speak(e.text,e.opts)),e.pause):this.speak(e.text,e.opts)))}segment(e){const t=e.split(/(?<=[\.\?\!])\s+(?=[A-Z0-9])/).map((e=>e.trim())).filter(Boolean);return t.length?t:[e]}stop(e=!0){try{speechSynthesis.cancel()}catch(e){}this.isSpeaking=!1,this.currentUtterance=null,document.body.classList.remove("is-speaking"),e&&(this.queue=[])}}export const narrator=new Narrator;window.narrator=narrator;