<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Spirit Guide App</title>
  <link rel="stylesheet" href="style.css"/>
  <style>
    :root{
      --bg:#070b07; --panel:#0d140f; --border:#162417;
      --text:#e8fff3; --muted:#a6cbb4; --accent:#7fffd4; --accent-2:#52d9a7;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{background:transparent; color:var(--text); font-family:system-ui,Segoe UI,Arial,sans-serif; margin:0; min-height:100vh}
    /* Matrix gradient base */
    #bgGradient{position:fixed; inset:0; z-index:0; background:radial-gradient(ellipse at 50% -20%, #0c1a12 10%, #070b07 60%)}
    /* Matrix canvas above gradient */
    #matrixCanvas{position:fixed; inset:0; z-index:1; pointer-events:none}
    /* App content */
    .wrap{position:relative; z-index:2; max-width:1000px;margin:0 auto;padding:24px}
    h1{margin:0 0 8px; font-size:30px; text-shadow:0 0 18px rgba(127,255,212,.25)}
    .sub{color:var(--muted); margin:0 0 16px}
    .card{background:rgba(13,20,15,.9); backdrop-filter: blur(2px); border:1px solid var(--border); border-radius:14px; padding:16px; margin:14px 0; box-shadow: 0 8px 30px rgba(0,0,0,.25)}
    label{display:block; font-weight:600; margin:.5rem 0 .3rem}
    input,select,button{font:inherit; border-radius:10px; border:1px solid var(--border); background:#0a100b; color:var(--text); padding:.55rem .7rem}
    button{cursor:pointer}
    .row{display:flex; gap:12px; flex-wrap:wrap}
    .row > *{flex:1 1 260px}
    .grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px}
    .kpi{background:#0a100b; border:1px solid var(--border); border-radius:10px; padding:10px}
    .kpi h3{margin:0 0 4px; font-size:14px; color:var(--accent)}
    .kpi div{font-weight:700; font-size:18px}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .long{white-space:pre-line; background:#0a100b; border:1px solid var(--border); padding:12px; border-radius:10px}
    .section-title{margin:16px 0 8px}
    .narrator{display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:8px}
    .banner{background:linear-gradient(90deg,#103a24,#0f3437); border:1px solid var(--border); padding:12px; border-radius:12px}
    .banner strong{color:var(--accent)}
    .primary{background:var(--accent-2); border-color:var(--accent-2); color:#001e11; font-weight:700}
    .primary:hover{filter:brightness(1.05)}
    .muted{color:var(--muted)}
    .tiny{font-size:12px}
    .toggle{display:flex; align-items:center; gap:8px; color:var(--muted); margin-top:6px}
  </style>
</head>
<body>
  <div id="bgGradient"></div>
  <canvas id="matrixCanvas"></canvas>

  <div class="wrap">
    <h1>🔮 Spirit Guide App</h1>
    <p class="sub">Dark/mint theme • Matrix rain backdrop • Expanded meanings • Narrator with voice selector • 24‑hour email follow‑up.</p>

    <!-- INPUTS -->
    <section class="card">
      <div class="row">
        <div>
          <label for="name">Your Name</label>
          <input id="name" placeholder="e.g., Steven Abbott"/>
        </div>
        <div>
          <label for="dob">Date of Birth</label>
          <input id="dob" type="date"/>
        </div>
      </div>
      <div class="row">
        <div>
          <label for="ambient">Ambient sound</label>
          <div class="row">
            <select id="ambient">
              <option value="">None</option>
              <option value="rain">Rain</option>
              <option value="choir">Choir</option>
              <option value="drone">Drone</option>
            </select>
            <button id="stopAudio">Stop</button>
          </div>
          <div class="toggle">
            <input type="checkbox" id="matrixToggle" checked>
            <label for="matrixToggle">Matrix rain background</label>
          </div>
        </div>
        <div>
          <label>&nbsp;</label>
          <div class="row">
            <button id="demoBtn">Demo</button>
            <button id="calcBtn">Calculate</button>
            <button id="resetBtn">Reset</button>
            <button id="copyBtn">Copy summary</button>
          </div>
        </div>
      </div>
    </section>

    <!-- RESULTS SNAPSHOT -->
    <section class="card" id="resultsCard" style="display:none">
      <h2 id="guideName">Your Spirit Guide</h2>
      <div class="grid">
        <div class="kpi"><h3>Life Path</h3><div id="lifePath" class="mono">—</div></div>
        <div class="kpi"><h3>Expression</h3><div id="expression" class="mono">—</div></div>
        <div class="kpi"><h3>Soul Urge</h3><div id="soulUrge" class="mono">—</div></div>
        <div class="kpi"><h3>Personality</h3><div id="personality" class="mono">—</div></div>
        <div class="kpi"><h3>Birthday</h3><div id="birthday" class="mono">—</div></div>
        <div class="kpi"><h3>Maturity</h3><div id="maturity" class="mono">—</div></div>
        <div class="kpi"><h3>Karmic Debts</h3><div id="karmicDebts" class="mono">—</div></div>
        <div class="kpi"><h3>Karmic Lessons</h3><div id="karmicLessons" class="mono">—</div></div>
        <div class="kpi"><h3>Balance</h3><div id="balance" class="mono">—</div></div>
      </div>
      <div class="narrator">
        <strong>🎙️ Narrator</strong>
        <select id="voiceSelect" title="Choose a voice"></select>
        <button id="speakBtn">Play</button>
        <button id="stopSpeakBtn">Stop</button>
      </div>
    </section>

    <!-- EMAIL + CONSENT -->
    <section class="card" id="emailCard" style="display:none">
      <div class="banner">
        <strong>📩 We’ll email your full 400‑word backstory in <u>24 hours</u>.</strong>
        <div class="muted tiny">Enter your email and tick consent so we can send it.</div>
        <div class="row" style="margin-top:8px">
          <input id="email" type="email" placeholder="you@example.com"/>
          <label><input type="checkbox" id="consent"/> I agree to be contacted about my result.</label>
          <button id="sendBtn" class="primary">Send my result</button>
        </div>
        <div id="sendStatus" class="muted tiny"></div>
      </div>
    </section>

    <!-- LONG EXPLANATIONS -->
    <section class="card" id="longCard" style="display:none">
      <h3 class="section-title">📖 Life Path — Deep Meaning</h3>
      <div id="lifePathLong" class="long">—</div>

      <h3 class="section-title">🗣️ Expression — How You Operate</h3>
      <div id="expressionLong" class="long">—</div>

      <h3 class="section-title">💗 Soul Urge — What Your Heart Wants</h3>
      <div id="soulUrgeLong" class="long">—</div>

      <h3 class="section-title">🪞 Personality — How Others See You</h3>
      <div id="personalityLong" class="long">—</div>

      <h3 class="section-title">🎂 Birthday — Your Natural Gift</h3>
      <div id="birthdayLong" class="long">—</div>

      <h3 class="section-title">🌱 Maturity — Your Long Arc</h3>
      <div id="maturityLong" class="long">—</div>

      <h3 class="section-title">⚖️ Balance — How You Re‑centre</h3>
      <div id="balanceLong" class="long">—</div>
    </section>

    <!-- COUNTDOWN -->
    <section class="card" id="countdownCard" style="display:none">
      <strong>🕒 Backstory unlocks in: <span id="countdown">—</span></strong>
      <div class="muted tiny">(24 hours after first calculation on this device)</div>
    </section>
  </div>

  <audio id="player" preload="none"></audio>

  <script>
  const SHEETS_URL = "https://script.google.com/macros/s/AKfycbxlNWaWtYEnn4rizDRYRhkxey6CfGczi2oYkmDgRKs7rUHvnyWs0FTaQr1XB8FzJmhi/exec";

  const $ = (id)=>document.getElementById(id);
  function onlyLetters(str){ return (str||'').toUpperCase().replace(/[^A-Z]/g,''); }
  function sumDigits(n){ n = String(n).replace(/[^0-9]/g,''); return n.split('').reduce((a,b)=>a+Number(b),0); }
  function reduceNum(n){ n = Number(n); while (![11,22,33].includes(n) && n>9){ n = sumDigits(n); } return n; }
  function nameNumber(name, type){
    const map = {A:1,B:2,C:3,D:4,E:5,F:6,G:7,H:8,I:9,J:1,K:2,L:3,M:4,N:5,O:6,P:7,Q:8,R:9,S:1,T:2,U:3,V:4,W:5,X:6,Y:7,Z:8};
    const vowels = new Set(['A','E','I','O','U','Y']);
    let cleaned = onlyLetters(name);
    let val = 0;
    for(const ch of cleaned){
      const v = map[ch]||0;
      if(type==='vowels' && vowels.has(ch)) val += v;
      else if(type==='consonants' && !vowels.has(ch)) val += v;
      else if(type==='all') val += v;
    }
    return reduceNum(val);
  }
  function dateToNumbers(dstr){
    const d = new Date(dstr);
    if(isNaN(d)) return {lifePath:null,birthday:null};
    const yyyy = d.getUTCFullYear(), mm = d.getUTCMonth()+1, dd = d.getUTCDate();
    const lifePath = reduceNum(sumDigits(yyyy)+sumDigits(mm)+sumDigits(dd));
    const birthday = reduceNum(dd);
    return {lifePath,birthday};
  }
  function formatKarmicDebts(totalStr){
    const debts = [];
    if(totalStr.includes('13')) debts.push(13);
    if(totalStr.includes('14')) debts.push(14);
    if(totalStr.includes('16')) debts.push(16);
    if(totalStr.includes('19')) debts.push(19);
    return debts.length? debts.join(', ') : 'None';
  }
  function timeLeftString(ms){
    if(ms<=0) return "0m";
    const s = Math.floor(ms/1000);
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    const sc = s%60;
    return h + "h " + m + "m " + sc + "s";
  }
  function deterministicGuide(name,dob){
    const guides = ["Zoriel","Nymera","Elarion","Serapha","Kael","Aven","Lyra","Thalen","Mireth","Orin"];
    const seed = (onlyLetters(name)+dob).split('').reduce((a,c)=>a + c.charCodeAt(0),0);
    return guides[ seed % guides.length ];
  }

  const STORAGE_KEY = "spirit-guide-state-v12";
  let longDB = null;
  let countdownTimer = null;
  let voiceList = [];

  // Matrix variables
  let matrixEnabled = true;
  let ctx, W, H, fontSize, columns, drops;

  // WebAudio ambient
  let audioCtx = null, ambientNodes = [];
  function ensureCtx(){
    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === 'suspended') audioCtx.resume();
    return audioCtx;
  }
  function stopAmbient(){
    ambientNodes.forEach(n=>{try{n.stop ? n.stop() : n.disconnect()}catch(e){} if(n.disconnect) n.disconnect();});
    ambientNodes = [];
  }
  function startAmbient(type){
    ensureCtx();
    stopAmbient();
    if(type === 'rain'){
      // Pink-ish noise + gentle HPF + drip ticks
      const bufferSize = 2 * audioCtx.sampleRate;
      const noiseBuffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
      const output = noiseBuffer.getChannelData(0);
      let b0=0,b1=0,b2=0; // pink noise filter
      for (let i = 0; i < bufferSize; i++) {
        const white = Math.random() * 2 - 1;
        b0 = 0.99765 * b0 + white * 0.0990460;
        b1 = 0.96300 * b1 + white * 0.2965164;
        b2 = 0.57000 * b2 + white * 1.0526913;
        output[i] = b0 + b1 + b2 + white * 0.1848;
        output[i] *= 0.3;
      }
      const noise = audioCtx.createBufferSource();
      noise.buffer = noiseBuffer;
      noise.loop = true;
      const hpf = audioCtx.createBiquadFilter(); hpf.type='highpass'; hpf.frequency.value=200;
      const lpf = audioCtx.createBiquadFilter(); lpf.type='lowpass'; lpf.frequency.value=4000;
      const gain = audioCtx.createGain(); gain.gain.value=0.2;
      noise.connect(hpf).connect(lpf).connect(gain).connect(audioCtx.destination);
      noise.start();
      ambientNodes.push(noise, hpf, lpf, gain);
      // occasional drips
      const dripGain = audioCtx.createGain(); dripGain.gain.value=0.0; dripGain.connect(audioCtx.destination);
      ambientNodes.push(dripGain);
      function drip(){
        const o = audioCtx.createOscillator();
        o.type='sine'; o.frequency.value=1200;
        const g = audioCtx.createGain(); g.gain.value=0.002;
        o.connect(g).connect(audioCtx.destination);
        o.start();
        o.frequency.exponentialRampToValueAtTime(200, audioCtx.currentTime+0.2);
        g.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime+0.25);
        o.stop(audioCtx.currentTime+0.3);
        ambientNodes.push(o,g);
        if(ambientNodes.indexOf(dripGain)!==-1){ setTimeout(drip, 1200 + Math.random()*1200); }
      }
      setTimeout(drip, 1000);
    }
    if(type === 'choir'){
      const root = 220; // A3
      const intervals = [0, 3, 7, 12]; // chordy
      intervals.forEach((semitones,i)=>{
        const o = audioCtx.createOscillator();
        o.type='sine';
        o.frequency.value = root * Math.pow(2, semitones/12);
        const g = audioCtx.createGain(); g.gain.value=0.0001;
        const lfo = audioCtx.createOscillator(); lfo.type='sine'; lfo.frequency.value=0.3 + Math.random()*0.2;
        const lfoGain = audioCtx.createGain(); lfoGain.gain.value=0.0006 + i*0.0002;
        lfo.connect(lfoGain).connect(g.gain);
        o.connect(g).connect(audioCtx.destination);
        o.start(); lfo.start();
        ambientNodes.push(o,g,lfo,lfoGain);
      });
    }
    if(type === 'drone'){
      const o1 = audioCtx.createOscillator(); o1.type='sawtooth'; o1.frequency.value=110;
      const o2 = audioCtx.createOscillator(); o2.type='square'; o2.frequency.value=110*1.5;
      const g = audioCtx.createGain(); g.gain.value=0.03;
      const lpf = audioCtx.createBiquadFilter(); lpf.type='lowpass'; lpf.frequency.value=800;
      o1.connect(lpf); o2.connect(lpf); lpf.connect(g).connect(audioCtx.destination);
      o1.start(); o2.start();
      ambientNodes.push(o1,o2,lpf,g);
    }
  }

  (function init(){
    $("calcBtn").addEventListener("click", onCalculate);
    $("demoBtn").addEventListener("click", onDemo);
    $("resetBtn").addEventListener("click", onReset);
    $("copyBtn").addEventListener("click", onCopy);
    $("sendBtn").addEventListener("click", onSend);

    // Ambient
    $("ambient").addEventListener("change", e=>{
      const v = e.target.value;
      if(!v){ stopAmbient(); return; }
      startAmbient(v);
    });
    $("stopAudio").addEventListener("click", stopAmbient);

    // Narrator
    const speakBtn = $("speakBtn");
    const stopSpeakBtn = $("stopSpeakBtn");
    if(speakBtn){ speakBtn.addEventListener("click", speakResults); }
    if(stopSpeakBtn){ stopSpeakBtn.addEventListener("click", stopSpeak); }

    // Voices
    function populateVoices(){
      voiceList = speechSynthesis.getVoices() || [];
      const sel = $("voiceSelect"); if(!sel) return; sel.innerHTML="";
      voiceList.forEach((v,i)=>{ const opt=document.createElement("option"); opt.value=i; opt.textContent=v.name+" ("+v.lang+")"; sel.appendChild(opt); });
    }
    populateVoices(); if('onvoiceschanged' in speechSynthesis){ speechSynthesis.onvoiceschanged = populateVoices; }

    // preload JSON (with cache-bust)
    fetch('numerology_descriptions.json?v=' + Date.now())
      .then(r=>r.json())
      .then(db=>{ longDB = db; console.log("Loaded numerology JSON", db); })
      .catch(err=>console.error("Failed to load numerology JSON", err));

    // Restore state
    const saved = localStorage.getItem(STORAGE_KEY);
    if(saved){
      try{
        const s = JSON.parse(saved);
        $("name").value = s.name || "";
        $("dob").value = s.dob || "";
        if(s.results){
          renderResults(s.results);
          $("resultsCard").style.display = "block";
          $("longCard").style.display = "block";
          $("emailCard").style.display = "block";
          setupCountdown(s.firstCalcAt);
        }
      }catch(e){ console.warn("Bad saved state", e); }
    }

    // Matrix rain ON by default
    const toggle = $("matrixToggle");
    toggle.checked = true;
    setupMatrix();
    toggle.addEventListener("change", (e)=>{
      matrixEnabled = e.target.checked;
      if(!matrixEnabled && ctx){ ctx.clearRect(0,0,W,H); }
    });
    window.addEventListener("resize", ()=>resizeMatrix());
  })();

  function onDemo(){ $("name").value = "Alex Example"; $("dob").value = "1990-07-14"; }

  function onCalculate(){
    const name = $("name").value.trim();
    const dob = $("dob").value;
    if(!name || !dob){ alert("Please enter your name and date of birth."); return; }

    const {lifePath,birthday} = dateToNumbers(dob);
    const expression = nameNumber(name,'all');
    const soulUrge = nameNumber(name,'vowels');
    const personality = nameNumber(name,'consonants');
    const maturity = reduceNum(lifePath + expression);
    const balance = reduceNum(nameNumber(name[0]||'','all') + (new Date(dob)).getUTCDate());
    const karmicLessons = "—";
    const karmicDebts = formatKarmicDebts(dob.replace(/-/g,''));
    const guide = deterministicGuide(name, dob);

    const results = {name,dob,guide,lifePath,expression,soulUrge,personality,birthday,maturity,karmicDebts,karmicLessons,balance};
    renderResults(results);

    const firstCalcAt = Date.now();
    localStorage.setItem(STORAGE_KEY, JSON.stringify({name, dob, results, firstCalcAt}));

    $("resultsCard").style.display = "block";
    $("longCard").style.display = "block";
    $("emailCard").style.display = "block";
    setupCountdown(firstCalcAt);
    $('emailCard').scrollIntoView({behavior:'smooth', block:'center'});
  }

  function customiseTextForPlacement(info, label, n){
    let text = [info.overview, info.strengths, info.challenges, info.relationships, info.watchouts, info.coaching].join("\\n\\n");
    const re1 = new RegExp("^\\s*Life\\s*Path\\s*"+n+"\\b","i");
    text = text.replace(re1, label + " " + n);
    const re2 = new RegExp("^\\s*Master\\s*Number\\s*"+n+"\\b","i");
    text = text.replace(re2, label + " " + n + " (Master Number)");
    return text;
  }

  function renderResults(r){
    $("guideName").textContent = "Your Spirit Guide: " + r.guide;
    $("lifePath").textContent = r.lifePath;
    $("expression").textContent = r.expression;
    $("soulUrge").textContent = r.soulUrge;
    $("personality").textContent = r.personality;
    $("birthday").textContent = r.birthday;
    $("maturity").textContent = r.maturity;
    $("karmicDebts").textContent = r.karmicDebts;
    $("karmicLessons").textContent = r.karmicLessons;
    $("balance").textContent = r.balance;

    if(longDB && longDB.numbers){
      const fmt = (n,label)=>{
        const info = longDB.numbers[String(n)];
        if(!info) return label + " " + n + ": Detailed meaning coming soon.";
        return customiseTextForPlacement(info, label, n);
      };
      $("lifePathLong").textContent   = fmt(r.lifePath,   "Life Path");
      $("expressionLong").textContent = fmt(r.expression, "Expression");
      $("soulUrgeLong").textContent   = fmt(r.soulUrge,   "Soul Urge");
      $("personalityLong").textContent= fmt(r.personality,"Personality");
      $("birthdayLong").textContent   = fmt(r.birthday,   "Birthday");
      $("maturityLong").textContent   = fmt(r.maturity,   "Maturity");
      $("balanceLong").textContent    = fmt(r.balance,    "Balance");
    }else{
      const msg = "Loading meanings… (If this remains, numerology_descriptions.json did not load.)";
      ["lifePathLong","expressionLong","soulUrgeLong","personalityLong","birthdayLong","maturityLong","balanceLong"].forEach(id=>$(id).textContent=msg);
    }
  }

  function setupCountdown(firstCalcAt){
    const unlockAt = firstCalcAt + 24*60*60*1000;
    $("countdownCard").style.display = "block";
    clearInterval(countdownTimer);
    countdownTimer = setInterval(()=>{
      const left = unlockAt - Date.now();
      $("countdown").textContent = timeLeftString(left);
      if(left <= 0){ clearInterval(countdownTimer); $("countdown").textContent = "0m"; }
    }, 1000);
  }

  function onReset(){ localStorage.removeItem(STORAGE_KEY); location.reload(); }
  function onCopy(){
    const saved = localStorage.getItem(STORAGE_KEY);
    if(!saved){ alert("Nothing to copy yet. Calculate your guide first."); return; }
    navigator.clipboard.writeText(saved).then(()=> alert("Copied your summary to clipboard.") );
  }

  // Voice selector
  function speakResults(){
    try{
      stopSpeak();
      const text = buildNarration();
      const utter = new SpeechSynthesisUtterance(text);
      const sel = $("voiceSelect");
      if(sel && sel.value && voiceList[sel.value]){
        utter.voice = voiceList[sel.value];
      }
      utter.rate = 1; utter.pitch = 1;
      speechSynthesis.speak(utter);
      window.__utter = utter;
    }catch(e){ console.warn(e); }
  }
  function stopSpeak(){
    try{
      if(speechSynthesis.speaking) speechSynthesis.cancel();
      window.__utter = null;
    }catch(e){}
  }
  function buildNarration(){
    const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
    const r = saved.results; if(!r || !longDB) return "Your reading is ready.";
    const get = (n)=> longDB.numbers[String(n)];
    const join = (label, n, obj)=> obj? (label+" "+n+". "+obj.overview):"";
    return [
      "Your spirit guide is " + r.guide + ".",
      join("Life Path", r.lifePath, get(r.lifePath)),
      join("Expression", r.expression, get(r.expression)),
      join("Soul Urge", r.soulUrge, get(r.soulUrge)),
      join("Personality", r.personality, get(r.personality)),
      join("Birthday", r.birthday, get(r.birthday)),
      join("Maturity", r.maturity, get(r.maturity)),
      join("Balance", r.balance, get(r.balance)),
      "We will email your full four hundred word backstory in approximately twenty four hours. Please ensure your email and consent are entered."
    ].filter(Boolean).join(" ");
  }

  // Matrix Rain
  function setupMatrix(){
    const canvas = $('matrixCanvas');
    ctx = canvas.getContext('2d');
    resizeMatrix();
    drops = new Array(columns).fill(0).map(()=> Math.floor(Math.random()*H/fontSize));
    requestAnimationFrame(drawMatrix);
  }
  function resizeMatrix(){
    const canvas = $('matrixCanvas');
    W = canvas.width = window.innerWidth;
    H = canvas.height = window.innerHeight;
    fontSize = 18; // slightly larger for readability
    columns = Math.floor(W / fontSize);
    drops = new Array(columns).fill(1);
  }
  function drawMatrix(){
    if(matrixEnabled && ctx){
      // Heavier trail for visibility
      ctx.fillStyle = 'rgba(7,11,7,0.12)';
      ctx.fillRect(0,0,W,H);
      ctx.fillStyle = '#7fffd4'; // mint
      ctx.shadowColor = '#7fffd4';
      ctx.shadowBlur = 8;
      ctx.font = fontSize + 'px monospace';
      for(let i=0;i<drops.length;i++){
        const text = String.fromCharCode(0x30A0 + Math.floor(Math.random()*96));
        const x = i * fontSize;
        const y = drops[i] * fontSize;
        ctx.fillText(text, x, y);
        // reset to top at random
        if(y > H && Math.random() > 0.95){ drops[i] = 0; }
        drops[i] += 1;
      }
    } else if(ctx){
      ctx.clearRect(0,0,W,H);
    }
    requestAnimationFrame(drawMatrix);
  }
  </script>
</body>
</html>
