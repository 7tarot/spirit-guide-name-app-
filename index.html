<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Spirit Guide App ‚Äî TTS Fix Build</title>
<style>
  body{background:#0c0f0c;color:#f1fff7;font-family:system-ui,Segoe UI,Arial,sans-serif;margin:0}
  .wrap{max-width:980px;margin:0 auto;padding:28px}
  .card{background:#121712;border:1px solid #1b291c;border-radius:14px;padding:18px;margin:16px 0}
  .narrator{display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin-top:16px;
    padding:14px;border:2px solid #57d9a9;border-radius:12px;background:rgba(127,255,212,0.08)}
  .narrator strong{font-size:18px;color:#57d9a9}
  .narrator select{min-width:220px;font-size:16px}
  .narrator button{font-weight:700;background:#57d9a9;color:#001e11}
</style>
</head>
<body>
<div class="wrap">
  <h1>üîÆ Spirit Guide App</h1>
  <section class="card">
    <label>Name <input id="name"/></label>
    <label>DOB <input id="dob" type="date"/></label>
    <button id="demoBtn">Demo</button>
    <button id="calcBtn">Calculate</button>
  </section>
  <section class="card" id="resultsCard" style="display:none">
    <h2 id="guideName">Your Spirit Guide</h2>
    <div>Life Path: <span id="lifePath"></span></div>
    <div class="narrator">
      <strong>üéôÔ∏è Narrator Voice</strong>
      <select id="voiceSelect"></select>
      <button id="speakBtn">Play</button>
      <button id="stopSpeakBtn">Stop</button>
      <button id="testVoiceBtn">Test voice</button>
    </div>
  </section>
</div>
<script>
const $=id=>document.getElementById(id);
function buildFullNarration(){return "This is a test reading for "+($("name").value||"")+", DOB "+($("dob").value||"");}

// Voices
function populateVoices(){
  const sel=$('voiceSelect'); sel.innerHTML="";
  const voices=speechSynthesis.getVoices()||[];
  let preferredIndex=0;
  voices.forEach((v,i)=>{
    const opt=document.createElement("option");
    opt.value=i; opt.textContent=v.name+" ("+v.lang+")";
    sel.appendChild(opt);
    if(v.lang && v.lang.toLowerCase().startsWith('en-gb')) preferredIndex=i;
    else if(v.lang && v.lang.toLowerCase().startsWith('en') && preferredIndex===0) preferredIndex=i;
  });
  sel.value=String(preferredIndex);
}
populateVoices(); if('onvoiceschanged' in speechSynthesis) speechSynthesis.onvoiceschanged=populateVoices;

function chunkText(txt,maxLen=280){
  const out=[]; if(!txt) return out;
  const parts=txt.split(/(?<=[\.!?])\s+/);
  let buf="";
  for(const p of parts){
    if((buf+" "+p).trim().length<=maxLen){buf=(buf?buf+" ":"")+p;}
    else{if(buf) out.push(buf.trim()); if(p.length<=maxLen) out.push(p.trim());
      else{for(let i=0;i<p.length;i+=maxLen){out.push(p.slice(i,i+maxLen));}} buf="";}
  }
  if(buf) out.push(buf.trim()); return out;
}
function getSelectedVoice(){const voices=speechSynthesis.getVoices()||[]; return voices[Number($('voiceSelect').value)||0];}
function speakChunks(text,voice){
  const chunks=chunkText(text); if(!chunks.length){alert("Nothing to read"); return;}
  if(speechSynthesis.speaking) speechSynthesis.cancel();
  let idx=0;
  const playNext=()=>{
    if(idx>=chunks.length) return;
    const u=new SpeechSynthesisUtterance(chunks[idx]);
    if(voice){u.voice=voice;if(voice.lang)u.lang=voice.lang;}
    u.rate=0.95; u.pitch=1.0; u.volume=1.0;
    u.onend=()=>{idx++;playNext();}; u.onerror=()=>{idx++;playNext();};
    speechSynthesis.speak(u);
  };
  playNext();
}
$('speakBtn').onclick=()=>{const voice=getSelectedVoice(); const text=buildFullNarration(); speakChunks(text,voice);};
$('stopSpeakBtn').onclick=()=>{if(speechSynthesis.speaking) speechSynthesis.cancel();};
$('testVoiceBtn').onclick=()=>{
  const v=getSelectedVoice();
  const u=new SpeechSynthesisUtterance(v&&v.lang&&v.lang.startsWith('en')?"Testing this voice.":"Testing this voice.");
  if(v){u.voice=v;if(v.lang)u.lang=v.lang;} speechSynthesis.speak(u);
};
$('demoBtn').onclick=()=>{$('name').value="Alex Example"; $('dob').value="1990-07-14";};
$('calcBtn').onclick=()=>{$('resultsCard').style.display="block";$('guideName').textContent="Guide: Zoriel";$('lifePath').textContent="7";};
</script>
</body>
</html>