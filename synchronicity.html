<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Synchronicity Reader â€” Mystical Pro v3 (Long Segments)</title>
<style>
  :root{ --bg:#05090a; --card:#081215; --edge:#102227; --text:#d1f7ff; --mint:#7efcff; --muted:#9bc7d1; --ok:#a7ffd8; --err:#ff9b9b }
  *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1000px;margin:0 auto;padding:22px 16px 40px}
  h1{margin:0 0 6px;color:var(--mint)}
  .sub{margin:0 0 16px;color:var(--muted)}
  .card{background:var(--card);border:1px solid var(--edge);border-radius:14px;padding:16px;margin:14px 0}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
  .kpi{background:#0b1214;border:1px solid var(--edge);border-radius:10px;padding:12px}
  .kpi h3{margin:0 0 6px;color:var(--mint);font-size:15px}
  .kpi div{font-weight:700;font-size:20px;font-family:ui-monospace,Menlo,Consolas,monospace}
  label{font-weight:600;display:block;margin:.4rem 0 .2rem}
  input,button,select{font:inherit;border-radius:10px;border:1px solid var(--edge);background:#0b1214;color:#d1f7ff;padding:.55rem .7rem}
  button{cursor:pointer}
  .chip{display:inline-block;border:1px solid #1f3b41;border-radius:999px;padding:4px 8px;margin:4px 6px 0 0;color:#9bc7d1;font-size:12px}
  .long{white-space:pre-line;line-height:1.7}
  .tiny{font-size:12px} .muted{color:var(--muted)} .ok{color:var(--ok)} .err{color:var(--err)}
  .tts{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .disclaimer{font-size:12px;color:#9bc7d1;margin-top:6px}
  .pill{display:inline-block;padding:4px 10px;border:1px solid #1f3940;border-radius:999px;margin-right:8px;color:#8fd7e3;font-size:12px}
  h2,h3{margin:10px 0 6px}
</style>
</head>
<body>
  <div class="wrap">
    <h1>ðŸ”¢ Synchronicity Reader â€” Mystical Pro v3</h1>
    <p class="sub">Long, flowing segments (â‰ˆ200â€“300 words each), clean narration, Google voices only.</p>

    <section class="card">
      <div class="row">
        <label>Synchronicity number
          <input id="num" placeholder="e.g., 2011, 2222, 1234" style="min-width:220px">
        </label>
        <label>Tone
          <select id="tone">
            <option value="plain">Plainâ€‘English</option>
            <option value="light">Mystical â€” Light</option>
            <option value="rich" selected>Mystical â€” Rich</option>
          </select>
        </label>
        <button id="analyzeBtn">Analyze</button>
        <button id="copyBtn">Copy reading</button>
        <button id="copyHtmlBtn">Copy as HTML</button>
        <span id="status" class="tiny muted" style="margin-left:auto"></span>
      </div>
      <div class="tts" style="margin-top:8px">
        <span class="pill">Narrator</span>
        <label>Voice <select id="voiceSelect"></select></label>
        <label class="tiny"><input type="checkbox" id="forceEnglish" checked> English only</label>
        <label class="tiny">Rate <input type="range" id="rate" min="0.6" max="1.4" step="0.02" value="0.98"></label>
        <label class="tiny">Pitch <input type="range" id="pitch" min="0.6" max="1.4" step="0.02" value="1.0"></label>
        <button id="testVoiceBtn">Test</button>
        <button id="speakBtn">Speak</button>
        <button id="stopBtn">Stop</button>
      </div>
      <div class="disclaimer">Reflective guidance only. Narration uses a cleaned version of the text (no symbols or hashes).</div>
    </section>

    <section class="card" id="resultCard" style="display:none">
      <div class="grid">
        <div class="kpi"><h3>Segments (2â€‘digit)</h3><div id="segments">â€”</div></div>
        <div class="kpi"><h3>Segment Bases</h3><div id="bases">â€”</div></div>
        <div class="kpi"><h3>Final Base</h3><div id="finalBase">â€”</div></div>
      </div>

      <h3>Tarot & Astro Mapping</h3>
      <div id="chips"></div>

      <h3>Reading</h3>
      <div id="reading" class="long">â€”</div>
    </section>

    <section class="card tiny muted">
      Data: <code>synchronicity_mapping.json</code> + <code>synchronicity_overrides.json</code>. Only <strong>Google</strong> voices are listed. Speech removes symbols like arrows and bullets.
    </section>
  </div>

<script>
const MAP_URL = 'synchronicity_mapping.json?v='+Date.now();
const OV_URL  = 'synchronicity_overrides.json?v='+Date.now();

const $ = id => document.getElementById(id);
let DB = null, OV = null;

// ===== helpers =====
function splitPairsLeft(str){ const s=String(str).replace(/\\D/g,''); if(!s) return []; const out=[]; for(let i=0;i<s.length;i+=2) out.push(s.slice(i,i+2)); return out; }
function reduceDigit(n){ n=String(n).replace(/\\D/g,''); if(!n) return null; let sum=0; for(const ch of n) sum+=Number(ch); while(sum>9){ let t=0; for(const ch of String(sum)) t+=Number(ch); sum=t; } return sum; }
function segmentBase(seg){ if(OV[seg]) return { base: OV[seg].base, master: seg, ov:OV[seg] }; return { base: reduceDigit(seg), master:null, ov:null }; }
function unique(arr){ return Array.from(new Set(arr.filter(Boolean))); }
function mapDigitToEntry(d){ const db=(DB && (DB.numbers||DB))||{}; return db[String(d)] || {}; }
function minorsForBase(d){ const names={1:'Ace',2:'Two',3:'Three',4:'Four',5:'Five',6:'Six',7:'Seven',8:'Eight',9:'Nine'}; const label=names[d]; if(!label) return []; return [`${label} of Wands`,`${label} of Cups`,`${label} of Swords`,`${label} of Pentacles`]; }

// ===== anchor + categories (reusing v2 speech-friendly) =====
const ANCHOR = {
1:{title:"Clean Beginnings", theme:"initiative and clean starts", plain:"Today favours first steps you can explain in one sentence...", light:"A door you know well opens without creak...", rich:"The ember becomes a steady flame in your hands..." },
2:{title:"Living Balance", theme:"cooperation and soft power", plain:"Work with another rhythm, not against it...", light:"Two currents meet and make a calmer river...", rich:"Mist gathers where the streams braid..." },
3:{title:"True Expression", theme:"expression and creative links", plain:"Say the useful thing and keep it brief...", light:"The market is bright, but you choose three stalls only...", rich:"Bells open the day; you select colour, page, and tune..." },
4:{title:"Good Structure", theme:"structure and foundations", plain:"Make one system that reduces effort tomorrow...", light:"A simple workshop waits: four stones...", rich:"A room with high windows, tools in their homes..." },
5:{title:"Gentle Change", theme:"movement and flexibility", plain:"Try one safe experiment...", light:"A short wind shifts and you adjust your sail...", rich:"The caravan moves on light feet..." },
6:{title:"Caring Harmony", theme:"responsibility and healing", plain:"Offer help that does not exhaust you...", light:"The hearth warms, the garden listens...", rich:"Cinnamon rises; soil loosens..." },
7:{title:"Quiet Insight", theme:"study and spiritual focus", plain:"Reduce noise. Give one hour...", light:"Fog thins around a small window...", rich:"Cedar and ink; a hooded lamp..." },
8:{title:"Calm Strength", theme:"resources and sustained effort", plain:"Choose one routine you can keep...", light:"The forge hums at a low heat...", rich:"Coals as a small constellation..." },
9:{title:"Clean Completion", theme:"release and service", plain:"Finish one thing...", light:"Tide pulls light into itself...", rich:"A box once heavy becomes light..." }
};

const CAT = {
1:{love:"Name a desire warmly...", work:"Draft a oneâ€‘page charter...", confusion:"Reduce inputs to one clear question...", family:"Open the conversation kindly...", frustration:"Turn the feeling into motion..." },
2:{love:"Treat love like a duet...", work:"Write basic agreements...", confusion:"Balance the scale...", family:"Translate gently...", frustration:"Breathe in fours..." },
3:{love:"Offer a specific appreciation...", work:"Show a small example...", confusion:"Choose one channel for a day...", family:"Add lightness...", frustration:"Express, then choose..." },
4:{love:"Build the hearth...", work:"Choose one template...", confusion:"Name what decision...", family:"Create a simple routine...", frustration:"Tighten one bolt..." },
5:{love:"Invite a microâ€‘adventure...", work:"Pilot one change...", confusion:"Lower the wind...", family:"Suggest a kinder sequence...", frustration:"Move the body..." },
6:{love:"Ask what would help...", work:"Define what good looks like...", confusion:"Step back from overâ€‘empathy...", family:"Repair softly...", frustration:"Return one burden..." },
7:{love:"Share one page...", work:"Research one knot...", confusion:"Quiet first...", family:"Offer a better question...", frustration:"Find the one fact..." },
8:{love:"Keep one promise small...", work:"Track reps, not moods...", confusion:"Pick the lever...", family:"Add structure without steamrolling...", frustration:"Channel it through craft..." },
9:{love:"Release the old story...", work:"Finish, archive, or hand off...", confusion:"Treat this as an ending...", family:"Make a simple ritual of grace...", frustration:"Let the tide take..." }
};

// ===== LONG segment narrative generator (â‰ˆ200â€“300 words) =====
function longSegmentHTML(idx, rawSeg, base, majors, minors, signs, master, tone){
  const baseNames={1:'Ace',2:'Two',3:'Three',4:'Four',5:'Five',6:'Six',7:'Seven',8:'Eight',9:'Nine'};
  const baseName = baseNames[base]||String(base);

  const mtext = majors.length? `In the Majors, ${majors.join(', ')} set the frame.` : `In the Majors, the archetype of ${base} hums under the surface.`;
  const qtext = minors.length? `In the Minors, the ${baseName}s show as ${minors.join(', ')}.` : `In the Minors, the ${baseName}s describe the daily practice.`;
  const stext = signs.length? `Astrologically, ${signs.join(' and ')} colour this chapter.` : '';
  const masterNote = master? ` This arrives as Master ${master} stepping down to ${base}: big voltage choosing practical shoes.` : '';

  // Paragraph 1 â€” Orientation
  const p1_plain = `Segment ${idx} (${rawSeg} to ${base}) asks you to make meaning visible in small, repeatable ways. ${mtext} ${qtext} ${stext}${masterNote}`.trim();
  const p1_light = `Segment ${idx} (${rawSeg} to ${base}) opens like a steady door. ${mtext} ${qtext} ${stext}${masterNote}`.trim();
  const p1_rich  = `Segment ${idx} (${rawSeg} to ${base}) opens and the air changes tone. ${mtext} ${qtext} ${stext}${masterNote}`.trim();

  // Paragraph 2 â€” Practical triad
  const triad = [
    `protect one clear block where this work can breathe`,
    `send one message that aligns someone helpful`,
    `let one stale move or tool fall away`
  ].join('; ') + '.';

  const p2_plain = `Practically, treat this as a small altar to ${baseName} energy: ${triad} Keep the sequence gentle and repeatable.`;
  const p2_light = `Practically, keep a simple triad: ${triad} Repetition turns intention into ground.`;
  const p2_rich  = `In practice, shape a quiet triad: ${triad} As you repeat it, intention condenses into form.`;

  // Paragraph 3 â€” Short story image (lighter than v1; speechâ€‘friendly)
  const images = {
    1:`a key and a first light in a plain room`,
    2:`two lanterns keeping an easy pace on a narrow bridge`,
    3:`three chosen stalls in a bright market`,
    4:`a bench by a window and four patient stones`,
    5:`a small sail trimmed to the honest wind`,
    6:`a warm stove and a chair moved two inches to fit the doorway`,
    7:`a desk, a single window, and a quiet page that answers`,
    8:`a low forge and a rhythm your hands remember`,
    9:`the shore where you keep one shell and let the rest go`
  };
  const img = images[base] || `a simple scene that fits today`;
  const p3_plain = `Picture ${img}. You do less, but you do it on purpose. That is enough.`;
  const p3_light = `Picture ${img}. You do fewer things, more on purpose. That is enough.`;
  const p3_rich  = `Picture ${img}. Doing less, more on purpose, you watch the day take the right shape.`;

  const tonePick = (a,b,c)=> (tone==='plain'? a : tone==='light'? b : c);
  return `<p>${tonePick(p1_plain,p1_light,p1_rich)}</p>
          <p>${tonePick(p2_plain,p2_light,p2_rich)}</p>
          <p>${tonePick(p3_plain,p3_light,p3_rich)}</p>`;
}

// ===== chips =====
function buildChips(basesInfo, segs){
  const chipHtml = [];
  basesInfo.forEach(({base, master, ov}, idx) => {
    const entry = mapDigitToEntry(base);
    const majors = entry.majors || entry.Majors || [];
    const signs  = unique([...(entry.signs||entry.Signs||[]), ...(ov && ov.signs || [])]);
    const minors = minorsForBase(base);
    chipHtml.push(`<div class="chip">Seg ${idx+1}: ${segs[idx]} â†’ ${master? master+'â†’':''}${base} Â· ${signs.join('/')} Â· Majors: ${majors.join(', ')} Â· Minors: ${minors.join(', ')}</div>`);
  });
  return chipHtml.join('');
}

// ===== build full reading =====
function buildReadingHTML(num, segs, basesInfo, finalBase){
  const tone = $('tone').value;
  const anchor = ANCHOR[finalBase] || {title:'Anchor', theme:'', plain:'', light:'', rich:''};
  const story = (tone==='plain'? anchor.plain : tone==='light'? anchor.light : anchor.rich);

  const parts = [];
  parts.push(`<h2>${num} â€” ${anchor.title}</h2>`);
  parts.push(`<p>We split ${num} into ${segs.join(', ')}. Adding the bases resolves to ${finalBase}: ${anchor.theme}.</p>`);

  basesInfo.forEach((info, i)=>{
    const entry = mapDigitToEntry(info.base);
    const majors = entry.majors || entry.Majors || [];
    const signs  = unique([...(entry.signs||entry.Signs||[]), ...(info.ov && info.ov.signs || [])]);
    const minors = minorsForBase(info.base);
    parts.push(`<h3>Segment ${i+1} â€” ${info.master? 'Master '+info.master+' â†’ ':''}${info.base}</h3>`);
    parts.push(longSegmentHTML(i+1, segs[i], info.base, majors, minors, signs, info.master, tone));
  });

  parts.push(`<h3>Anchor â€” ${finalBase}</h3>`);
  parts.push(`<p>${story}</p>`);

  const cat = CAT[finalBase] || {};
  parts.push(`<h3>If the question is Love</h3><p>${cat.love||''}</p>`);
  parts.push(`<h3>If the question is Work/Vocation</h3><p>${cat.work||''}</p>`);
  parts.push(`<h3>If the question is Confusion</h3><p>${cat.confusion||''}</p>`);
  parts.push(`<h3>If the question is Family</h3><p>${cat.family||''}</p>`);
  parts.push(`<h3>If the question is Frustration</h3><p>${cat.frustration||''}</p>`);
  parts.push(`<p>â€” Spirit Guide App</p>`);

  return parts.join('\n');
}

// ===== UI actions =====
function analyze(){
  const raw = $('num').value.trim();
  if(!raw){ alert('Enter a number.'); return; }

  const segs = splitPairsLeft(raw);
  const basesInfo = segs.map(s => segmentBase(s));
  const bases = basesInfo.map(x => x.base);
  const finalBase = reduceDigit(bases.reduce((a,b)=>a+b,0));

  $('resultCard').style.display = 'block';
  $('segments').textContent = segs.join(', ');
  $('bases').textContent = basesInfo.map(x => (x.master? x.master+'â†’':'') + x.base).join(', ');
  $('finalBase').textContent = String(finalBase);
  $('chips').innerHTML = buildChips(basesInfo, segs);

  const html = buildReadingHTML(raw, segs, basesInfo, finalBase);
  $('reading').innerHTML = html;

  $('status').textContent = 'Done';
  setTimeout(()=> $('status').textContent='', 2000);
}

function copyReading(){ 
  const txt = getSpeechText(($('reading').innerHTML||'').trim());
  navigator.clipboard.writeText(txt + '\nâ€” Spirit Guide App').then(()=> alert('Copied reading (speechâ€‘friendly)'));
}
function copyReadingHtml(){
  const html = $('reading').innerHTML;
  const blob = new Blob([html], {type:'text/html'});
  const reader = new FileReader();
  reader.onload = function(){ navigator.clipboard.writeText(reader.result).then(()=> alert('Copied HTML')); };
  reader.readAsText(blob);
}
$('analyzeBtn').onclick = analyze;
$('copyBtn').onclick = copyReading;
$('copyHtmlBtn').onclick = copyReadingHtml;

// ===== Narrator (Googleâ€‘only) + speech sanitizer =====
const STORAGE = { name:'sg_voice_name', lang:'sg_voice_lang', force:'sg_voice_force_en', rate:'sg_voice_rate', pitch:'sg_voice_pitch' };
const prefer = ["Google UK English Female","Google UK English Male","Google US English","Google US English Female","Google US English Male"];
let voices = [];
function isGoogle(v){ return /google/i.test(v.name||''); }
function englishOnly(v){ return $('forceEnglish').checked ? /^en[-_]/i.test(v.lang||'') : true; }
function populateVoices(){
  const list = window.speechSynthesis.getVoices()||[];
  if(!list.length){ setTimeout(populateVoices, 250); return; }
  voices = list.filter(v => isGoogle(v) && englishOnly(v));
  const sel = $('voiceSelect'); sel.innerHTML='';
  voices.forEach(v=>{ const opt=document.createElement('option'); opt.value=v.name+'::'+v.lang; opt.textContent=`${v.name} (${v.lang})`; sel.appendChild(opt); });

  const savedName = localStorage.getItem(STORAGE.name), savedLang = localStorage.getItem(STORAGE.lang);
  if(savedName && savedLang){
    const idx = Array.from(sel.options).findIndex(o => o.value === (savedName+'::'+savedLang));
    if(idx>=0){ sel.selectedIndex=idx; } else { sel.selectedIndex=0; }
  } else {
    let picked=false;
    for(const p of prefer){
      const idx = Array.from(sel.options).findIndex(o => o.textContent.includes(p));
      if(idx>=0){ sel.selectedIndex=idx; picked=true; break; }
    }
    if(!picked && sel.options.length) sel.selectedIndex=0;
  }
}
function currentVoice(){
  const sel = $('voiceSelect'); if(!sel || sel.selectedIndex<0) return null;
  const [name, lang] = sel.value.split('::');
  return (window.speechSynthesis.getVoices()||[]).find(v => v.name===name && v.lang===lang) || null;
}
function savePrefs(){
  const sel = $('voiceSelect'); const [name, lang] = (sel.value||'::').split('::');
  localStorage.setItem(STORAGE.name, name||''); localStorage.setItem(STORAGE.lang, lang||'');
  localStorage.setItem(STORAGE.force, $('forceEnglish').checked ? '1':'0');
  localStorage.setItem(STORAGE.rate, String($('rate').value)); localStorage.setItem(STORAGE.pitch, String($('pitch').value));
}
function loadPrefs(){
  $('forceEnglish').checked = localStorage.getItem(STORAGE.force) === '1';
  const r = parseFloat(localStorage.getItem(STORAGE.rate)); if(!isNaN(r)) $('rate').value = r;
  const p = parseFloat(localStorage.getItem(STORAGE.pitch)); if(!isNaN(p)) $('pitch').value = p;
}
function decodeEntities(html){
  const txt = document.createElement('textarea'); txt.innerHTML = html; return txt.value;
}
function getSpeechText(html){
  let text = decodeEntities(html);
  text = text.replace(/<script[\s\S]*?<\/script>/gi,' ')
             .replace(/<style[\s\S]*?<\/style>/gi,' ')
             .replace(/<[^>]+>/g,' ');
  text = text.replace(/â†’/g,' to ').replace(/â€¢/g,', ').replace(/[#*_`~^]/g,' ').replace(/\s{2,}/g,' ').trim();
  return text;
}
function speak(textHtml){
  if(!('speechSynthesis' in window)) return alert('Speech not supported here.');
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance();
  const cleaned = getSpeechText(textHtml || $('reading').innerHTML || '');
  u.text = "Reflective guidance only. " + (cleaned || 'Please analyze a number first.');
  u.rate = parseFloat($('rate').value||'1'); u.pitch = parseFloat($('pitch').value||'1'); u.volume = 1.0;
  const v = currentVoice(); if(v) u.voice = v;
  window.speechSynthesis.speak(u);
}
$('testVoiceBtn').onclick = ()=>{ savePrefs(); speak('Hello'); };
$('speakBtn').onclick     = ()=> speak();
$('stopBtn').onclick      = ()=> window.speechSynthesis && window.speechSynthesis.cancel();
$('voiceSelect').onchange = savePrefs;
$('forceEnglish').onchange= ()=>{ savePrefs(); populateVoices(); };
$('rate').oninput = savePrefs; $('pitch').oninput = savePrefs;

if('speechSynthesis' in window){
  loadPrefs();
  window.speechSynthesis.onvoiceschanged = populateVoices;
  populateVoices();
} else {
  $('status').textContent = 'Speech not supported in this browser';
}

// Ready
Promise.all([fetch(MAP_URL).then(r=>r.json()).catch(()=>null),
             fetch(OV_URL).then(r=>r.json()).catch(()=>({}))])
  .then(([map, ov]) => {
    DB = map || {}; OV = ov || {};
    $('status').textContent = 'Ready';
    setTimeout(()=> $('status').textContent='', 1500);
  });
</script>
</body>
</html>
