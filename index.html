<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Spirit Guide App â€” Main (Endpoint Patched)</title>
<meta name="description" content="Numerology snapshot + 24h backstory + ambient.">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>
<style>
  :root{ --bg:#05090a; --card:#081215; --edge:#102227; --text:#d1f7ff; --mint:#7efcff; --muted:#9bc7d1; --ok:#a7ffd8; --err:#ff9b9b; }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1000px;margin:0 auto;padding:22px 16px 40px}
  h1{margin:0 0 6px;color:var(--mint)}
  .sub{margin:0 0 16px;color:var(--muted)}
  .card{background:var(--card);border:1px solid var(--edge);border-radius:14px;padding:16px;margin:14px 0;box-shadow:0 10px 30px rgba(0,0,0,.22)}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  label{font-weight:600;display:block;margin:.4rem 0 .2rem}
  input,select,button{font:inherit;border-radius:10px;border:1px solid var(--edge);background:#0b1214;color:var(--text);padding:.6rem .75rem}
  button{cursor:pointer}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(210px,1fr));gap:12px}
  .kpi{background:#0b1214;border:1px solid var(--edge);border-radius:10px;padding:12px}
  .kpi h3{margin:0 0 6px;color:var(--mint);font-size:15px}
  .kpi div{font-weight:700;font-size:20px;font-family:ui-monospace,Menlo,Consolas,monospace}
  .tiny{font-size:12px} .muted{color:var(--muted)}
  .badge{font-size:11px;color:#8abfcc;border:1px dashed #22444b;border-radius:8px;padding:3px 8px;display:inline-block;margin-left:8px;vertical-align:middle}
</style>
</head>
<body>
  <div class="wrap">
    <h1>ðŸ”® Spirit Guide App <span class="badge" title="Endpoint + cache-bust">EP-PNVsmsc v1</span></h1>
    <p class="sub">Classic dark/mint UI â€¢ Snapshot now â€¢ Backstory in 24 hours â€¢ Optional ambient.</p>

    <section class="card">
      <div class="row">
        <div style="flex:1 1 260px">
          <label for="name">Your Name</label>
          <input id="name" placeholder="e.g., Steven Abbott">
        </div>
        <div style="flex:1 1 220px">
          <label for="dob">Date of Birth</label>
          <input id="dob" type="date">
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div class="row">
          <button id="demoBtn">Demo</button>
          <button id="calcBtn">Calculate</button>
          <button id="resetBtn">Reset</button>
          <button id="copyBtn">Copy summary</button>
        </div>
        <div class="row" style="margin-left:auto">
          <select id="ambient">
            <option value="">Ambient: None</option>
            <option value="ambient/binaural.mp3">Ambient: binaural.mp3</option>
          </select>
          <label class="tiny muted" style="display:flex;align-items:center;gap:8px">
            Volume <input type="range" id="ambientVol" min="0" max="1" step="0.05" value="0.35" style="width:160px">
          </label>
          <button id="stopAudio">Stop</button>
        </div>
      </div>
    </section>

    <section class="card" id="resultsCard" style="display:none">
      <h2 id="guideName">Your Spirit Guide</h2>
      <div class="grid">
        <div class="kpi"><h3>Life Path</h3><div id="lifePath">â€”</div></div>
        <div class="kpi"><h3>Expression</h3><div id="expression">â€”</div></div>
        <div class="kpi"><h3>Soul Urge</h3><div id="soulUrge">â€”</div></div>
        <div class="kpi"><h3>Personality</h3><div id="personality">â€”</div></div>
        <div class="kpi"><h3>Birthday</h3><div id="birthday">â€”</div></div>
        <div class="kpi"><h3>Maturity</h3><div id="maturity">â€”</div></div>
        <div class="kpi"><h3>Karmic Debts</h3><div id="karmicDebts">â€”</div></div>
        <div class="kpi"><h3>Karmic Lessons</h3><div id="karmicLessons">â€”</div></div>
        <div class="kpi"><h3>Balance</h3><div id="balance">â€”</div></div>
      </div>
    </section>

    <section class="card" id="emailCard" style="display:none">
      <strong>ðŸ“© Weâ€™ll email your full backstory within 24 hours.</strong>
      <div class="row" style="margin-top:8px">
        <input id="email" type="email" placeholder="you@example.com" style="flex:1 1 280px">
        <label class="tiny"><input type="checkbox" id="consent"> I agree to be contacted about my result.</label>
        <button id="sendBtn">Send my result</button>
      </div>
      <div id="sendStatus" class="tiny muted"></div>
    </section>
  </div>

  <audio id="player" preload="none"></audio>
  <iframe name="sheetSink" style="display:none"></iframe>

<script>
const SHEETS_URL = "https://script.google.com/macros/s/AKfycbxg14tVEU3AJ210QQ0Ul3BfZAhOIQgz-MW5PNVsmsc/exec";
const STORAGE_KEY = "spirit-guide-main-patch";
const $ = (id)=>document.getElementById(id);

// Ambient
const p = $('player'); const volEl=$('ambientVol');
function applyVolume(){ p.volume = parseFloat(volEl.value||'0.35'); localStorage.setItem('sg-vol', p.volume); }
const savedVol = parseFloat(localStorage.getItem('sg-vol')); if(!isNaN(savedVol)) volEl.value = savedVol.toFixed(2);
volEl.oninput = applyVolume; applyVolume();
$('ambient').onchange = (e)=>{ const src=e.target.value; if(!src){p.pause();return;} p.src=src; p.loop=true; applyVolume(); p.play().catch(()=>alert("If blocked, click Calculate once then choose again.")); };
$('stopAudio').onclick = ()=>{ p.pause(); p.currentTime=0; };

// Numerology helpers
function onlyLetters(str){ return (str||'').toUpperCase().replace(/[^A-Z]/g,''); }
function sumDigits(n){ n = String(n).replace(/[^0-9]/g,''); return n.split('').reduce((a,b)=>a+Number(b),0); }
function reduceNum(n){ n = Number(n); while (![11,22,33].includes(n) && n>9){ n = sumDigits(n); } return n; }
function nameNumber(name, type){
  const map={A:1,B:2,C:3,D:4,E:5,F:6,G:7,H:8,I:9,J:1,K:2,L:3,M:4,N:5,O:6,P:7,Q:8,R:9,S:1,T:2,U:3,V:3,W:5,X:6,Y:7,Z:8};
  const vowels=new Set(['A','E','I','O','U','Y']);
  let cleaned=onlyLetters(name), val=0;
  for(const ch of cleaned){ const v=map[ch]||0;
    if(type==='vowels'&&vowels.has(ch)) val+=v; else if(type==='consonants'&&!vowels.has(ch)) val+=v; else if(type==='all') val+=v;
  } return reduceNum(val);
}
function dateToNumbers(dstr){ const d=new Date(dstr); if(isNaN(d)) return {lifePath:null,birthday:null}; const yyyy=d.getUTCFullYear(),mm=d.getUTCMonth()+1,dd=d.getUTCDate(); const lifePath=reduceNum(sumDigits(yyyy)+sumDigits(mm)+sumDigits(dd)); return {lifePath,birthday:reduceNum(dd)}; }
function deterministicGuide(name,dob){ const g=["Zoriel","Nymera","Elarion","Serapha","Kael","Aven","Lyra","Thalen","Mireth","Orin"]; const seed=(onlyLetters(name)+dob).split('').reduce((a,c)=>a+c.charCodeAt(0),0); return g[seed%g.length]; }

// Buttons
document.getElementById('demoBtn').onclick = ()=>{ $('name').value="Alex Example"; $('dob').value="1990-07-14"; };
document.getElementById('calcBtn').onclick = ()=>{
  const nm=$('name').value.trim(), d=$('dob').value;
  if(!nm||!d) return alert("Please enter your name and date of birth.");
  const dn = dateToNumbers(d);
  const res = {
    name:nm, dob:d, guide:deterministicGuide(nm,d),
    lifePath:dn.lifePath, expression:nameNumber(nm,'all'), soulUrge:nameNumber(nm,'vowels'),
    personality:nameNumber(nm,'consonants'), birthday:dn.birthday,
    maturity:reduceNum(dn.lifePath + nameNumber(nm,'all')),
    karmicDebts:"â€”", karmicLessons:"â€”",
    balance:reduceNum(nameNumber(nm[0]||'','all') + (new Date(d)).getUTCDate())
  };
  localStorage.setItem(STORAGE_KEY, JSON.stringify({results:res}));
  document.getElementById('resultsCard').style.display=document.getElementById('emailCard').style.display="block";
  $('guideName').textContent="Your Spirit Guide: "+res.guide;
  $('lifePath').textContent=res.lifePath; $('expression').textContent=res.expression; $('soulUrge').textContent=res.soulUrge;
  $('personality').textContent=res.personality; $('birthday').textContent=res.birthday; $('maturity').textContent=res.maturity;
  $('karmicDebts').textContent=res.karmicDebts; $('karmicLessons').textContent=res.karmicLessons; $('balance').textContent=res.balance;
};
document.getElementById('resetBtn').onclick = ()=>{ localStorage.removeItem(STORAGE_KEY); location.reload(); };
document.getElementById('copyBtn').onclick = ()=>{ const s=localStorage.getItem(STORAGE_KEY); if(!s) return alert("Nothing to copy yet."); navigator.clipboard.writeText(s).then(()=>alert("Copied.")); };

// *** SHEET SEND â€” hidden form via iframe (bypasses CORS) ***
document.getElementById('sendBtn').onclick = ()=>{
  const email = $('email').value.trim(); const consent = $('consent').checked;
  const statusEl = $('sendStatus');
  if(!email){ statusEl.textContent = "Enter an email."; statusEl.className="tiny err"; return; }
  if(!consent){ statusEl.textContent = "Please tick consent."; statusEl.className="tiny err"; return; }

  const saved = JSON.parse(localStorage.getItem(STORAGE_KEY)||"{}");
  const r = saved.results || {};

  const payload = {
    email, consent: consent ? "Yes":"No", timestamp: new Date().toISOString(),
    name: r.name || "", dob: r.dob || "",
    guide: r.guide ?? "", lifePath: r.lifePath ?? "", expression: r.expression ?? "", soulUrge: r.soulUrge ?? "",
    personality: r.personality ?? "", birthday: r.birthday ?? "", maturity: r.maturity ?? "",
    karmicDebts: r.karmicDebts ?? "", karmicLessons: r.karmicLessons ?? "", balance: r.balance ?? "",
    result_json: JSON.stringify(r||{})
  };

  const form = document.createElement('form');
  form.method = 'POST'; form.action = SHEETS_URL; form.target = 'sheetSink';
  for (const k in payload) { const inp=document.createElement('input'); inp.type='hidden'; inp.name=k; inp.value=String(payload[k]); form.appendChild(inp); }
  document.body.appendChild(form);
  try { form.submit(); statusEl.textContent="Sent âœ… â€” check your Google Sheet for a new row."; statusEl.className="tiny ok"; }
  catch(e) { statusEl.textContent="Could not send â€” form submit failed."; statusEl.className="tiny err"; }
  finally { setTimeout(()=>{ try{ document.body.removeChild(form); }catch(_ ){} }, 1500); }
};
</script>
</body>
</html>
