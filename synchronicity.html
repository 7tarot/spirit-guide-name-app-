<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Synchronicity Reader â€” Voice Lock</title>
<style>
  :root{ --bg:#05090a; --card:#081215; --edge:#102227; --text:#d1f7ff; --mint:#7efcff; --muted:#9bc7d1; --ok:#a7ffd8; --err:#ff9b9b }
  *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1000px;margin:0 auto;padding:22px 16px 40px}
  h1{margin:0 0 6px;color:var(--mint)}
  .sub{margin:0 0 16px;color:var(--muted)}
  .card{background:var(--card);border:1px solid var(--edge);border-radius:14px;padding:16px;margin:14px 0}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .long{white-space:pre-line;line-height:1.6}
  label{font-weight:600;display:block;margin:.4rem 0 .2rem}
  input,button,select{font:inherit;border-radius:10px;border:1px solid var(--edge);background:#0b1214;color:#d1f7ff;padding:.55rem .7rem}
  button{cursor:pointer}
  .tiny{font-size:12px} .muted{color:var(--muted)} .ok{color:var(--ok)} .err{{color:var(--err)}}
</style>
</head>
<body>
  <div class="wrap">
    <h1>ðŸ”¢ Synchronicity Reader â€” Voice Lock</h1>
    <p class="sub">Same narrator voice every time, across pages (saved as a site-wide preference).</p>

    <section class="card">
      <div class="row">
        <label>Number <input id="num" placeholder="e.g., 2222" style="min-width:220px"></label>
        <button id="analyzeBtn">Analyze</button>
        <button id="speakBtn">Speak</button>
        <button id="stopBtn">Stop</button>
        <span id="status" class="tiny muted" style="margin-left:auto"></span>
      </div>
      <div class="row">
        <label>Voice <select id="voiceSelect"></select></label>
        <label class="tiny"><input type="checkbox" id="forceEnglish"> Force English voices</label>
        <label class="tiny">Rate <input type="range" id="rate" min="0.6" max="1.4" step="0.02" value="0.98"></label>
        <label class="tiny">Pitch <input type="range" id="pitch" min="0.6" max="1.4" step="0.02" value="1.0"></label>
        <button id="testVoiceBtn">Test voice</button>
      </div>
      <div class="tiny muted">Your selection is saved as a site preference and reused automatically.</div>
    </section>

    <section class="card" id="out" style="display:none">
      <div id="reading" class="long">â€”</div>
    </section>
  </div>

<script>
const STORAGE = {
  name:  'sg_voice_name',
  lang:  'sg_voice_lang',
  force: 'sg_voice_force_en',
  rate:  'sg_voice_rate',
  pitch: 'sg_voice_pitch'
};

const preferNames = [
  // Natural, high-quality English voices commonly present
  "Microsoft Sonia Online (Natural)", "Microsoft Aria Online (Natural)",
  "Microsoft Ryan Online (Natural)", "Microsoft Guy Online (Natural)",
  "Google UK English Female", "Google UK English Male",
  "Google US English", "Google US English Female", "Google US English Male"
];

const $ = id => document.getElementById(id);
let voices = [];

// --- dummy reader text (kept minimal; your full page supplies the narrative) ---
function analyze(){
  const raw = $('num').value.trim() || '2222';
  $('out').style.display = 'block';
  $('reading').textContent = "This is a placeholder reading for " + raw + ". The real page will generate ~400 words.";
}

function savePrefs(){
  const sel = $('voiceSelect');
  const opt = sel.options[sel.selectedIndex];
  const [name, lang] = (opt && opt.value ? opt.value.split('::') : ['','']);
  localStorage.setItem(STORAGE.name, name||'');
  localStorage.setItem(STORAGE.lang, lang||'');
  localStorage.setItem(STORAGE.force, $('forceEnglish').checked ? '1' : '0');
  localStorage.setItem(STORAGE.rate, String($('rate').value));
  localStorage.setItem(STORAGE.pitch, String($('pitch').value));
}

function loadPrefs(){
  const force = localStorage.getItem(STORAGE.force);
  $('forceEnglish').checked = force === '1';
  const r = parseFloat(localStorage.getItem(STORAGE.rate)); if (!isNaN(r)) $('rate').value = r;
  const p = parseFloat(localStorage.getItem(STORAGE.pitch)); if (!isNaN(p)) $('pitch').value = p;
}

function englishFiltered(list){
  return list.filter(v => $('forceEnglish').checked ? /^en[-_]/i.test(v.lang) : true);
}

function populateVoices(){
  const list = window.speechSynthesis.getVoices() || [];
  if (!list.length){ setTimeout(populateVoices, 250); return; }
  voices = list.slice().sort((a,b)=> (a.lang||'').localeCompare(b.lang||''));

  const sel = $('voiceSelect');
  sel.innerHTML = '';
  const avail = englishFiltered(voices);

  avail.forEach(v => {
    const opt = document.createElement('option');
    opt.value = v.name + '::' + v.lang;
    opt.textContent = `${v.name} (${v.lang})`;
    sel.appendChild(opt);
  });

  // 1) Try saved voice
  const savedName = localStorage.getItem(STORAGE.name);
  const savedLang = localStorage.getItem(STORAGE.lang);
  if (savedName && savedLang){
    const idx = Array.from(sel.options).findIndex(o => o.value === (savedName + '::' + savedLang));
    if (idx >= 0){ sel.selectedIndex = idx; $('status').textContent = 'Using saved voice'; setTimeout(()=>$('status').textContent='', 2000); return; }
  }

  // 2) Try preferred list
  for (const p of preferNames){
    const idx = Array.from(sel.options).findIndex(o => o.textContent.includes(p));
    if (idx >= 0){ sel.selectedIndex = idx; $('status').textContent = 'Selected preferred voice'; setTimeout(()=>$('status').textContent='', 2000); return; }
  }

  // 3) Default to first
  if (sel.options.length) sel.selectedIndex = 0;
}

function currentVoice(){
  const sel = $('voiceSelect');
  if (!sel || sel.selectedIndex < 0) return null;
  const [name, lang] = sel.value.split('::');
  return voices.find(v => v.name === name && v.lang === lang) || null;
}

function speak(text){
  if (!('speechSynthesis' in window)) { alert('Speech not supported in this browser.'); return; }
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance();
  u.text = "Reflective guidance only. " + (text || "Please analyze a number first.");
  u.rate = parseFloat($('rate').value||'1'); u.pitch = parseFloat($('pitch').value||'1'); u.volume = 1.0;
  const v = currentVoice(); if (v) u.voice = v;
  window.speechSynthesis.speak(u);
}

$('analyzeBtn').onclick = analyze;
$('speakBtn').onclick  = ()=> speak(($('reading').textContent||'').trim());
$('stopBtn').onclick   = ()=> window.speechSynthesis && window.speechSynthesis.cancel();
$('testVoiceBtn').onclick = ()=> { savePrefs(); speak("This is your saved narrator voice. It will be reused next time."); };

$('voiceSelect').onchange = savePrefs;
$('forceEnglish').onchange = ()=>{ savePrefs(); populateVoices(); };
$('rate').oninput = savePrefs;
$('pitch').oninput = savePrefs;

if ('speechSynthesis' in window){
  loadPrefs();
  window.speechSynthesis.onvoiceschanged = populateVoices;
  populateVoices();
} else {
  $('status').textContent = 'Speech not supported in this browser';
}
</script>
</body>
</html>
