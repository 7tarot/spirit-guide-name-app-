<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Synchronicity Reader ‚Äî Mystical Pro v4.3.8 FOCUS VARIANTS</title>
<style>
  :root{ --bg:#05090a; --card:#081215; --edge:#102227; --text:#d1f7ff; --mint:#7efcff; --muted:#9bc7d1; --ok:#a7ffd8; --err:#ff9b9b }
  *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1000px;margin:0 auto;padding:22px 16px 40px}
  h1{margin:0 0 6px;color:var(--mint)}
  .sub{margin:0 0 16px;color:var(--muted)}
  .card{background:var(--card);border:1px solid var(--edge);border-radius:14px;padding:16px;margin:14px 0}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
  .kpi{background:#0b1214;border:1px solid var(--edge);border-radius:10px;padding:12px}
  .kpi h3{margin:0 0 6px;color:var(--mint);font-size:15px}
  .kpi div{font-weight:700;font-size:20px;font-family:ui-monospace,Menlo,Consolas,monospace}
  label{font-weight:600;display:block;margin:.4rem 0 .2rem}
  input,button,select{font:inherit;border-radius:10px;border:1px solid var(--edge);background:#0b1214;color:#d1f7ff;padding:.55rem .7rem}
  button{cursor:pointer}
  .chip{display:inline-block;border:1px solid #1f3b41;border-radius:999px;padding:4px 8px;margin:4px 6px 0 0;color:#9bc7d1;font-size:12px}
  .long{white-space:pre-line;line-height:1.8}
  .tiny{font-size:12px} .muted{color:var(--muted)} .ok{color:var(--ok)} .err{color:var(--err)}
  .tts{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .disclaimer{font-size:12px;color:#9bc7d1;margin-top:6px}
  .pill{display:inline-block;padding:4px 10px;border:1px solid #1f3940;border-radius:999px;margin-right:8px;color:#8fd7e3;font-size:12px}
  h2,h3{margin:10px 0 6px}
  .badge{display:inline-block;margin-left:8px;padding:2px 8px;border:1px dashed #204b54;border-radius:999px;color:#8fd7e3;font-size:12px}
  .diag{margin-top:8px;font-size:12px;color:#9bc7d1}
  .diag b{color:#a7ffd8}
  details summary{cursor:pointer;color:#9bd5e3}
</style>
</head>
<body>
  <div class="wrap">
    <h1>üî¢ Synchronicity Reader ‚Äî Mystical Pro <span class="badge">v4.3.8 FOCUS VARIANTS</span></h1>
    <p class="sub">FIXED: final base uses classic digit-sum of whole number. Categories adapt by base + pattern (masters, repeater, mirror, ladder, zeros). Single-file, dedupe on, narrator on.</p>

    <section class="card">
      <div class="row">
        <label>Synchronicity number
          <input id="num" placeholder="e.g., 2011, 2222, 1234" style="min-width:220px">
        </label>
        <label>Tone
          <select id="tone">
            <option value="plain">Plain‚ÄëEnglish (Long)</option>
            <option value="light">Mystical ‚Äî Light (Long)</option>
            <option value="rich" selected>Mystical ‚Äî Rich (Long)</option>
          </select>
        </label>
        <button id="analyzeBtn">Analyze</button>
        <button id="copyBtn">Copy reading</button>
        <button id="copyHtmlBtn">Copy as HTML</button>
        <span id="status" class="tiny muted" style="margin-left:auto"></span>
      </div>
      <div class="tts" style="margin-top:8px">
        <span class="pill">Narrator</span>
        <label>Voice <select id="voiceSelect"></select></label>
        <label class="tiny"><input type="checkbox" id="forceEnglish" checked> English only</label>
        <label class="tiny">Rate <input type="range" id="rate" min="0.6" max="1.4" step="0.02" value="0.98"></label>
        <label class="tiny">Pitch <input type="range" id="pitch" min="0.6" max="1.4" step="0.02" value="1.0"></label>
        <button id="testVoiceBtn">Test Voice</button>
        <button id="speakBtn">Speak (categories)</button>
        <button id="stopBtn">Stop</button>
      </div>
      <div class="disclaimer">Narration reads the category guidance only. Reflective guidance; not a directive.</div>
      <div id="diag" class="diag">Diagnostics: <b>loading‚Ä¶</b></div>
    </section>

    <section class="card" id="resultCard" style="display:none">
      <div id="overview" class="long muted tiny">‚Äî</div>

      <div class="grid" style="margin-top:10px">
        <div class="kpi"><h3>Segments</h3><div id="segments">‚Äî</div></div>
        <div class="kpi"><h3>Bases</h3><div id="bases">‚Äî</div></div>
        <div class="kpi"><h3>Final Base</h3><div id="finalBase">‚Äî</div></div>
      </div>

      <details style="margin-top:10px">
        <summary>Show pattern & chips</summary>
        <div id="chips" style="margin-top:8px"></div>
        <div id="pattern" class="tiny muted" style="margin-top:6px"></div>
      </details>

      <h3 style="margin-top:14px">Reading</h3>
      <div id="reading" class="long">‚Äî</div>
    </section>
  </div>

<script>
const VERSION = 'v4.3.8-focus-variants-classic';
const $ = id => document.getElementById(id);

// ===== mapping =====
const DB = {}; // for future expansion
const OV = { "11":{base:2, signs:["Libra"]}, "22":{base:4, signs:["Scorpio","Aries"]}, "33":{base:6, signs:["Capricorn","Gemini"]} };

// ===== helpers =====
function splitPairsLeft(str){ const s=String(str).replace(/\\D/g,''); if(!s) return []; const out=[]; for(let i=0;i<s.length;i+=2) out.push(s.slice(i,i+2)); return out; }
function reduceDigit(n){ n=String(n).replace(/\\D/g,''); if(!n) return null; let sum=0; for(const ch of n) sum+=Number(ch); while(sum>9){ let t=0; for(const ch of String(sum)) t+=Number(ch); sum=t; } return sum; }
function segmentBase(seg){ if(OV[seg]) return { base: OV[seg].base, master: seg, ov:OV[seg] }; return { base: reduceDigit(seg), master:null, ov:null }; }
function unique(arr){ return Array.from(new Set(arr.filter(Boolean))); }
function mapDigitToEntry(d){ const db=(DB && (DB.numbers||DB))||{}; return db[String(d)] || {}; }
function minorsForBase(d){ const names={1:'Ace',2:'Two',3:'Three',4:'Four',5:'Five',6:'Six',7:'Seven',8:'Eight',9:'Nine'}; const label=names[d]; if(!label) return []; return [`${label} of Wands`,`${label} of Cups`,`${label} of Swords`,`${label} of Pentacles`]; }

// ===== features =====
function computeFeatures(segs){
  const info = segs.map(s=>({seg:s, ...segmentBase(s), n:parseInt(s,10)}));
  const counts = {}; const order=[]; const infoMap={};
  info.forEach(o=>{ if(!counts[o.seg]){ counts[o.seg]=1; order.push(o.seg); infoMap[o.seg]=o; } else { counts[o.seg]++; } });
  const has11 = info.some(o=>o.master==='11');
  const has22 = info.some(o=>o.master==='22');
  const has33 = info.some(o=>o.master==='33');
  const nums = info.map(o=>o.n);
  let asc=true, desc=true;
  for(let i=1;i<nums.length;i++){ if(!(nums[i]>nums[i-1])) asc=false; if(!(nums[i]<nums[i-1])) desc=false; }
  const repeater = new Set(segs).size===1;
  const palindrome = segs.join('') === segs.slice().reverse().join('');
  const hasZero = segs.some(s=>/0/.test(s));
  return {order, counts, infoMap, has11, has22, has33, asc, desc, repeater, palindrome, hasZero};
}
function describePattern(f){
  const tags=[];
  if(f.repeater) tags.push('repeater');
  if(f.palindrome) tags.push('mirror');
  if(f.asc) tags.push('ladder up');
  if(f.desc) tags.push('ladder down');
  if(f.hasZero) tags.push('zeros');
  if(f.has11) tags.push('M11');
  if(f.has22) tags.push('M22');
  if(f.has33) tags.push('M33');
  return tags.join(' ¬∑ ') || 'mixed';
}

// ===== categories with variants =====
function catLongVariant(finalBase, topic, f){
  const tone = {
    1:{verb:'begin', gift:'clarity', caution:'impulse', anchor:'first steps', image:'a key and a simple room'},
    2:{verb:'balance', gift:'cooperation', caution:'people‚Äëpleasing', anchor:'agreements', image:'two lanterns on a bridge'},
    3:{verb:'express', gift:'communication', caution:'scatter', anchor:'one channel', image:'three bright stalls'},
    4:{verb:'structure', gift:'stability', caution:'rigidity', anchor:'frames and routines', image:'a bench and four patient stones'},
    5:{verb:'change', gift:'flexibility', caution:'restlessness', anchor:'safe experiments', image:'a small steady sail'},
    6:{verb:'care', gift:'healing', caution:'over‚Äëresponsibility', anchor:'kind boundaries', image:'a warm stove and a moved chair'},
    7:{verb:'reflect', gift:'insight', caution:'over‚Äëanalysis', anchor:'quiet focus', image:'a desk and a single window'},
    8:{verb:'sustain', gift:'power', caution:'overcontrol', anchor:'steady practice', image:'coals in a quiet forge'},
    9:{verb:'complete', gift:'release', caution:'lingering', anchor:'clean endings', image:'a tide line and one kept shell'}
  }[finalBase] || {verb:'move', gift:'balance', caution:'overreach', anchor:'simple steps', image:'a calm path'};

  function baseLove(){ return [
    `Under Base ${finalBase}, love asks you to ${tone.verb}. The gift here is ${tone.gift}; the shadow is ${tone.caution}. Begin repair by regulating, not proving. If there‚Äôs an argument, assume your nervous systems are in courtroom mode‚Äîeach mind collecting evidence to win. Winning is lonely; repair is warm. Call a respectful pause of twenty to forty minutes. No sulking, no disappearing‚Äîjust name the pause and take it. Move your body, drink water, lower the physiological noise. When you return, lead with impact and care rather than accusation: ‚ÄúWhen X happened, I felt Y, because I was trying to protect Z.‚Äù`,
    `Keep to one topic. If old cases rush in, park them on paper and look for an unmet need (safety, closeness, clarity, respect). Use the three‚Äëstep rhythm: reflect, ask, suggest. Boundaries become bridges when they are small, kind, and enforceable. Offer time options that honor capacity.`,
    `Build a seven‚Äëday micro‚Äëritual‚Äîphones down tea, evening walk, two‚Äëminute gratitude, a one‚Äëcard pull for ‚Äúwhat would help us today.‚Äù Praise the keeping of rhythm. Hold the picture: ${tone.image}. If you slip, repair quickly: name the slip, restate the value, and take the next right step.`
  ]; }
  function baseWork(){ return [
    `Work under Base ${finalBase} asks you to ${tone.verb} where it matters and stop where it doesn‚Äôt. Trade heroics for ${tone.anchor}. Map your pipeline in four stages: capture, shape, deliver, review. Define ‚Äúdone‚Äù so a stranger would agree. Block ninety minutes and move the smallest unit that moves the whole.`,
    `Replace status meetings with one‚Äëpage dashboards. Send weekly ‚Äúshipped / next / risks.‚Äù When priorities compete, choose the action that buys the most learning or removes the biggest blocker. Template repeats, prune dead steps, and ask for the problem statement + success measure when requests arrive fuzzy.`,
    `Lead by example. Use service‚Äëframed boundaries. Track reps, not moods. Name three completions at day‚Äôs end; teach your nervous system that it can trust your rhythm.`
  ]; }
  function baseConfusion(){ return [
    `Confusion is resolved by ${tone.gift}. Shrink the question to one honest line. Close extra inputs. Choose one channel today: page, memo, or sketch. If you pull cards, try the triad: what I control, the tone to keep, the obvious action.`,
    `Run a fifty‚Äëminute focus and touch only the leverage point. Draft the dumb version first; smart arrives once a shape exists. Test futures with compassionate realism: which path keeps you consistent and kind on a tired day? Choose that.`,
    `Finish with a body check‚Äîshoulders down, jaw soft, longer exhale. Let result, not feeling, guide the next move. Picture ${tone.image}.`
  ]; }
  function baseFamily(){ return [
    `Family steadies when the frame is visible. Post plan where everyone can see it: schedule, chores, budget, quiet hours. In a hot moment, ask for a pause and return with the shared goal‚Äîsafety, fairness, a team home. Translate instead of accuse.`,
    `Offer two sustainable options and let the group pick. Rituals do heavy lifting: weekly check‚Äëin of one gratitude, one ask, one small promise. When a line is crossed repeatedly, set a boundary you can keep without drama; boundaries protect possibility.`,
    `Create five‚Äëminute islands of connection per relationship. If you caretake, state capacity before resentment speaks. End with a reset ritual; picture ${tone.image}.`
  ]; }
  function baseFrustration(){ return [
    `Frustration is bottled motion. Move first, then speak. Choose the smallest visible action that moves the situation an inch. Under Base ${finalBase}, ${tone.anchor} are medicine‚Äîfix the hinge, send the paragraph, tidy the square foot, log the rep.`,
    `Speak in impact and request. If they can‚Äôt or won‚Äôt, adjust your boundary rather than your worth. Shorten lists, tighten loops, and use a timer. Credit yourself for keeping the box, not for dramatic outcomes.`,
    `Close the day by naming what moved. Your nervous system remembers completions; feed it evidence. Picture ${tone.image}.`
  ]; }

  const base = {love:baseLove(), work:baseWork(), confusion:baseConfusion(), family:baseFamily(), frustration:baseFrustration()}[topic] || [];

  const variants = [];
  if (f.has11) variants.push(`With Master 11 present, practice justice in the relationship: equal airtime, clear agreements, and the bravery to say ‚ÄúI don‚Äôt know yet.‚Äù Treat decisions as drafts you refine together.`);
  if (f.has22) variants.push(`Master 22 brings builder energy. Keep promises small and measurable‚Äîshared list, time‚Äëboxed repair, weekly date. Prune whatever steals focus. Stability is a frame kind enough to hold growth.`);
  if (f.has33) variants.push(`Master 33 leans toward service. Offer skill without martyrdom. Teach shorter and kinder than usual. Consider what helps the wider circle without draining you.`);
  if (f.repeater) variants.push(`Repeater pattern: treat the lesson as intensified. Do one round well instead of three dramatic rounds. Cadence beats performance.`);
  if (f.palindrome) variants.push(`Mirror pattern: align inner and outer. Close the loop‚Äîsay the thing, show the change, and ask if it helped.`);
  if (f.asc) variants.push(`Ladder up: build momentum in keepable increments. Each step should survive a tired day; if not, shrink it.`);
  if (f.desc) variants.push(`Ladder down: simplify. Archive the old version, return to first principles, finish a clean ending before adding anything new.`);
  if (f.hasZero) variants.push(`Zeros mark sacred pauses. Add a breath before replies, a buffer day before big changes, and whitespace so care isn‚Äôt crushed by urgency.`);

  const all = base.concat(variants);
  let html = all.map(p=>`<p>${p}</p>`).join('\\n');
  const wc = html.replace(/<[^>]+>/g,' ').split(/\\s+/).filter(Boolean).length;
  if (wc < 400){ html += `<p>Keep it simple and repeatable. You are teaching your world to trust your rhythm‚Äîthis is how numbers become lived guidance.</p>`; }
  return html;
}

// ===== overview =====
function buildOverview(num, segs, f, finalBaseClassic, finalBasePair){
  const grouped = f.order.map(seg => {
    const info = f.infoMap[seg];
    const times = f.counts[seg]>1 ? `√ó${f.counts[seg]}` : '';
    const arrow = info.master ? info.master+'‚Üí' : '';
    return `${seg}${times} (${arrow}${info.base})`;
  }).join(', ');
  const title = {1:"Clean Beginnings",2:"Living Balance",3:"True Expression",4:"Good Structure",5:"Gentle Change",6:"Caring Harmony",7:"Quiet Insight",8:"Calm Strength",9:"Clean Completion"}[finalBaseClassic] || "Anchor";
  const pattern = describePattern(f);
  const masters = [f.has11?'11':null, f.has22?'22':null, f.has33?'33':null].filter(Boolean).join(', ') || '‚Äî';
  return `We split ${num} into ${grouped}. Final base (classic): <strong>${finalBaseClassic}</strong> ‚Äî ‚Äú${title}‚Äù. <span class="tiny">(pair method: ${finalBasePair})</span>. Pattern: <em>${pattern}</em>. Masters: <em>${masters}</em>.`;
}

// ===== UI =====
function analyze(){
  const raw = $('num').value.trim();
  if(!raw){ alert('Enter a number.'); return; }

  const digitsOnly = String(raw).replace(/\\D/g,'');
  if(!digitsOnly){ alert('Enter at least one digit.'); return; }

  const segs = splitPairsLeft(digitsOnly);
  if (!segs.length){ alert('Need at least two digits.'); return; }

  const f = computeFeatures(segs);

  // final base ‚Äî classic (digits of whole number) and pair (prior method) for visibility
  const finalBaseClassic = reduceDigit(digitsOnly);
  const basesPairAll = segs.map(s => segmentBase(s).base);
  const finalBasePair = reduceDigit(basesPairAll.reduce((a,b)=>a+b,0));

  $('resultCard').style.display = 'block';
  $('overview').innerHTML = buildOverview(raw, segs, f, finalBaseClassic, finalBasePair);
  $('segments').textContent = segs.join(', ');

  const basesGrouped = f.order.map(seg => {
    const info = f.infoMap[seg];
    const arrow = info.master ? info.master+'‚Üí' : '';
    const times = f.counts[seg] > 1 ? ` √ó${f.counts[seg]}` : '';
    return `${seg} ‚Üí ${arrow}${info.base}${times}`;
  });
  $('bases').textContent = basesGrouped.join(', ');
  $('finalBase').textContent = String(finalBaseClassic);
  $('chips').innerHTML = buildChipsGrouped(f.order, f.counts, f.infoMap);
  $('pattern').textContent = 'Pattern tags: ' + describePattern(f);

  const html = catLongVariant(finalBaseClassic, 'love', f)
             + '<h3>If the question is Work/Vocation</h3>' + catLongVariant(finalBaseClassic, 'work', f)
             + '<h3>If the question is Confusion</h3>' + catLongVariant(finalBaseClassic, 'confusion', f)
             + '<h3>If the question is Family</h3>' + catLongVariant(finalBaseClassic, 'family', f)
             + '<h3>If the question is Frustration</h3>' + catLongVariant(finalBaseClassic, 'frustration', f)
             + '<p>‚Äî Spirit Guide App</p>';
  $('reading').innerHTML = html;

  $('status').textContent = 'Done';
  diag('Done');
  setTimeout(()=> $('status').textContent='', 2000);
}

function copyReading(){ 
  const txt = getSpeechText(($('reading').innerHTML||'').trim());
  navigator.clipboard.writeText(txt + '\\n‚Äî Spirit Guide App').then(()=> alert('Copied reading (speech‚Äëfriendly)'));
}
function copyReadingHtml(){
  const html = $('reading').innerHTML;
  const blob = new Blob([html], {type:'text/html'});
  const reader = new FileReader();
  reader.onload = function(){ navigator.clipboard.writeText(reader.result).then(()=> alert('Copied HTML')); };
  reader.readAsText(blob);
}
$('analyzeBtn').onclick = analyze;
$('copyBtn').onclick = copyReading;
$('copyHtmlBtn').onclick = copyReadingHtml;

// ===== Narrator =====
const STORAGE = { name:'sg_voice_name', lang:'sg_voice_lang', force:'sg_voice_force_en', rate:'sg_voice_rate', pitch:'sg_voice_pitch' };
const prefer = ["Google UK English Female","Google UK English Male","Google US English","Google US English Female","Google US English Male"];
let voices = [];
let speakQueue = [];
let speaking = false;

function isGoogle(v){ return /google/i.test(v.name||''); }
function englishOnly(v){ return $('forceEnglish').checked ? /^en[-_]/i.test(v.lang||'') : true; }

function waitForVoices(){
  return new Promise(resolve => {
    const list = window.speechSynthesis.getVoices();
    if (list && list.length){ resolve(list); return; }
    window.speechSynthesis.onvoiceschanged = () => resolve(window.speechSynthesis.getVoices());
    setTimeout(()=> resolve(window.speechSynthesis.getVoices()||[]), 800);
  });
}

async function populateVoices(){
  const list = await waitForVoices();
  voices = (list||[]).filter(v => isGoogle(v) && englishOnly(v));
  const sel = $('voiceSelect'); sel.innerHTML='';
  voices.forEach(v=>{ const opt=document.createElement('option'); opt.value=v.name+'::'+v.lang; opt.textContent=`${v.name} (${v.lang})`; sel.appendChild(opt); });

  const savedName = localStorage.getItem(STORAGE.name), savedLang = localStorage.getItem(STORAGE.lang);
  if(savedName && savedLang){
    const idx = Array.from(sel.options).findIndex(o => o.value === (savedName+'::'+savedLang));
    if(idx>=0){ sel.selectedIndex=idx; } else { sel.selectedIndex=0; }
  } else {
    let picked=false;
    for(const p of prefer){
      const idx = Array.from(sel.options).findIndex(o => o.textContent.includes(p));
      if(idx>=0){ sel.selectedIndex=idx; picked=true; break; }
    }
    if(!picked && sel.options.length) sel.selectedIndex=0;
  }
  diag(`Voices ready: ${voices.length}`);
}

function currentVoice(){
  const sel = $('voiceSelect'); if(!sel || sel.selectedIndex<0) return null;
  const [name, lang] = sel.value.split('::');
  return (window.speechSynthesis.getVoices()||[]).find(v => v.name===name && v.lang===lang) || null;
}
function savePrefs(){
  const sel = $('voiceSelect'); const [name, lang] = (sel.value||'::').split('::');
  localStorage.setItem(STORAGE.name, name||''); localStorage.setItem(STORAGE.lang, lang||'');
  localStorage.setItem(STORAGE.force, $('forceEnglish').checked ? '1':'0');
  localStorage.setItem(STORAGE.rate, String($('rate').value)); localStorage.setItem(STORAGE.pitch, String($('pitch').value));
}
function loadPrefs(){
  $('forceEnglish').checked = localStorage.getItem(STORAGE.force) === '1';
  const r = parseFloat(localStorage.getItem(STORAGE.rate)); if(!isNaN(r)) $('rate').value = r;
  const p = parseFloat(localStorage.getItem(STORAGE.pitch)); if(!isNaN(p)) $('pitch').value = p;
}
function decodeEntities(html){
  const txt = document.createElement('textarea'); txt.innerHTML = html; return txt.value;
}
function getSpeechText(html){
  let text = decodeEntities(html);
  const STRIP_SCRIPT = new RegExp('<'+'script[\\s\\S]*?<\\/'+'script>','gi');
  const STRIP_STYLE  = new RegExp('<'+'style[\\s\\S]*?<\\/'+'style>','gi');
  text = text.replace(STRIP_SCRIPT,' ').replace(STRIP_STYLE,' ').replace(/<[^>]+>/g,' ');
  text = text.replace(/‚Üí/g,' to ').replace(/‚Ä¢/g,', ').replace(/[#*_`~^]/g,' ').replace(/\s{2,}/g,' ').trim();
  return text;
}
function chunkText(text, maxLen=220){
  const sentences = text.split(/(?<=[\.\!\?])\s+)/);
  const chunks = [];
  let buf = '';
  sentences.forEach(s=>{
    if ((buf + ' ' + s).trim().length > maxLen){
      if (buf) chunks.push(buf.trim());
      if (s.length > maxLen){
        for (let i=0;i<s.length;i+=maxLen){ chunks.push(s.slice(i,i+maxLen)); }
        buf = '';
      } else {
        buf = s;
      }
    } else {
      buf = (buf? buf+' ' : '') + s;
    }
  });
  if (buf) chunks.push(buf.trim());
  return chunks;
}
async function speakQueueStart(text){
  if(!('speechSynthesis' in window)) return alert('Speech not supported here.');
  window.speechSynthesis.cancel();
  speakQueue = []; speaking = false;
  const cleaned = getSpeechText(text||$('reading').innerHTML||'');
  if(!cleaned){ alert('Nothing to read yet. Tap Analyze first.'); return; }
  speakQueue = chunkText("Reflective guidance only. " + cleaned, 220);

  const v = currentVoice();
  const rate = parseFloat($('rate').value||'1'); const pitch = parseFloat($('pitch').value||'1');

  await new Promise(r => setTimeout(r, 160));
  function next(){
    if (!speakQueue.length){
      speaking=false; $('status').textContent='Narration finished'; diag('Narration finished');
      setTimeout(()=> $('status').textContent='',1500);
      return;
    }
    const u = new SpeechSynthesisUtterance(speakQueue.shift());
    if (v) u.voice = v; u.rate = rate; u.pitch = pitch; u.volume = 1.0;
    u.onstart = ()=> { $('status').textContent='Speaking‚Ä¶'; diag('Speaking'); };
    u.onend = ()=> next();
    u.onerror = ()=> next();
    speaking = true;
    try { window.speechSynthesis.speak(u); }
    catch(e){ setTimeout(()=> window.speechSynthesis.speak(u), 120); }
  }
  next();
}
function stopSpeaking(){ window.speechSynthesis && window.speechSynthesis.cancel(); speakQueue=[]; speaking=false; $('status').textContent='Stopped'; diag('Stopped'); setTimeout(()=>$('status').textContent='',1200); }

$('testVoiceBtn').onclick = async ()=>{
  savePrefs(); window.speechSynthesis.cancel();
  await new Promise(r=>setTimeout(r,120));
  const u=new SpeechSynthesisUtterance('This is your saved Google narrator voice. The final base now uses the classic digit sum of the whole number.');
  const v=currentVoice(); if(v) u.voice=v; u.rate=parseFloat($('rate').value||'1'); u.pitch=parseFloat($('pitch').value||'1');
  window.speechSynthesis.speak(u); diag('Test voice played');
};
$('speakBtn').onclick     = ()=> speakQueueStart();
$('stopBtn').onclick      = ()=> stopSpeaking();
$('voiceSelect').onchange = savePrefs;
$('forceEnglish').onchange= ()=>{ savePrefs(); populateVoices(); };
$('rate').oninput = savePrefs; $('pitch').oninput = savePrefs;

// diagnostics
function diag(msg){
  const nav = navigator.userAgent||'';
  const vv = (window.speechSynthesis && window.speechSynthesis.getVoices && window.speechSynthesis.getVoices().length) || 0;
  $('diag').innerHTML = `Diagnostics: <b>${msg}</b> ¬∑ Voices: ${vv} ¬∑ Browser: ${nav.split(')')[0]+')'}`;
}

if('speechSynthesis' in window){
  populateVoices().then(()=>{ loadPrefs(); diag('Ready ('+VERSION+')'); });
} else {
  $('status').textContent = 'Speech not supported in this browser';
  diag('Speech API not supported');
}
</script>
</body>
</html>
