<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Synchronicity Reader — Mystical Pro</title>
<style>
  :root{ --bg:#05090a; --card:#081215; --edge:#102227; --text:#d1f7ff; --mint:#7efcff; --muted:#9bc7d1; --ok:#a7ffd8; --err:#ff9b9b }
  *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1000px;margin:0 auto;padding:22px 16px 40px}
  h1{margin:0 0 6px;color:var(--mint)}
  .sub{margin:0 0 16px;color:var(--muted)}
  .card{background:var(--card);border:1px solid var(--edge);border-radius:14px;padding:16px;margin:14px 0}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
  .kpi{background:#0b1214;border:1px solid var(--edge);border-radius:10px;padding:12px}
  .kpi h3{margin:0 0 6px;color:var(--mint);font-size:15px}
  .kpi div{font-weight:700;font-size:20px;font-family:ui-monospace,Menlo,Consolas,monospace}
  label{font-weight:600;display:block;margin:.4rem 0 .2rem}
  input,button,select{font:inherit;border-radius:10px;border:1px solid var(--edge);background:#0b1214;color:#d1f7ff;padding:.55rem .7rem}
  button{cursor:pointer}
  .chip{display:inline-block;border:1px solid #1f3b41;border-radius:999px;padding:4px 8px;margin:4px 6px 0 0;color:#9bc7d1;font-size:12px}
  .long{white-space:pre-line;line-height:1.7}
  .tiny{font-size:12px} .muted{color:var(--muted)} .ok{color:var(--ok)} .err{color:var(--err)}
  .tts{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .disclaimer{font-size:12px;color:#9bc7d1;margin-top:6px}
  .pill{display:inline-block;padding:4px 10px;border:1px solid #1f3940;border-radius:999px;margin-right:8px;color:#8fd7e3;font-size:12px}
  .section{margin-top:12px}
</style>
</head>
<body>
  <div class="wrap">
    <h1>🔢 Synchronicity Reader — Mystical Pro</h1>
    <p class="sub">Enter the number you keep seeing. This page generates a flowing, mystical reading with all Majors & Minor quartets.</p>

    <section class="card">
      <div class="row">
        <label>Synchronicity number
          <input id="num" placeholder="e.g., 2011, 2222, 1234" style="min-width:220px">
        </label>
        <button id="analyzeBtn">Analyze</button>
        <button id="copyBtn">Copy reading</button>
        <button id="copyHtmlBtn">Copy as HTML</button>
        <span id="status" class="tiny muted" style="margin-left:auto"></span>
      </div>
      <div class="tts" style="margin-top:8px">
        <span class="pill">Narrator</span>
        <label>Voice <select id="voiceSelect"></select></label>
        <label class="tiny"><input type="checkbox" id="forceEnglish" checked> English only</label>
        <label class="tiny">Rate <input type="range" id="rate" min="0.6" max="1.4" step="0.02" value="0.98"></label>
        <label class="tiny">Pitch <input type="range" id="pitch" min="0.6" max="1.4" step="0.02" value="1.0"></label>
        <button id="testVoiceBtn">Test</button>
        <button id="speakBtn">Speak</button>
        <button id="stopBtn">Stop</button>
      </div>
      <div class="disclaimer">Reflective guidance only. Trust your own intuition and judgment.</div>
    </section>

    <section class="card" id="resultCard" style="display:none">
      <div class="grid">
        <div class="kpi"><h3>Segments (2‑digit)</h3><div id="segments">—</div></div>
        <div class="kpi"><h3>Segment Bases</h3><div id="bases">—</div></div>
        <div class="kpi"><h3>Final Base</h3><div id="finalBase">—</div></div>
      </div>

      <div class="section">
        <h3>Tarot & Astro Mapping</h3>
        <div id="chips"></div>
      </div>

      <div class="section">
        <h3>Reading</h3>
        <div id="reading" class="long">—</div>
      </div>
    </section>

    <section class="card tiny muted">
      Data: <code>synchronicity_mapping.json</code> (your mapping) + <code>synchronicity_overrides.json</code> (11/22/33). Only <strong>Google</strong> voices are shown.
    </section>
  </div>

<script>
const MAP_URL = 'synchronicity_mapping.json?v='+Date.now();
const OV_URL  = 'synchronicity_overrides.json?v='+Date.now();

const $ = id => document.getElementById(id);
let DB = null, OV = null;

// ---- math + helpers ----
function splitPairsLeft(str){ const s=String(str).replace(/\\D/g,''); if(!s) return []; const out=[]; for(let i=0;i<s.length;i+=2) out.push(s.slice(i,i+2)); return out; }
function reduceDigit(n){ n=String(n).replace(/\\D/g,''); if(!n) return null; let sum=0; for(const ch of n) sum+=Number(ch); while(sum>9){ let t=0; for(const ch of String(sum)) t+=Number(ch); sum=t; } return sum; }
function segmentBase(seg){ if(OV[seg]) return { base: OV[seg].base, master: seg, ov:OV[seg] }; return { base: reduceDigit(seg), master:null, ov:null }; }
function unique(arr){ return Array.from(new Set(arr.filter(Boolean))); }
function mapDigitToEntry(d){ const db=(DB && (DB.numbers||DB))||{}; return db[String(d)] || {}; }
function minorsForBase(d){ const names={1:'Ace',2:'Two',3:'Three',4:'Four',5:'Five',6:'Six',7:'Seven',8:'Eight',9:'Nine'}; const label=names[d]; if(!label) return []; return [`${label} of Wands`,`${label} of Cups`,`${label} of Swords`,`${label} of Pentacles`]; }

// ---- anchor templates (1..9). Each has theme + story ----
const ANCHOR = {
1:{title:"The Ember and the Door",
theme:"initiative, independence, clean starts",
story:`Night holds its breath as you find a low red ember in a clay bowl. You cup your hands and it becomes a small, steady flame. Ahead is a wooden door with a brass key that has always fit your palm. You don’t need to know what lives in the next room; you need only to turn the key and carry your own light inside. The room is simple—blank table, blank page, a single chair—and the quiet is a dare. One act spoken aloud becomes a hinge: a sentence written, a message sent, a first draft allowed to be a first draft. You are not auditioning for permission; you are declaring a beginning. The world adjusts around decisive presence. When fear asks for a prophecy, answer with a step. When doubt hisses that the door is heavy, smile and move your shoulder. The hinge will never be lighter than now. The ember loves oxygen; your courage is the draft that feeds it. Cross the threshold. Let the small light be enough to find the next switch.`},
2:{title:"The Bridge of Two Streams",
theme:"cooperation, balance, soft power",
story:`Mist gathers where two clear streams meet. You place one foot on a rope bridge and feel the give of woven fibers—someone made this with patient hands. Halfway across, the water below braids itself into silver helixes, and you understand: the crossing is not a test; it is a teaching. Balance is not frozen stillness—it is a living conversation between supports. Across the river, a second figure appears carrying a lantern that mirrors yours. You nod without words and step in rhythm until you arrive together. On the far bank, the path is narrow but kind. You tie your lantern to theirs; twin lights make a softer shadow. You choose agreements over assumptions, boundaries over bravado, listening over noise. The bridge remains, ready for return, but today you have crossed. Cooperation is not the absence of power; it is its gentlest and most persuasive form.`},
3:{title:"The Market of Echoes",
theme:"expression, creativity, social links",
story:`Morning bells ring and the market unfurls its bright ribbons. Stalls arrive like ideas—too many at once, each calling your name. You breathe and choose three: the spice seller with jars of heat, the paper merchant with sheets that hold ink like skin, the musician tuning a string that matches your ribs. As you speak to one, the others lean closer; your voice gathers what it needs as it travels. A child repeats your last sentence and you hear its edge—sharp; you sand it with a smile and try again. By noon you have traded for a small satchel of color and a promise to return with a song. Expression is not a performance; it is the clean exchange of breath for meaning. Say it simpler. Say it kinder. Say it true. The echo you tend will be the one that answers you at dusk.`},
4:{title:"The Workshop of Stones",
theme:"structure, discipline, foundations",
story:`A low door opens to a workshop lit by high windows. Benches wear the polish of years; tools rest where a careful hand last placed them. On the floor, four stones wait at the compass points. You lift one and feel its honest weight—a promise disguised as a burden. A chalk line divides the room into the part you will use and the part you will bless. The first cut is measured, not heroic. The second is cleaner. By the third, the blade sings quiet. You keep a ledger of what repeats and a basket for what does not. When a cracked brick wobbles, you do not curse the wall; you shave the edge until it fits its neighbors. Structure is a kindness to future you. Discipline is devotion dressed in work clothes. Before you leave, you hang the plan on a nail where morning light can find it. The stones sleep in their square, already a room in embryo.`},
5:{title:"The Caravan and the Wind",
theme:"change, movement, flexibility",
story:`Sand hums under a wide sky as a caravan leans into the day. The wind is a clever teacher—it shifts without apology and expects you to do the same. You travel by signs: a line of darker dunes, a bird that circles a hidden spring, a story told by a stranger that fixes your compass. At the resting place, tents rise in minutes; by moonrise they are gone without a scar. Your pack grows lighter as you trade ornament for water, certainty for curiosity. Sometimes the quickest way is a soft diagonal. Sometimes you let the wind have its say and then answer with your route. Movement is not chaos when the heart carries its north. Adjust your scarf, check your laces, and take the next ten steps. The horizon honors the traveler who honors the weather.`},
6:{title:"The Hearth and the Garden",
theme:"responsibility, care, harmonizing",
story:`A house breathes when someone listens to it. You light the stove and the room exhales cinnamon. Outside, the garden asks for the kind of attention that counts as prayer: dead leaves lifted, soil loosened, water poured where roots can drink without drowning. Inside, a chair is moved two inches and suddenly the doorway feels honest. Care is a geometry of kindness—angles that make passage easy, circles that make gathering safe. You mend what will hold and release what will not. A list appears but you keep it merciful. At dusk, a few lamps turn the walls to honey. The garden sleeps with a wet smile. You understand: your gift is not martyrdom; it is stewardship. Love is heavier than praise and lighter than fear. Tonight, rest where your hands have made space for peace.`},
7:{title:"The Hermitage Lantern",
theme:"inner work, analysis, spiritual focus",
story:`Fog wraps the ridge as you climb toward a small hermitage. Inside, the air smells of cedar and ink. A narrow desk faces a single pane of glass; beyond it, the valley writes its patient letters in river script. You open a book and feel a click, as if a key turned in the soft part of your skull. The lantern on the table is hooded; you lift the hood and the room admits its dimensions. Solitude is not exile when the silence is populated with symbols. You study one pattern until it reveals its second face, then its third. The mind that hounds you becomes the dog that guards the door. When you descend, pockets hold three sentences you trust and one question worth keeping. You will speak less and mean more.`},
8:{title:"The Forge of Quiet Strength",
theme:"power, resources, sustained effort",
story:`The forge is awake before dawn. Coals glow like a low constellation; the hammer sleeps exactly where you left it. You heat the iron and it blushes toward orange, willing as a heartbeat. The first strike is not the loudest; it is the truest. You lift and place, lift and place, and soon the rhythm outlives the thought that doubted it. At the cooling trough, steam writes a shy scripture you do not chase. Strength here is nothing to do with swagger; it is the courtesy of repetition. You measure progress in things that last—hinges that do not squeal, gates that swing without complaint, promises that arrive on time. When you leave, you do not feel heroic. You feel clean. The anvil keeps its counsel. Tomorrow it will be ready for you again.`},
9:{title:"The Shore of Letting Go",
theme:"completion, release, service",
story:`The tide pulls long threads of light across the sand and hands them back to the sea. You carry a small box that once felt necessary and now feels like a story told in the wrong season. At the waterline you open it, bless what was true, and let the rest go out where salt remakes everything. Grief and relief are siblings—they argue, then share a coat. You walk the length of the shore until your footprints decide to keep their secrets. In your pocket, you keep one shell, not for proof but for music. Far down the beach a lantern swings: someone else finding their own release. You wave without needing to be seen. Service begins where ownership ends. The ocean writes your name and erases it tenderly. You are not diminished. You are made spacious.`},
};

// ---- category paragraphs per base (love, work, confusion, family, frustration) ----
const CAT = {
1:{love:"Set the first ritual: a weekly tea, a walk, a single honest question. Name a desire warmly; invite a clear yes/no. Let the Ace energy be a doorway, not a demand. If single, make the first move that feels like you.", 
   work:"Draft a one-page charter. Define the first milestone in terms a stranger would understand. Ship a tiny version today.", 
   confusion:"Reduce inputs to one true question. Pull three cards: Magician (what I can wield), Fool (where to trust), Sun (what wants to be obvious). Act on their overlap.", 
   family:"Begin the conversation others circle. Be kind and concrete. A new tradition can start with a humble first step.", 
   frustration:"Transmute it into motion. Write the shortest email that moves the block one notch. If you can’t move it, move yourself one notch around it."},
2:{love:"Treat love like a duet. Create shared cadence: check‑ins, soft boundaries, a place for truth to land. Choose harmony over heat today.", 
   work:"Write agreements. Who does what by when, and how will you decide when unsure? Collaboration becomes effortless when choices have rails.", 
   confusion:"Balance the scale. List pros/cons, then ask one trusted mirror what they heard underneath your words.", 
   family:"Mediate with gentleness. Translate instead of taking sides. A small shared plan calms the room.", 
   frustration:"Pause, breathe four counts in/out. Ask: what’s mine, what’s theirs, what belongs to time? Act only on the first."},
3:{love:"Say the beautiful thing out loud. Appreciation is a spell; keep it specific. If conflict, write before you speak; then read it aloud and soften once.", 
   work:"Show the demo. Invite feedback from one wise witness. Creativity multiplies when witnessed.", 
   confusion:"Your ideas are noisy. Choose one channel for 24 hours—writing, voice note, or sketch—and let the others rest.", 
   family:"Lighten the air. A shared game, a song, or a story can rethread frayed edges.", 
   frustration:"Express, don’t explode. Move the energy through words, then choose the smallest next publishable act."},
4:{love:"Build the hearth. Weekly date in the calendar, a budget that feels kind, a shared checklist for “we’re okay.”", 
   work:"Systems over heroics. Template the task you repeat; prune a step. Let consistency earn you trust.", 
   confusion:"Frame it. What decision is this *really* about? Give yourself one clear criterion and move.", 
   family:"Stability heals. Create a simple routine everyone can keep. Praise the keeping, not the perfection.", 
   frustration:"Tighten one bolt you control. Then rest. Repeat tomorrow. Boring is holy right now."},
5:{love:"Invite a micro‑adventure that’s safe for the nervous system. New route, new recipe, new question. Laugh often; promise little.", 
   work:"Pilot the change. One test, one metric, one week. Curiosity is your project manager.", 
   confusion:"Too much wind. Reduce sails: fewer voices, fewer tabs, more breath. Then make a tiny move.", 
   family:"Shift the pattern kindly. Suggest a different sequence to the usual dance; reward any ease that follows.", 
   frustration:"Move the body. Walk, shake, breathe. Decide after you’ve changed states."},
6:{love:"Care without carrying. Ask what would help and believe the answer. Make home more home today.", 
   work:"Tend quality. Define what “done well” means and teach it by example. Your steadiness is medicine.", 
   confusion:"Over‑empathy fogs the map. Step back, center, then choose the helpful deed that doesn’t drain you.", 
   family:"Repair softly. One apology, one boundary, one small celebration.", 
   frustration:"Notice where you’re over‑responsible. Return one marble to the universe."},
7:{love:"Share one page of your inner world and stop there. Mystery is magnetism when it’s not avoidance.", 
   work:"Research one knot and untie just that. Depth beats breadth today.", 
   confusion:"Quiet first. Pull Hermit, High Priestess, Star. Ask for the thin silver thread and follow it only a yard.", 
   family:"Offer wisdom, not control. Ask a better question and let silence answer.", 
   frustration:"Your mind made a maze. Find the one true fact that collapses it."},
8:{love:"Lead with warm consistency. Keep one promise small and strong. Power is safety when it’s kind.", 
   work:"Bench time. Track reps, not moods. Send one concise update with numbers.", 
   confusion:"Pick the lever with the most return and pull gently and repeatedly.", 
   family:"Provide structure without steamrolling. Generosity plus boundaries equals peace.", 
   frustration:"Channel it through craft. Ten quiet minutes of focused making will change the weather."},
9:{love:"Release the old story with respect. Serve where you can and let the rest drift. Closure is an act of love.", 
   work:"Finish something. Archive, hand off, or ship. Then bless the space you made.", 
   confusion:"You’re at an ending disguised as a choice. Choose the clean goodbye.", 
   family:"Make a ritual of grace. Memory is honored; guilt is not required.", 
   frustration:"Let the tide take what it’s already pulling. Save your strength for what returns."},
};

function segmentNarrative(idx, rawSeg, base, majors, minors, signs, master){
  const nameMap={1:'Ace',2:'Two',3:'Three',4:'Four',5:'Five',6:'Six',7:'Seven',8:'Eight',9:'Nine'};
  const baseName = nameMap[base]||String(base);
  const mtext = majors.length? `In the Majors, ${majors.join(', ')} set the tone` : `In the Majors, the archetype of ${base} hums quietly`;
  const qtext = minors.length? `In the Minors, the ${baseName}s appear as ${minors.join(', ')}` : `In the Minors, the ${baseName}s hold the daily practice`;
  const stext = signs.length? `Astrologically, ${signs.join(' & ')} colour this segment.` : '';
  const masterNote = master? ` This arrives as Master ${master} stepping down to ${base}, a reminder that big energy prefers practical shoes.` : '';
  const para1 = `Segment ${idx} (${rawSeg} → ${master? master+'→':''}${base}) is a pocket of guidance asking for embodiment. ${mtext}; ${qtext}. ${stext}${masterNote}`;
  const para2 = `Practically, treat this as a small altar to ${baseName} energy: set one boundary that protects the work, choose one message worth sending, and let one old habit fall away. The goal isn’t drama; it’s devotion with a calm pulse. If you listen closely, this segment offers a repeating note—keep it steady and the whole song will tune itself around it.`;
  return para1 + "\\n\\n" + para2;
}

function buildReading(num, segs, basesInfo, finalBase){
  const lines = [];
  const segText = segs.join(', ');
  const anchorBlock = ANCHOR[finalBase] || {title:"Anchor", theme:"", story:""};

  // Opening
  lines.push(`# ${num} — ${anchorBlock.title}`);
  lines.push(`We split **${num}** into **${segText}**. Adding the bases resolves to **${finalBase}** — a day keyed to *${anchorBlock.theme}*.`);

  // per-segment deep (200–300 words each)
  basesInfo.forEach((info, i) => {
    const entry = mapDigitToEntry(info.base);
    const majors = entry.majors || entry.Majors || [];
    const signs  = unique([...(entry.signs||entry.Signs||[]), ...(info.ov && info.ov.signs || [])]);
    const minors = minorsForBase(info.base);
    lines.push(`\n## Segment ${i+1} — ${info.master? 'Master '+info.master+' → ':''}${info.base}`);
    lines.push(segmentNarrative(i+1, segs[i], info.base, majors, minors, signs, info.master));
  });

  // Anchor core
  lines.push(`\n## Anchor — ${finalBase}`);
  lines.push(anchorBlock.story);

  // Categories
  const cat = CAT[finalBase] || {};
  lines.push(`\n## If the question is **Love**\n${cat.love||''}`);
  lines.push(`\n## If the question is **Work/Vocation**\n${cat.work||''}`);
  lines.push(`\n## If the question is **Confusion**\n${cat.confusion||''}`);
  lines.push(`\n## If the question is **Family**\n${cat.family||''}`);
  lines.push(`\n## If the question is **Frustration**\n${cat.frustration||''}`);

  // Close
  lines.push(`\n**Mantra:** “${anchorBlock.theme.charAt(0).toUpperCase()+anchorBlock.theme.slice(1)} becomes my path as I keep the next promise.”`);
  lines.push(`\n— Spirit Guide App`);

  return lines.join("\\n");
}

function buildChips(basesInfo, segs){
  const chipHtml = [];
  basesInfo.forEach(({base, master, ov}, idx) => {
    const entry = mapDigitToEntry(base);
    const majors = entry.majors || entry.Majors || [];
    const signs  = unique([...(entry.signs||entry.Signs||[]), ...(ov && ov.signs || [])]);
    const minors = minorsForBase(base);
    chipHtml.push(`<div class="chip">Seg ${idx+1}: ${segs[idx]} → ${master? master+'→':''}${base} · ${signs.join('/')} · Majors: ${majors.join(', ')} · Minors: ${minors.join(', ')}</div>`);
  });
  return chipHtml.join('');
}

// ---- UI actions ----
function analyze(){
  const raw = $('num').value.trim();
  if(!raw){ alert('Enter a number.'); return; }

  const segs = splitPairsLeft(raw);
  const basesInfo = segs.map(s => segmentBase(s));
  const bases = basesInfo.map(x => x.base);
  const finalBase = reduceDigit(bases.reduce((a,b)=>a+b,0));

  // Render summary and chips
  $('resultCard').style.display = 'block';
  $('segments').textContent = segs.join(', ');
  $('bases').textContent = basesInfo.map(x => (x.master? x.master+'→':'') + x.base).join(', ');
  $('finalBase').textContent = String(finalBase);
  $('chips').innerHTML = buildChips(basesInfo, segs);

  // Build deep mystical reading and render as HTML
  const md = buildReading(raw, segs, basesInfo, finalBase);
  $('reading').innerHTML = md
    .replace(/\\*\\*(.*?)\\*\\*/g,'<strong>$1</strong>')
    .replace(/^# (.*)$/gm,'<h2>$1</h2>')
    .replace(/^## (.*)$/gm,'<h3>$1</h3>')
    .replace(/\\n/g,'<br>');

  $('status').textContent = 'Done';
  setTimeout(()=> $('status').textContent='', 2000);
}

function copyReading(){ 
  const txt = ($('reading').innerText||'').trim();
  navigator.clipboard.writeText(txt + '\\n— Spirit Guide App').then(()=> alert('Copied reading'));
}
function copyReadingHtml(){
  const html = $('reading').innerHTML;
  const blob = new Blob([html], {type:'text/html'});
  const reader = new FileReader();
  reader.onload = function(){ navigator.clipboard.writeText(reader.result).then(()=> alert('Copied HTML')); };
  reader.readAsText(blob);
}

$('analyzeBtn').onclick = analyze;
$('copyBtn').onclick = copyReading;
$('copyHtmlBtn').onclick = copyReadingHtml;

// ---- Narrator: Google voices only + saved prefs ----
const STORAGE = { name:'sg_voice_name', lang:'sg_voice_lang', force:'sg_voice_force_en', rate:'sg_voice_rate', pitch:'sg_voice_pitch' };
const prefer = ["Google UK English Female","Google UK English Male","Google US English","Google US English Female","Google US English Male"];
let voices = [];
function isGoogle(v){ return /google/i.test(v.name||''); }
function englishOnly(v){ return $('forceEnglish').checked ? /^en[-_]/i.test(v.lang||'') : true; }
function populateVoices(){
  const list = window.speechSynthesis.getVoices()||[];
  if(!list.length){ setTimeout(populateVoices, 250); return; }
  voices = list.filter(v => isGoogle(v) && englishOnly(v));
  const sel = $('voiceSelect'); sel.innerHTML='';
  voices.forEach(v=>{ const opt=document.createElement('option'); opt.value=v.name+'::'+v.lang; opt.textContent=`${v.name} (${v.lang})`; sel.appendChild(opt); });

  const savedName = localStorage.getItem(STORAGE.name), savedLang = localStorage.getItem(STORAGE.lang);
  if(savedName && savedLang){
    const idx = Array.from(sel.options).findIndex(o => o.value === (savedName+'::'+savedLang));
    if(idx>=0){ sel.selectedIndex=idx; } else { sel.selectedIndex=0; }
  } else {
    let picked=false;
    for(const p of prefer){
      const idx = Array.from(sel.options).findIndex(o => o.textContent.includes(p));
      if(idx>=0){ sel.selectedIndex=idx; picked=true; break; }
    }
    if(!picked && sel.options.length) sel.selectedIndex=0;
  }
}
function currentVoice(){
  const sel = $('voiceSelect'); if(!sel || sel.selectedIndex<0) return null;
  const [name, lang] = sel.value.split('::');
  return (window.speechSynthesis.getVoices()||[]).find(v => v.name===name && v.lang===lang) || null;
}
function savePrefs(){
  const sel = $('voiceSelect'); const [name, lang] = (sel.value||'::').split('::');
  localStorage.setItem(STORAGE.name, name||''); localStorage.setItem(STORAGE.lang, lang||'');
  localStorage.setItem(STORAGE.force, $('forceEnglish').checked ? '1':'0');
  localStorage.setItem(STORAGE.rate, String($('rate').value)); localStorage.setItem(STORAGE.pitch, String($('pitch').value));
}
function loadPrefs(){
  $('forceEnglish').checked = localStorage.getItem(STORAGE.force) === '1';
  const r = parseFloat(localStorage.getItem(STORAGE.rate)); if(!isNaN(r)) $('rate').value = r;
  const p = parseFloat(localStorage.getItem(STORAGE.pitch)); if(!isNaN(p)) $('pitch').value = p;
}
function speak(text){
  if(!('speechSynthesis' in window)) return alert('Speech not supported here.');
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance();
  u.text = "Reflective guidance only. " + (text || $('reading').innerText || 'Please analyze a number first.');
  u.rate = parseFloat($('rate').value||'1'); u.pitch = parseFloat($('pitch').value||'1'); u.volume = 1.0;
  const v = currentVoice(); if(v) u.voice = v;
  window.speechSynthesis.speak(u);
}
$('testVoiceBtn').onclick = ()=>{ savePrefs(); speak("This is your saved Google narrator voice."); };
$('speakBtn').onclick     = ()=> speak();
$('stopBtn').onclick      = ()=> window.speechSynthesis && window.speechSynthesis.cancel();
$('voiceSelect').onchange = savePrefs;
$('forceEnglish').onchange= ()=>{ savePrefs(); populateVoices(); };
$('rate').oninput = savePrefs; $('pitch').oninput = savePrefs;

if('speechSynthesis' in window){
  loadPrefs();
  window.speechSynthesis.onvoiceschanged = populateVoices;
  populateVoices();
} else {
  $('status').textContent = 'Speech not supported in this browser';
}

// Ready fetch
Promise.all([fetch(MAP_URL).then(r=>r.json()).catch(()=>null),
             fetch(OV_URL).then(r=>r.json()).catch(()=>({}))])
  .then(([map, ov]) => {
    DB = map || {}; OV = ov || {};
    $('status').textContent = 'Ready';
    setTimeout(()=> $('status').textContent='', 1500);
  });
</script>
</body>
</html>
