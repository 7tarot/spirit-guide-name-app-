<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Synchronicity Reader â€” v4.5.1b (UK voices)</title>
<style>
  :root{ --bg:#05090a; --card:#081215; --edge:#102227; --text:#d1f7ff; --mint:#7efcff; --muted:#9bc7d1; --ok:#a7ffd8; --err:#ff9b9b }
  *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1000px;margin:0 auto;padding:22px 16px 40px}
  h1{margin:0 0 6px;color:var(--mint)}
  .sub{margin:0 0 16px;color:var(--muted)}
  .card{background:var(--card);border:1px solid var(--edge);border-radius:14px;padding:16px;margin:14px 0}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
  .kpi{background:#0b1214;border:1px solid var(--edge);border-radius:10px;padding:12px}
  .kpi h3{margin:0 0 6px;color:var(--mint);font-size:15px}
  .kpi div{font-weight:700;font-size:20px;font-family:ui-monospace,Menlo,Consolas,monospace}
  label{font-weight:600;display:block;margin:.4rem 0 .2rem}
  input,button,select{font:inherit;border-radius:10px;border:1px solid var(--edge);background:#0b1214;color:#d1f7ff;padding:.55rem .7rem}
  button{cursor:pointer}
  .chip{display:inline-block;border:1px solid #1f3b41;border-radius:999px;padding:4px 8px;margin:4px 6px 0 0;color:#9bc7d1;font-size:12px}
  .long{white-space:normal;line-height:1.85}
  .tiny{font-size:12px} .muted{color:var(--muted)} .ok{color:var(--ok)} .err{color:var(--err)}
  .tts{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .disclaimer{font-size:12px;color:#9bc7d1;margin-top:6px}
  .pill{display:inline-block;padding:4px 10px;border:1px solid #1f3940;border-radius:999px;margin-right:8px;color:#8fd7e3;font-size:12px}
  h2,h3{margin:10px 0 6px}
  .badge{display:inline-block;margin-left:8px;padding:2px 8px;border:1px dashed #204b54;border-radius:999px;color:#8fd7e3;font-size:12px}
  .diag{margin-top:8px;font-size:12px;color:#9bc7d1}
  .diag b{color:#a7ffd8}
  .errbar{background:#2a0e10;border:1px solid #5a1a1e;color:#ffb3b3;padding:8px;border-radius:10px;margin:10px 0;display:none}
  .pill2{display:inline-block;border:1px solid #27474f;padding:2px 8px;border-radius:999px;font-size:12px;color:#99d7e2;margin-left:8px}
  p{margin:0 0 12px 0}
</style>
</head>
<body>
  <div class="wrap">
    <h1>ðŸ”¢ Synchronicity Reader <span class="badge">v4.5.1b UK voices</span></h1>
    <p class="sub">Deterministic variation per number. Clean TTS. UK Google voices preferred (fallback to best English).</p>

    <div id="errbar" class="errbar"></div>

    <section class="card">
      <div class="row">
        <label>Synchronicity number
          <input id="num" placeholder="e.g., 2011, 2222, 1234" style="min-width:220px">
        </label>
        <label>Tone
          <select id="tone">
            <option value="plain">Plainâ€‘English (Long)</option>
            <option value="light">Mystical â€” Light (Long)</option>
            <option value="rich" selected>Mystical â€” Rich (Long)</option>
          </select>
        </label>
        <button id="analyzeBtn">Analyze</button>
        <button id="copyBtn">Copy reading</button>
        <button id="copyHtmlBtn">Copy as HTML</button>
        <span id="status" class="tiny muted" style="margin-left:auto"></span>
      </div>
      <div class="tts" style="margin-top:8px">
        <span class="pill">Narrator</span>
        <label>Voice <select id="voiceSelect"></select></label>
        <label class="tiny">Rate <input type="range" id="rate" min="0.6" max="1.4" step="0.02" value="0.98"></label>
        <label class="tiny">Pitch <input type="range" id="pitch" min="0.6" max="1.4" step="0.02" value="1.0"></label>
        <button id="testVoiceBtn">Test Voice</button>
        <button id="speakBtn">Speak (categories)</button>
        <button id="stopBtn">Stop</button>
      </div>
      <div class="disclaimer">Narration reads the category guidance only. Reflective guidance; not a directive.</div>
      <div id="diag" class="diag">Diagnostics: <b>loadingâ€¦</b></div>
    </section>

    <section class="card" id="resultCard" style="display:none">
      <div id="overview" class="long muted tiny">â€”</div>

      <div class="grid" style="margin-top:10px">
        <div class="kpi"><h3>Segments</h3><div id="segments">â€”</div></div>
        <div class="kpi"><h3>Bases</h3><div id="bases">â€”</div></div>
        <div class="kpi"><h3>Final Base</h3><div id="finalBase">â€”</div></div>
      </div>

      <details style="margin-top:10px">
        <summary>Show pattern & chips</summary>
        <div id="chips" style="margin-top:8px"></div>
        <div id="pattern" class="tiny muted" style="margin-top:6px"></div>
      </details>

      <h3 style="margin-top:14px">Reading <span id="seedTag" class="pill2">seed: â€”</span> <span id="packTag" class="pill2">pack: â€”</span></h3>
      <div id="reading" class="long">â€”</div>
    </section>
  </div>

<script>
const $ = id => document.getElementById(id);
function splitPairsLeft(str){ const s=String(str).replace(/\\D/g,''); if(!s) return []; const out=[]; for(let i=0;i<s.length;i+=2) out.push(s.slice(i,i+2)); return out; }
function reduceDigit(n){ n=String(n).replace(/\\D/g,''); if(!n) return null; let sum=0; for(const ch of n) sum+=Number(ch); while(sum>9){ let t=0; for(const ch of String(sum)) t+=Number(ch); sum=t; } return sum; }
const OV = { "11":{base:2, signs:["Libra"]}, "22":{base:4, signs:["Scorpio","Aries"]}, "33":{base:6, signs:["Capricorn","Gemini"]} };
function segmentBase(seg){ if(OV[seg]) return { base: OV[seg].base, master: seg, ov:OV[seg] }; return { base: reduceDigit(seg), master:null, ov:null }; }
function unique(a){ return Array.from(new Set(a.filter(Boolean))); }
function minorsForBase(d){ const N={1:'Ace',2:'Two',3:'Three',4:'Four',5:'Five',6:'Six',7:'Seven',8:'Eight',9:'Nine'}; const l=N[d]; if(!l) return []; return [`${l} of Wands`,`${l} of Cups`,`${l} of Swords`,`${l} of Pentacles`]; }
function majorsForBase(d){ const map={1:['The Magician','The Sun'],2:['Justice','The High Priestess'],3:['The Empress','The Lovers'],4:['The Emperor','Death (13)'],5:['The Hierophant','Temperance'],6:['The Lovers','The Devil'],7:['The Chariot','The Star'],8:['Strength','Judgement'],9:['The Hermit','The World']}; return map[d]||[]; }
function buildChipsGrouped(order, counts, infoMap){
  const chipHtml=[];
  for(let i=0;i<order.length;i++){
    const seg=order[i]; const info=infoMap[seg]||{};
    const signs=unique([].concat((info.ov&&info.ov.signs)||[]));
    const minors=minorsForBase(info.base||0);
    const times=(counts[seg]||0)>1?(' Ã—'+counts[seg]):'';
    const arrow=(info.master?info.master+'â†’':'') + (info.base||'?');
    chipHtml.push('<div class="chip">Seg '+(i+1)+': '+seg+' â†’ '+arrow+times+' Â· Signs: '+signs.join('/')+' Â· Minors: '+minors.join(', ')+'</div>');
  }
  return chipHtml.join('');
}
function computeFeatures(segs){
  const info=segs.map(s=>({seg:s, n:parseInt(s,10)}));
  const counts={}; const order=[]; const infoMap={};
  for(const o of info){ const x=segmentBase(o.seg); const full={...o, ...x}; if(!counts[o.seg]){ counts[o.seg]=1; order.push(o.seg); infoMap[o.seg]=full; } else { counts[o.seg]++; } }
  const has11=order.some(s=>s==='11'); const has22=order.some(s=>s==='22'); const has33=order.some(s=>s==='33');
  const nums=info.map(o=>o.n); let asc=true, desc=true;
  for(let i=1;i<nums.length;i++){ if(!(nums[i]>nums[i-1])) asc=false; if(!(nums[i]<nums[i-1])) desc=false; }
  const repeater=new Set(segs).size===1; const palindrome=segs.join('')===segs.slice().reverse().join(''); const hasZero=segs.some(s=>/0/.test(s));
  return {order, counts, infoMap, has11, has22, has33, asc, desc, repeater, palindrome, hasZero};
}
function describePattern(f){
  const t=[]; if(f.repeater) t.push('repeater'); if(f.palindrome) t.push('mirror'); if(f.asc) t.push('ladder up'); if(f.desc) t.push('ladder down'); if(f.hasZero) t.push('zeros'); if(f.has11) t.push('M11'); if(f.has22) t.push('M22'); if(f.has33) t.push('M33'); return t.join(' Â· ')||'mixed';
}
function xmur3(str){ let h=1779033703^str.length; for(let i=0;i<str.length;i++){ h=Math.imul(h^str.charCodeAt(i),3432918353); h=h<<13|h>>>19; } return function(){ h=Math.imul(h^h>>>16,2246822507); h=Math.imul(h^h>>>13,3266489909); return (h^h>>>16)>>>0; } }
function mulberry32(a){ return function(){ let t=a+=0x6D2B79F5; t=Math.imul(t^t>>>15,t|1); t^=t+Math.imul(t^t>>>7,t|61); return ((t^t>>>14)>>>0)/4294967296; } }
function seededPick(arr, rng){ if(!arr.length) return ''; return arr[Math.floor(rng()*arr.length)]; }
function seededSample(arr, k, rng){ const a=arr.slice(); for(let i=a.length-1;i>0;i--){ const j=Math.floor(rng()*(i+1)); const tmp=a[i]; a[i]=a[j]; a[j]=tmp; } return a.slice(0, Math.min(k,a.length)); }

const BASE_TONE={1:{verb:['begin','open','start','plant'],gift:['clarity','fresh courage'],caution:['impulse','impatience'],anchor:['first steps'],image:['a blank page']},
2:{verb:['balance','weave','attune'],gift:['harmony','listening'],caution:['peopleâ€‘pleasing'],anchor:['agreements'],image:['two lanterns']},
3:{verb:['express','compose'],gift:['communication','creative flow'],caution:['scatter'],anchor:['one channel'],image:['a chalk line']},
4:{verb:['structure','stabilize','organize'],gift:['stability','craft'],caution:['rigidity'],anchor:['frames and routines'],image:['a bench and four stones']},
5:{verb:['change','adapt'],gift:['flexibility'],caution:['restlessness'],anchor:['bounded play'],image:['a steady sail']},
6:{verb:['care','repair'],gift:['healing','belonging'],caution:['overâ€‘responsibility'],anchor:['kind boundaries'],image:['a warm stove']},
7:{verb:['reflect','study'],gift:['insight'],caution:['overâ€‘analysis'],anchor:['quiet focus'],image:['a lamp at a desk']},
8:{verb:['sustain','build'],gift:['stewardship'],caution:['overcontrol'],anchor:['steady practice'],image:['coals in a forge']},
9:{verb:['complete','release'],gift:['closure'],caution:['lingering'],anchor:['clean endings'],image:['a tide line']}};
const PACKS=[{name:'Mystic',weights:{core:3,craft:2,imagery:2},linkers:['Let this land.','Breathe here first.']},
{name:'Coach',weights:{core:2,craft:4,imagery:1},linkers:['Make it keepable.','Ship the inch.']},
{name:'Builder',weights:{core:2,craft:3,imagery:2},linkers:['Frames first.','Measure what matters.']},
{name:'Poet',weights:{core:3,craft:1,imagery:3},linkers:['Listen for the seam.','Name the weather.']},
{name:'Stoic',weights:{core:2,craft:3,imagery:1},linkers:['Control the controllable.','Hold the line.']}];
const POOLS={love:{core:[
'When love sits under Base {b}, the invitation is to {verb} without losing the human temperature of the room. The gift here is {gift}; the caution is {caution}. Begin repair by regulating, not proving.',
'Base {b} asks couples to choose rhythm over drama. Keep to one topic. If old cases rise, park them on paper and look for the threadâ€”usually safety, closeness, clarity, or respect.',
'Under {b}, affection grows where order lowers threat. Make a sevenâ€‘day microâ€‘ritual and praise the keeping more than outcomes.'],
craft:['Use the threeâ€‘beat repair: reflect, ask, suggest. Suggest one concrete next step you can keep today.',
'Boundaries become bridges when small and enforceable. Offer two real options that honour capacity.'],
imagery:['Hold the picture: {image}. Affection returns as the room becomes safer.']},
work:{core:['Work under Base {b} wants you to {verb} where it matters and stop where it doesnâ€™t. Map the pipeline: capture, shape, deliver, review.',
'Block ninety protected minutes. Move the smallest unit that moves the whole.'],
craft:['Template repeats; prune steps that never help.'],
imagery:['Hold the picture: {image}. The room becomes sane when pace is steady and kind.']},
confusion:{core:['Confusion under Base {b} is cured by {gift}. Shrink the question until it fits on one honest line a friend could understand.'],
craft:['Name the next visible step so small it cannot fail. Then take it.'],
imagery:['Hold the picture: {image}. Decisions like tidy roomsâ€”surfaces clear.']},
family:{core:['Family steadies under Base {b} when the frame is visible. Post the plan where all can see it.'],
craft:['Offer two sustainable options and let the group pick.'],
imagery:['Hold the picture: {image}. Consistency communicates love.']},
frustration:{core:['Frustration is bottled motion. Under Base {b}, {anchor} are medicine. Move first, then speak.'],
craft:['Shorten lists, tighten loops, set a timer.'],
imagery:['Hold the picture: {image}. Over weeks, cadence changes more than force.']}};
const ADDONS={M11:'Master 11 asks for justice and honest terms.',M22:'Master 22 adds builder gravityâ€”keep promises small and measurable.',M33:'Master 33 tilts to service and teachingâ€”protect your energy.',repeater:'Repeater pattern intensifies the lessonâ€”do one round well.',mirror:'Mirror invites alignmentâ€”behave the way you want to feel.',asc:'Ladderâ€‘up needs humane increments.',desc:'Ladderâ€‘down wants simplification.',zeros:'Zeros mark sacred pauses.'};

let RNG=mulberry32(1);
function fillTemplate(t, tone, b){
  return t.replace(/\{b\}/g, b)
          .replace(/\{verb\}/g, seededPick(tone.verb,RNG))
          .replace(/\{gift\}/g, seededPick(tone.gift,RNG))
          .replace(/\{caution\}/g, seededPick(tone.caution,RNG))
          .replace(/\{anchor\}/g, seededPick(tone.anchor,RNG))
          .replace(/\{image\}/g, seededPick(tone.image,RNG));
}
function sectionHTML(topic, finalBase, f){
  const tone=BASE_TONE[finalBase]||BASE_TONE[2];
  const pack=PACKS[Math.floor((RNG()*PACKS.length))]; $('packTag').textContent='pack: '+pack.name;
  function pList(arr){ const out=[]; for(let i=0;i<arr.length;i++){ out.push('<p>'+fillTemplate(arr[i],tone,finalBase)+'</p>'); } return out.join(''); }
  const P=POOLS[topic]; let blocks='<p><em>'+seededPick(pack.linkers,RNG)+'</em> Cards speaking: <strong>'+majorsForBase(finalBase).join(' & ')+'</strong>, '+minorsForBase(finalBase).join(', ')+'.</p>';
  blocks += pList(P.core) + pList(P.craft) + pList(P.imagery);
  const add=[]; if(f.has11) add.push(ADDONS.M11); if(f.has22) add.push(ADDONS.M22); if(f.has33) add.push(ADDONS.M33); if(f.repeater) add.push(ADDONS.repeater); if(f.palindrome) add.push(ADDONS.mirror); if(f.asc) add.push(ADDONS.asc); if(f.desc) add.push(ADDONS.desc); if(f.hasZero) add.push(ADDONS.zeros);
  if(add.length) blocks += '<p>'+add.join(' ')+'</p>';
  const title = topic.charAt(0).toUpperCase()+topic.slice(1);
  return '<h3>If the question is '+title+'</h3>'+blocks;
}
function buildReadingHTML(finalBase, f, seed){
  RNG=mulberry32(seed);
  const topics=['love','work','confusion','family','frustration'];
  let out='';
  for(let i=0;i<topics.length;i++){ out += sectionHTML(topics[i],finalBase,f); }
  return out + '<p>â€” Spirit Guide App</p>';
}

function diag(msg){ const vv=(window.speechSynthesis && window.speechSynthesis.getVoices && window.speechSynthesis.getVoices().length) || 0; $('diag').innerHTML='Diagnostics: <b>'+msg+'</b> Â· Voices: '+vv; }
function analyze(){
  const raw=$('num').value.trim(); const digits=raw.replace(/\\D/g,''); if(!digits){ alert('Enter a number'); return; }
  const segs=splitPairsLeft(digits); const f=computeFeatures(segs); const finalBase=reduceDigit(digits);
  $('resultCard').style.display='block'; $('overview').innerHTML='Segments: '+segs.join(', ')+' â€” Base: '+finalBase; $('segments').textContent=segs.join(', ');
  const bases=[]; for(let i=0;i<f.order.length;i++){ const seg=f.order[i]; const info=f.infoMap[seg]; const times=(f.counts[seg]>1)?(' Ã—'+f.counts[seg]):''; const arrow=(info.master?info.master+'â†’':'')+(info.base||'?'); bases.push(seg+' â†’ '+arrow+times); } $('bases').textContent=bases.join(', ');
  $('finalBase').textContent=String(finalBase); $('chips').innerHTML=buildChipsGrouped(f.order,f.counts,f.infoMap); $('pattern').textContent='Pattern tags: '+describePattern(f);
  const seed=xmur3(raw)(); $('seedTag').textContent='seed: '+seed.toString(16); const html=buildReadingHTML(finalBase,f,seed); $('reading').innerHTML=html; $('status').textContent='Done'; diag('Done');
}
document.getElementById('analyzeBtn').onclick=analyze;
document.getElementById('num').addEventListener('keydown', e=>{ if(e.key==='Enter') analyze(); });
document.getElementById('copyBtn').onclick=()=>{ const txt=(document.getElementById('reading').innerText||'').trim(); navigator.clipboard.writeText(txt+'\\nâ€” Spirit Guide App').then(()=> alert('Copied reading')); };
document.getElementById('copyHtmlBtn').onclick=()=>{ const html=document.getElementById('reading').innerHTML; navigator.clipboard.writeText(html).then(()=> alert('Copied HTML')); };

function waitForVoices(){ return new Promise(res=>{ const done=()=>res(window.speechSynthesis.getVoices()||[]); const list=window.speechSynthesis.getVoices(); if(list&&list.length){ res(list); return; } window.speechSynthesis.onvoiceschanged=done; setTimeout(done,800); }); }
const TARGETS=['Google UK English Female','Google UK English Male'];
function candidateVoices(all){ const out=[]; for(let i=0;i<all.length;i++){ const v=all[i]; if(TARGETS.indexOf(v.name)!==-1 && /^en/i.test(v.lang||'')) out.push(v); } return out; }
function populateVoices(){
  if(!('speechSynthesis' in window)) return;
  waitForVoices().then(all=>{
    const list=candidateVoices(all); const sel=document.getElementById('voiceSelect'); sel.innerHTML='';
    if(list.length){
      for(let i=0;i<list.length;i++){ const v=list[i]; const o=document.createElement('option'); o.value=v.name+'::'+v.lang; o.textContent=v.name+' ('+v.lang+')'; sel.appendChild(o); }
    }else{
      const any=(function(){ for(let i=0;i<all.length;i++){ if(/^en/i.test(all[i].lang||'')) return all[i]; } return null; })();
      if(any){ const o=document.createElement('option'); o.value=any.name+'::'+any.lang; o.textContent=any.name+' ('+any.lang+')'; sel.appendChild(o); }
      else { const o=document.createElement('option'); o.value=''; o.textContent='No English voice found'; o.disabled=true; sel.appendChild(o); }
    }
  });
}
function currentVoice(){ const sel=document.getElementById('voiceSelect'); if(!sel||sel.selectedIndex<0) return null; const parts=(sel.value||'::').split('::'); const name=parts[0], lang=parts[1]; const all=window.speechSynthesis.getVoices()||[]; for(let i=0;i<all.length;i++){ const v=all[i]; if(v.name===name && v.lang===lang) return v; } return null; }
function decodeEntities(h){ const t=document.createElement('textarea'); t.innerHTML=h; return t.value; }
function getSpeechText(){ let html=document.getElementById('reading').innerHTML||''; let text=decodeEntities(html); text=text.replace(/<script[\\s\\S]*?<\\/script>/gi,' ').replace(/<style[\\s\\S]*?<\\/style>/gi,' ').replace(/<[^>]+>/g,' '); text=text.replace(/\\\\n|\\n|n\\//g,' '); text=text.replace(/[#$*_`~^]/g,' '); text=text.replace(/\\s{2,}/g,' ').trim(); return text; }
function chunkText(text,maxLen){ maxLen=maxLen||220; const s=text.match(/[^.!?]+[.!?]*/g)||[text]; const out=[]; let buf=''; for(let i=0;i<s.length;i++){ const piece=(s[i]||'').trim(); if(!piece) continue; if((buf+' '+piece).trim().length>maxLen){ if(buf) out.push(buf.trim()); if(piece.length>maxLen){ for(let j=0;j<piece.length;j+=maxLen) out.push(piece.slice(j,j+maxLen)); buf=''; } else { buf=piece; } } else { buf=(buf?buf+' ':'')+piece; } } if(buf) out.push(buf.trim()); return out; }
function speakCategories(){
  if(!('speechSynthesis' in window)) return alert('Speech not supported here.');
  window.speechSynthesis.cancel();
  const cleaned=getSpeechText(); if(!cleaned){ alert('Nothing to read.'); return; }
  const chunks=chunkText('Reflective guidance only. '+cleaned, 220);
  const v=currentVoice();
  const rate=parseFloat(document.getElementById('rate').value||'1'); const pitch=parseFloat(document.getElementById('pitch').value||'1');
  function next(){ if(!chunks.length){ document.getElementById('status').textContent='Narration finished'; return; } const u=new SpeechSynthesisUtterance(chunks.shift()); if(v) u.voice=v; u.rate=rate; u.pitch=pitch; u.onend=next; u.onerror=next; try{ speechSynthesis.speak(u);}catch(e){ setTimeout(()=>speechSynthesis.speak(u),80); } }
  try{ const unlock=new SpeechSynthesisUtterance(' '); if(v) unlock.voice=v; speechSynthesis.speak(unlock); }catch(e){}
  setTimeout(next, 80);
}
document.getElementById('testVoiceBtn').onclick=()=>{ const u=new SpeechSynthesisUtterance('Google UK voice test. Clean text.'); const v=currentVoice(); if(v) u.voice=v; u.rate=parseFloat(document.getElementById('rate').value||'1'); u.pitch=parseFloat(document.getElementById('pitch').value||'1'); try{ speechSynthesis.speak(u);}catch(e){ alert('Tap the page then try again.'); } };
document.getElementById('speakBtn').onclick=speakCategories;
document.getElementById('stopBtn').onclick=()=>{ speechSynthesis.cancel(); document.getElementById('status').textContent='Stopped'; setTimeout(()=> document.getElementById('status').textContent='', 900); };
if('speechSynthesis' in window){ populateVoices(); document.getElementById('diag').textContent='Voices loadingâ€¦'; setTimeout(()=>{ document.getElementById('diag').textContent='Ready'; }, 700); } else { document.getElementById('diag').textContent='Speech not supported'; }
</script>
</body>
</html>
