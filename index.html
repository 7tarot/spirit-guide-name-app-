<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Spirit Guide App â€” Endpoint Patch</title>
<style>
  :root{ --bg:#05090a; --card:#081215; --edge:#102227; --text:#d1f7ff; --mint:#7efcff; --muted:#9bc7d1 }
  *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1000px;margin:0 auto;padding:22px 16px 40px}
  .card{background:var(--card);border:1px solid var(--edge);border-radius:14px;padding:16px;margin:14px 0}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  label{font-weight:600;display:block;margin:.4rem 0 .2rem}
  input,select,button{font:inherit;border-radius:10px;border:1px solid var(--edge);background:#0b1214;color:var(--text);padding:.6rem .75rem}
  button{cursor:pointer}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(210px,1fr));gap:12px}
  .kpi{background:#0b1214;border:1px solid var(--edge);border-radius:10px;padding:12px}
  .kpi h3{margin:0 0 6px;color:var(--mint);font-size:15px}
  .kpi div{font-weight:700;font-size:20px;font-family:ui-monospace,Menlo,Consolas,monospace}
  .tiny{font-size:12px} .muted{color:var(--muted)}
</style>
</head>
<body>
  <div class="wrap">
    <h1>ðŸ”® Spirit Guide App</h1>
    <p class="tiny muted">Endpoint patch â€” posting to <code>https://script.google.com/macros/s/AKfycbxg14tVEU3AJ210QQ0Ul3BfZAhOIQgz-MW5PNVsmsc/exec</code></p>

    <section class="card">
      <div class="row">
        <div style="flex:1 1 260px">
          <label for="name">Your Name</label>
          <input id="name" placeholder="e.g., Steven Abbott">
        </div>
        <div style="flex:1 1 220px">
          <label for="dob">Date of Birth</label>
          <input id="dob" type="date">
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="demoBtn">Demo</button>
        <button id="calcBtn">Calculate</button>
        <button id="resetBtn">Reset</button>
      </div>
    </section>

    <section class="card" id="resultsCard" style="display:none">
      <h2 id="guideName">Your Spirit Guide</h2>
      <div class="grid">
        <div class="kpi"><h3>Life Path</h3><div id="lifePath">â€”</div></div>
        <div class="kpi"><h3>Expression</h3><div id="expression">â€”</div></div>
        <div class="kpi"><h3>Soul Urge</h3><div id="soulUrge">â€”</div></div>
        <div class="kpi"><h3>Personality</h3><div id="personality">â€”</div></div>
        <div class="kpi"><h3>Birthday</h3><div id="birthday">â€”</div></div>
        <div class="kpi"><h3>Maturity</h3><div id="maturity">â€”</div></div>
        <div class="kpi"><h3>Karmic Debts</h3><div id="karmicDebts">â€”</div></div>
        <div class="kpi"><h3>Karmic Lessons</h3><div id="karmicLessons">â€”</div></div>
        <div class="kpi"><h3>Balance</h3><div id="balance">â€”</div></div>
      </div>
    </section>

    <section class="card" id="emailCard" style="display:none">
      <strong>ðŸ“© Weâ€™ll email your full backstory within 24 hours.</strong>
      <div class="row" style="margin-top:8px">
        <input id="email" type="email" placeholder="you@example.com" style="flex:1 1 280px">
        <label class="tiny"><input type="checkbox" id="consent"> I agree to be contacted about my result.</label>
        <button id="sendBtn">Send my result</button>
      </div>
      <div id="sendStatus" class="tiny muted"></div>
    </section>
  </div>

  <!-- Hidden iframe target for the form post -->
  <iframe name="sheetSink" style="display:none"></iframe>

<script>
const SHEETS_URL = "https://script.google.com/macros/s/AKfycbxg14tVEU3AJ210QQ0Ul3BfZAhOIQgz-MW5PNVsmsc/exec";
const STORAGE_KEY = "sg-endpoint-patch";
const $ = (id)=>document.getElementById(id);

// Numerology helpers
function onlyLetters(str){ return (str||'').toUpperCase().replace(/[^A-Z]/g,''); }
function sumDigits(n){ n = String(n).replace(/[^0-9]/g,''); return n.split('').reduce((a,b)=>a+Number(b),0); }
function reduceNum(n){ n = Number(n); while (![11,22,33].includes(n) && n>9){ n = sumDigits(n); } return n; }
function nameNumber(name, type){
  const map={A:1,B:2,C:3,D:4,E:5,F:6,G:7,H:8,I:9,J:1,K:2,L:3,M:4,N:5,O:6,P:7,Q:8,R:9,S:1,T:2,U:3,V:3,W:5,X:6,Y:7,Z:8};
  const vowels=new Set(['A','E','I','O','U','Y']); let cleaned=onlyLetters(name), val=0;
  for(const ch of cleaned){ const v=map[ch]||0;
    if(type==='vowels'&&vowels.has(ch)) val+=v; else if(type==='consonants'&&!vowels.has(ch)) val+=v; else if(type==='all') val+=v;
  } return reduceNum(val);
}
function dateToNumbers(dstr){ const d=new Date(dstr); if(isNaN(d)) return {lifePath:null,birthday:null}; const yyyy=d.getUTCFullYear(),mm=d.getUTCMonth()+1,dd=d.getUTCDate(); const lifePath=reduceNum(sumDigits(yyyy)+sumDigits(mm)+sumDigits(dd)); return {lifePath,birthday:reduceNum(dd)}; }
function deterministicGuide(name,dob){ const g=["Zoriel","Nymera","Elarion","Serapha","Kael","Aven","Lyra","Thalen","Mireth","Orin"]; const seed=(onlyLetters(name)+dob).split('').reduce((a,c)=>a+c.charCodeAt(0),0); return g[seed%g.length]; }
function renderResults(r){ $('guideName').textContent="Your Spirit Guide: "+r.guide; $('lifePath').textContent=r.lifePath; $('expression').textContent=r.expression; $('soulUrge').textContent=r.soulUrge; $('personality').textContent=r.personality; $('birthday').textContent=r.birthday; $('maturity').textContent=r.maturity; $('karmicDebts').textContent=r.karmicDebts; $('karmicLessons').textContent=r.karmicLessons; $('balance').textContent=r.balance; }

document.getElementById('demoBtn').onclick = ()=>{ $('name').value="Alex Example"; $('dob').value="1990-07-14"; };
document.getElementById('calcBtn').onclick = ()=>{
  const nm=$('name').value.trim(), d=$('dob').value; if(!nm||!d) return alert("Enter your name and date of birth.");
  const dn=dateToNumbers(d);
  const res={ name:nm, dob:d, guide:deterministicGuide(nm,d), lifePath:dn.lifePath, expression:nameNumber(nm,'all'), soulUrge:nameNumber(nm,'vowels'), personality:nameNumber(nm,'consonants'), birthday:dn.birthday, maturity:reduceNum(dn.lifePath + nameNumber(nm,'all')), karmicDebts:"â€”", karmicLessons:"â€”", balance:reduceNum(nameNumber(nm[0]||'','all') + (new Date(d)).getUTCDate()) };
  localStorage.setItem(STORAGE_KEY, JSON.stringify({results:res}));
  document.getElementById('resultsCard').style.display=document.getElementById('emailCard').style.display="block";
  renderResults(res);
};
document.getElementById('resetBtn').onclick = ()=>{ localStorage.removeItem(STORAGE_KEY); location.reload(); };

// Send via hidden form (no CORS)
document.getElementById('sendBtn').onclick = ()=>{
  const email = $('email').value.trim(); const consent = $('consent').checked;
  const statusEl = $('sendStatus');
  if(!email){ statusEl.textContent="Enter an email."; return; }
  if(!consent){ statusEl.textContent="Please tick consent."; return; }

  const saved = JSON.parse(localStorage.getItem(STORAGE_KEY)||"{}");
  const r = saved.results || {};
  const payload = {
    email, consent: consent ? "Yes":"No", timestamp: new Date().toISOString(),
    name: r.name || "", dob: r.dob || "", guide: r.guide || "",
    lifePath: r.lifePath || "", expression: r.expression || "", soulUrge: r.soulUrge || "",
    personality: r.personality || "", birthday: r.birthday || "", maturity: r.maturity || "",
    karmicDebts: r.karmicDebts || "", karmicLessons: r.karmicLessons || "", balance: r.balance || "",
    result_json: JSON.stringify(r||{})
  };

  const form = document.createElement('form'); form.method='POST'; form.action=SHEETS_URL; form.target='sheetSink';
  for (const k in payload) { const inp=document.createElement('input'); inp.type='hidden'; inp.name=k; inp.value=String(payload[k]); form.appendChild(inp); }
  document.body.appendChild(form);
  try { form.submit(); statusEl.textContent="Sent âœ… â€” check your Google Sheet for a new row."; }
  catch(e) { statusEl.textContent="Could not send â€” form submit failed."; }
  finally { setTimeout(()=>{ try{ document.body.removeChild(form); }catch(_ ){} }, 1200); }
};

// Restore if any
(function restore(){ try{ const s=JSON.parse(localStorage.getItem(STORAGE_KEY)||"{}"); if(s.results){ renderResults(s.results); document.getElementById('resultsCard').style.display=document.getElementById('emailCard').style.display="block"; } }catch(e){} })();
</script>
</body>
</html>
