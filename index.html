<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Spirit Guide App â€” Classic (Sheet Fix v2)</title>
<style>
  :root{ --bg:#0c0f0c; --panel:#121712; --border:#1b291c; --text:#f1fff7; --muted:#b7d6c3; --accent:#7fffd4; --accent2:#57d9a9; --err:#ff9b9b; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Arial,sans-serif}
  .wrap{max-width:980px;margin:0 auto;padding:28px}
  h1{margin:0 0 6px;font-size:34px}
  .sub{color:var(--muted);margin:0 0 18px;font-size:15px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:18px;margin:16px 0;box-shadow:0 8px 30px rgba(0,0,0,.22)}
  label{display:block;font-weight:600;margin:.5rem 0 .35rem}
  input,select,button{font:inherit;border-radius:10px;border:1px solid var(--border);background:#0f130f;color:var(--text);padding:.6rem .75rem}
  button{cursor:pointer}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .row > *{flex:1 1 240px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
  .kpi{background:#0f130f;border:1px solid var(--border);border-radius:10px;padding:12px}
  .kpi h3{margin:0 0 6px;font-size:16px;color:var(--accent)}
  .kpi div{font-weight:700;font-size:20px}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  .long{white-space:pre-line;background:#0f130f;border:1px solid var(--border);padding:14px;border-radius:10px;font-size:15px;line-height:1.5}
  .section-title{margin:18px 0 10px}
  .banner{background:linear-gradient(90deg,#113d27,#10353a);border:1px solid var(--border);padding:14px;border-radius:12px}
  .banner strong{color:var(--accent)}
  .primary{background:var(--accent2);border-color:var(--accent2);color:#001e11;font-weight:700}
  .primary:hover{filter:brightness(1.05)}
  .muted{color:var(--muted)} .tiny{font-size:12px}
  .status { margin-top: 8px; }
  .status.ok { color: var(--accent); }
  .status.err { color: var(--err); }
  details summary { cursor: pointer; }
  code { white-space: pre-wrap; word-break: break-word; }
</style>
</head>
<body>
  <div class="wrap">
    <h1>ðŸ”® Spirit Guide App</h1>
    <p class="sub">Classic layout â€¢ Sheet Fix v2 (autoâ€‘retry JSON â†’ formâ€‘encoded â†’ FormData)</p>

    <section class="card">
      <div class="row">
        <div>
          <label for="name">Your Name</label>
          <input id="name" placeholder="e.g., Steven Abbott"/>
        </div>
        <div>
          <label for="dob">Date of Birth</label>
          <input id="dob" type="date"/>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="demoBtn">Demo</button>
        <button id="calcBtn">Calculate</button>
        <button id="resetBtn">Reset</button>
      </div>
    </section>

    <section class="card" id="resultsCard" style="display:none">
      <h2 id="guideName">Your Spirit Guide</h2>
      <div class="grid">
        <div class="kpi"><h3>Life Path</h3><div id="lifePath" class="mono">â€”</div></div>
        <div class="kpi"><h3>Expression</h3><div id="expression" class="mono">â€”</div></div>
        <div class="kpi"><h3>Soul Urge</h3><div id="soulUrge" class="mono">â€”</div></div>
        <div class="kpi"><h3>Personality</h3><div id="personality" class="mono">â€”</div></div>
        <div class="kpi"><h3>Birthday</h3><div id="birthday" class="mono">â€”</div></div>
        <div class="kpi"><h3>Maturity</h3><div id="maturity" class="mono">â€”</div></div>
        <div class="kpi"><h3>Karmic Debts</h3><div id="karmicDebts" class="mono">â€”</div></div>
        <div class="kpi"><h3>Karmic Lessons</h3><div id="karmicLessons" class="mono">â€”</div></div>
        <div class="kpi"><h3>Balance</h3><div id="balance" class="mono">â€”</div></div>
      </div>
    </section>

    <section class="card" id="emailCard" style="display:none">
      <div class="banner">
        <strong>ðŸ“© Weâ€™ll email your full backstory within 24 hours.</strong>
        <div class="muted tiny">Enter email and tick consent so we can send it.</div>
        <div class="row" style="margin-top:8px">
          <input id="email" type="email" placeholder="you@example.com"/>
          <label><input type="checkbox" id="consent"/> I agree to be contacted.</label>
          <button id="sendBtn" class="primary">Send my result</button>
        </div>
        <div id="sendStatus" class="status tiny muted"></div>
        <details id="sendDebug" class="tiny" style="margin-top:6px; display:none">
          <summary>Details</summary>
          <div><code id="debugOut"></code></div>
        </details>
      </div>
    </section>
  </div>

<script>
const SHEETS_URL = "https://script.google.com/macros/s/AKfycbxlNWaWtYEnn4rizDRYRhkxey6CfGczi2oYkmDgRKs7rUHvnyWs0FTaQr1XB8FzJmhi/exec";
const STORAGE_KEY = "sg-fix-v2";
const $ = (id)=>document.getElementById(id);

function onlyLetters(str){ return (str||'').toUpperCase().replace(/[^A-Z]/g,''); }
function sumDigits(n){ n = String(n).replace(/[^0-9]/g,''); return n.split('').reduce((a,b)=>a+Number(b),0); }
function reduceNum(n){ n = Number(n); while (![11,22,33].includes(n) && n>9){ n = sumDigits(n); } return n; }
function nameNumber(name, type){
  const map = {A:1,B:2,C:3,D:4,E:5,F:6,G:7,H:8,I:9,J:1,K:2,L:3,M:4,N:5,O:6,P:7,Q:8,R:9,S:1,T:2,U:3,V:3,W:5,X:6,Y:7,Z:8};
  const vowels = new Set(['A','E','I','O','U','Y']);
  let cleaned = onlyLetters(name), val = 0;
  for(const ch of cleaned){
    const v = map[ch]||0;
    if(type==='vowels' && vowels.has(ch)) val += v;
    else if(type==='consonants' && !vowels.has(ch)) val += v;
    else if(type==='all') val += v;
  }
  return reduceNum(val);
}
function dateToNumbers(dstr){
  const d = new Date(dstr); if(isNaN(d)) return {lifePath:null,birthday:null};
  const yyyy = d.getUTCFullYear(), mm = d.getUTCMonth()+1, dd = d.getUTCDate();
  const lifePath = reduceNum(sumDigits(yyyy)+sumDigits(mm)+sumDigits(dd));
  return {lifePath, birthday: reduceNum(dd)};
}
function deterministicGuide(name,dob){
  const g=["Zoriel","Nymera","Elarion","Serapha","Kael","Aven","Lyra","Thalen","Mireth","Orin"];
  const seed=(onlyLetters(name)+dob).split('').reduce((a,c)=>a+c.charCodeAt(0),0);
  return g[seed%g.length];
}
function renderResults(r){
  $('guideName').textContent="Your Spirit Guide: "+r.guide;
  $('lifePath').textContent=r.lifePath; $('expression').textContent=r.expression; $('soulUrge').textContent=r.soulUrge;
  $('personality').textContent=r.personality; $('birthday').textContent=r.birthday; $('maturity').textContent=r.maturity;
  $('karmicDebts').textContent=r.karmicDebts; $('karmicLessons').textContent=r.karmicLessons; $('balance').textContent=r.balance;
}

$('demoBtn').onclick = ()=>{ $('name').value="Alex Example"; $('dob').value="1990-07-14"; };
$('calcBtn').onclick = ()=>{
  const nm=$('name').value.trim(), d=$('dob').value; if(!nm||!d){ alert("Enter your name and date of birth."); return; }
  const dn = dateToNumbers(d);
  const res = { name:nm, dob:d, guide:deterministicGuide(nm,d), lifePath:dn.lifePath, expression:nameNumber(nm,'all'), soulUrge:nameNumber(nm,'vowels'), personality:nameNumber(nm,'consonants'), birthday:dn.birthday, maturity:reduceNum(dn.lifePath + nameNumber(nm,'all')), karmicDebts:"â€”", karmicLessons:"â€”", balance:reduceNum(nameNumber(nm[0]||'','all') + (new Date(d)).getUTCDate()) };
  $('resultsCard').style.display=$('emailCard').style.display="block"; renderResults(res);
  localStorage.setItem(STORAGE_KEY, JSON.stringify({results:res}));
};
$('resetBtn').onclick = ()=>{ localStorage.removeItem(STORAGE_KEY); location.reload(); };

async function sendToSheet(payload) {
  const attempts = [
    { label:"JSON", opts: { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(payload) } },
    { label:"FORM_URLENCODED", opts: { method:"POST", headers:{"Content-Type":"application/x-www-form-urlencoded"}, body: new URLSearchParams(payload).toString() } },
    { label:"FORMDATA", opts: { method:"POST", body: (()=>{ const fd = new FormData(); for (const k in payload) fd.append(k, String(payload[k])); return fd; })() } }
  ];
  let last = { via:null, status:null, body:null, error:null };
  for (const a of attempts) {
    try {
      const res = await fetch(SHEETS_URL, a.opts);
      const text = await res.text().catch(()=> "");
      if (res.ok) {
        // If body parses and ok!==false, treat as success
        let ok = true;
        try { const j = JSON.parse(text); if (j && j.ok === false) ok = false; } catch(e) {/* ignore */}
        if (ok) return { ok:true, via:a.label, body:text };
      }
      last = { via:a.label, status:res.status, body:text, error:null };
    } catch (e) {
      last = { via:a.label, status:null, body:null, error:String(e) };
    }
  }
  return { ok:false, last };
}

$('sendBtn').onclick = async ()=>{
  const email = $('email').value.trim(); const consent = $('consent').checked;
  if(!email){ $('sendStatus').textContent="Enter an email."; $('sendStatus').className="status err"; return; }
  if(!consent){ $('sendStatus').textContent="Please tick consent."; $('sendStatus').className="status err"; return; }

  const saved = JSON.parse(localStorage.getItem(STORAGE_KEY)||"{}");
  const r = saved.results || {};
  const payload = {
    email, consent: consent ? "Yes":"No", timestamp: new Date().toISOString(),
    name: r.name || "", dob: r.dob || "",
    guide: r.guide ?? "", lifePath: r.lifePath ?? "", expression: r.expression ?? "", soulUrge: r.soulUrge ?? "",
    personality: r.personality ?? "", birthday: r.birthday ?? "", maturity: r.maturity ?? "",
    karmicDebts: r.karmicDebts ?? "", karmicLessons: r.karmicLessons ?? "", balance: r.balance ?? "",
    result_json: JSON.stringify(r||{})
  };

  $('sendStatus').textContent="Sendingâ€¦"; $('sendStatus').className="status muted";
  $('sendDebug').style.display="none"; $('debugOut').textContent="";
  const result = await sendToSheet(payload);
  if (result.ok) {
    $('sendStatus').textContent="Saved âœ… We will follow up by email within ~24 hours.";
    $('sendStatus').className="status ok";
  } else {
    $('sendStatus').textContent="Could not send. Try again later.";
    $('sendStatus').className="status err";
    const info = result.last || {};
    $('debugOut').textContent = "Tried via: " + (info.via||"unknown") + "\nStatus: " + (info.status??"n/a") + "\nBody: " + (info.body??"") + "\nError: " + (info.error??"");
    $('sendDebug').style.display="block";
  }
};

// Restore state if any
(function restore(){
  try{ const s = JSON.parse(localStorage.getItem(STORAGE_KEY)||"{}"); if(s.results){ renderResults(s.results); $('resultsCard').style.display=$('emailCard').style.display="block"; } }catch(e){}
})();
</script>
</body>
</html>
