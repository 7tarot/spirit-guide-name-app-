<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Spirit Guide App â€” Features Only (No Style Overrides)</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>
  <div class="wrap">
    <h1>ğŸ”® Spirit Guide App</h1>
    <p class="muted">Expanded meanings for every placement + Narrator + visible 24â€‘hour followâ€‘up capture.</p>

    <!-- INPUTS -->
    <section class="card section-inputs">
      <div class="row">
        <div class="field">
          <label for="name">Your Name</label>
          <input id="name" placeholder="e.g., Steven Abbott"/>
        </div>
        <div class="field">
          <label for="dob">Date of Birth</label>
          <input id="dob" type="date"/>
        </div>
      </div>
      <div class="row">
        <div class="field">
          <label for="ambient">Ambient sound</label>
          <select id="ambient">
            <option value="">None</option>
            <option value="ambient/rain.mp3">Rain</option>
            <option value="ambient/choir.mp3">Choir</option>
            <option value="ambient/drone.mp3">Drone</option>
          </select>
          <button id="stopAudio">Stop</button>
        </div>
        <div class="field buttons">
          <label>&nbsp;</label>
          <div class="row">
            <button id="demoBtn">Demo</button>
            <button id="calcBtn">Calculate</button>
            <button id="resetBtn">Reset</button>
            <button id="copyBtn">Copy summary</button>
          </div>
        </div>
      </div>
    </section>

    <!-- RESULTS SNAPSHOT -->
    <section class="card section-results" id="resultsCard" style="display:none">
      <h2 id="guideName">Your Spirit Guide</h2>
      <div class="grid">
        <div class="kpi"><h3>Life Path</h3><div id="lifePath" class="mono">â€”</div></div>
        <div class="kpi"><h3>Expression</h3><div id="expression" class="mono">â€”</div></div>
        <div class="kpi"><h3>Soul Urge</h3><div id="soulUrge" class="mono">â€”</div></div>
        <div class="kpi"><h3>Personality</h3><div id="personality" class="mono">â€”</div></div>
        <div class="kpi"><h3>Birthday</h3><div id="birthday" class="mono">â€”</div></div>
        <div class="kpi"><h3>Maturity</h3><div id="maturity" class="mono">â€”</div></div>
        <div class="kpi"><h3>Karmic Debts</h3><div id="karmicDebts" class="mono">â€”</div></div>
        <div class="kpi"><h3>Karmic Lessons</h3><div id="karmicLessons" class="mono">â€”</div></div>
        <div class="kpi"><h3>Balance</h3><div id="balance" class="mono">â€”</div></div>
      </div>
      <div class="narrator controls">
        <strong>ğŸ™ï¸ Narrator</strong>
        <button id="speakBtn">Play</button>
        <button id="stopSpeakBtn">Stop</button>
      </div>
    </section>

    <!-- EMAIL + CONSENT (prominent but styled by your CSS) -->
    <section class="card section-email" id="emailCard" style="display:none">
      <div class="banner">
        <div class="cta">
          <strong>ğŸ“© Weâ€™ll email your full 400â€‘word backstory in <span class="accent">24 hours</span>.</strong>
          <span class="muted">Enter your email & consent to receive it.</span>
        </div>
        <div class="row">
          <input id="email" type="email" placeholder="you@example.com"/>
          <label><input type="checkbox" id="consent"/> I agree to be contacted about my result.</label>
          <button id="sendBtn" class="primary">Send my result</button>
        </div>
        <div id="sendStatus" class="muted"></div>
      </div>
    </section>

    <!-- LONG EXPLANATIONS -->
    <section class="card section-long" id="longCard" style="display:none">
      <h3>ğŸ“– Life Path â€” Deep Meaning</h3>
      <div id="lifePathLong" class="long">â€”</div>

      <h3>ğŸ—£ï¸ Expression â€” How You Operate</h3>
      <div id="expressionLong" class="long">â€”</div>

      <h3>ğŸ’— Soul Urge â€” What Your Heart Wants</h3>
      <div id="soulUrgeLong" class="long">â€”</div>

      <h3>ğŸª Personality â€” How Others See You</h3>
      <div id="personalityLong" class="long">â€”</div>

      <h3>ğŸ‚ Birthday â€” Your Natural Gift</h3>
      <div id="birthdayLong" class="long">â€”</div>

      <h3>ğŸŒ± Maturity â€” Your Long Arc</h3>
      <div id="maturityLong" class="long">â€”</div>

      <h3>âš–ï¸ Balance â€” How You Reâ€‘centre</h3>
      <div id="balanceLong" class="long">â€”</div>
    </section>

    <!-- COUNTDOWN -->
    <section class="card section-countdown" id="countdownCard" style="display:none">
      <strong>ğŸ•’ Backstory unlocks in: <span id="countdown">â€”</span></strong>
      <div class="muted">(24 hours after first calculation on this device)</div>
    </section>
  </div>

  <audio id="player" preload="none"></audio>

  <script>
  const SHEETS_URL = "https://script.google.com/macros/s/AKfycbxlNWaWtYEnn4rizDRYRhkxey6CfGczi2oYkmDgRKs7rUHvnyWs0FTaQr1XB8FzJmhi/exec";

  const $ = (id)=>document.getElementById(id);
  function onlyLetters(str){ return (str||'').toUpperCase().replace(/[^A-Z]/g,''); }
  function sumDigits(n){ n = String(n).replace(/[^0-9]/g,''); return n.split('').reduce((a,b)=>a+Number(b),0); }
  function reduceNum(n){ n = Number(n); while (![11,22,33].includes(n) && n>9){ n = sumDigits(n); } return n; }
  function nameNumber(name, type){
    const map = {A:1,B:2,C:3,D:4,E:5,F:6,G:7,H:8,I:9,J:1,K:2,L:3,M:4,N:5,O:6,P:7,Q:8,R:9,S:1,T:2,U:3,V:4,W:5,X:6,Y:7,Z:8};
    const vowels = new Set(['A','E','I','O','U','Y']);
    let cleaned = onlyLetters(name);
    let val = 0;
    for(const ch of cleaned){
      const v = map[ch]||0;
      if(type==='vowels' && vowels.has(ch)) val += v;
      else if(type==='consonants' && !vowels.has(ch)) val += v;
      else if(type==='all') val += v;
    }
    return reduceNum(val);
  }
  function dateToNumbers(dstr){
    const d = new Date(dstr);
    if(isNaN(d)) return {lifePath:null,birthday:null};
    const yyyy = d.getUTCFullYear(), mm = d.getUTCMonth()+1, dd = d.getUTCDate();
    const lifePath = reduceNum(sumDigits(yyyy)+sumDigits(mm)+sumDigits(dd));
    const birthday = reduceNum(dd);
    return {lifePath,birthday};
  }
  function formatKarmicDebts(totalStr){
    const debts = [];
    if(totalStr.includes('13')) debts.push(13);
    if(totalStr.includes('14')) debts.push(14);
    if(totalStr.includes('16')) debts.push(16);
    if(totalStr.includes('19')) debts.push(19);
    return debts.length? debts.join(', ') : 'None';
  }
  function timeLeftString(ms){
    if(ms<=0) return "0m";
    const s = Math.floor(ms/1000);
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    const sc = s%60;
    return h + "h " + m + "m " + sc + "s";
  }
  function deterministicGuide(name,dob){
    const guides = ["Zoriel","Nymera","Elarion","Serapha","Kael","Aven","Lyra","Thalen","Mireth","Orin"];
    const seed = (onlyLetters(name)+dob).split('').reduce((a,c)=>a + c.charCodeAt(0),0);
    return guides[ seed % guides.length ];
  }

  const STORAGE_KEY = "spirit-guide-state-v6";
  let longDB = null;
  let countdownTimer = null;

  (function init(){
    $("calcBtn").addEventListener("click", onCalculate);
    $("demoBtn").addEventListener("click", onDemo);
    $("resetBtn").addEventListener("click", onReset);
    $("copyBtn").addEventListener("click", onCopy);
    $("sendBtn").addEventListener("click", onSend);
    $("ambient").addEventListener("change", onAmbientChange);
    $("stopAudio").addEventListener("click", ()=>{ const a=$("player"); a.pause(); a.currentTime=0; });

    // Narrator
    const speakBtn = document.getElementById("speakBtn");
    const stopSpeakBtn = document.getElementById("stopSpeakBtn");
    if(speakBtn){ speakBtn.addEventListener("click", speakResults); }
    if(stopSpeakBtn){ stopSpeakBtn.addEventListener("click", stopSpeak); }

    // preload JSON (with cache-bust)
    fetch('numerology_descriptions.json?v=' + Date.now())
      .then(r=>r.json())
      .then(db=>{ longDB = db; console.log("Loaded numerology JSON", db); })
      .catch(err=>console.error("Failed to load numerology JSON", err));

    const saved = localStorage.getItem(STORAGE_KEY);
    if(saved){
      try{
        const s = JSON.parse(saved);
        $("name").value = s.name || "";
        $("dob").value = s.dob || "";
        if(s.results){
          renderResults(s.results);
          $("resultsCard").style.display = "block";
          $("longCard").style.display = "block";
          $("emailCard").style.display = "block";
          setupCountdown(s.firstCalcAt);
        }
      }catch(e){ console.warn("Bad saved state", e); }
    }
  })();

  function onDemo(){
    $("name").value = "Alex Example";
    $("dob").value = "1990-07-14";
  }

  function onCalculate(){
    const name = $("name").value.trim();
    const dob = $("dob").value;
    if(!name || !dob){ alert("Please enter your name and date of birth."); return; }

    const {lifePath,birthday} = dateToNumbers(dob);
    const expression = nameNumber(name,'all');
    const soulUrge = nameNumber(name,'vowels');
    const personality = nameNumber(name,'consonants');
    const maturity = reduceNum(lifePath + expression);
    const balance = reduceNum(nameNumber(name[0]||'','all') + (new Date(dob)).getUTCDate());
    const karmicLessons = "â€”";
    const karmicDebts = formatKarmicDebts(dob.replace(/-/g,''));
    const guide = deterministicGuide(name, dob);

    const results = {name,dob,guide,lifePath,expression,soulUrge,personality,birthday,maturity,karmicDebts,karmicLessons,balance};
    renderResults(results);

    const firstCalcAt = Date.now();
    localStorage.setItem(STORAGE_KEY, JSON.stringify({name, dob, results, firstCalcAt}));

    document.getElementById("resultsCard").style.display = "block";
    document.getElementById("longCard").style.display = "block";
    document.getElementById("emailCard").style.display = "block";
    setupCountdown(firstCalcAt);
    document.getElementById('emailCard').scrollIntoView({behavior:'smooth', block:'center'});
  }

  function customiseTextForPlacement(info, label, n){
    let text = [info.overview, info.strengths, info.challenges, info.relationships, info.watchouts, info.coaching].join("\\n\\n");
    const re1 = new RegExp("^\\s*Life\\s*Path\\s*"+n+"\\b","i");
    text = text.replace(re1, label + " " + n);
    const re2 = new RegExp("^\\s*Master\\s*Number\\s*"+n+"\\b","i");
    text = text.replace(re2, label + " " + n + " (Master Number)");
    return text;
  }

  function renderResults(r){
    $("guideName").textContent = "Your Spirit Guide: " + r.guide;
    $("lifePath").textContent = r.lifePath;
    $("expression").textContent = r.expression;
    $("soulUrge").textContent = r.soulUrge;
    $("personality").textContent = r.personality;
    $("birthday").textContent = r.birthday;
    $("maturity").textContent = r.maturity;
    $("karmicDebts").textContent = r.karmicDebts;
    $("karmicLessons").textContent = r.karmicLessons;
    $("balance").textContent = r.balance;

    if(longDB && longDB.numbers){
      const fmt = (n,label)=>{
        const info = longDB.numbers[String(n)];
        if(!info) return label + " " + n + ": Detailed meaning coming soon.";
        return customiseTextForPlacement(info, label, n);
      };
      document.getElementById("lifePathLong").textContent   = fmt(r.lifePath,   "Life Path");
      document.getElementById("expressionLong").textContent = fmt(r.expression, "Expression");
      document.getElementById("soulUrgeLong").textContent   = fmt(r.soulUrge,   "Soul Urge");
      document.getElementById("personalityLong").textContent= fmt(r.personality,"Personality");
      document.getElementById("birthdayLong").textContent   = fmt(r.birthday,   "Birthday");
      document.getElementById("maturityLong").textContent   = fmt(r.maturity,   "Maturity");
      document.getElementById("balanceLong").textContent    = fmt(r.balance,    "Balance");
    }else{
      const msg = "Loading meaningsâ€¦ (If this remains, numerology_descriptions.json did not load.)";
      ["lifePathLong","expressionLong","soulUrgeLong","personalityLong","birthdayLong","maturityLong","balanceLong"].forEach(id=>document.getElementById(id).textContent=msg);
    }
  }

  function setupCountdown(firstCalcAt){
    const unlockAt = firstCalcAt + 24*60*60*1000;
    document.getElementById("countdownCard").style.display = "block";
    clearInterval(countdownTimer);
    countdownTimer = setInterval(()=>{
      const left = unlockAt - Date.now();
      document.getElementById("countdown").textContent = timeLeftString(left);
      if(left <= 0){ clearInterval(countdownTimer); document.getElementById("countdown").textContent = "0m"; }
    }, 1000);
  }

  function onReset(){ localStorage.removeItem(STORAGE_KEY); location.reload(); }
  function onCopy(){
    const saved = localStorage.getItem(STORAGE_KEY);
    if(!saved){ alert("Nothing to copy yet. Calculate your guide first."); return; }
    navigator.clipboard.writeText(saved).then(()=> alert("Copied your summary to clipboard.") );
  }
  function onAmbientChange(e){
    const src = e.target.value;
    const p = document.getElementById("player");
    if(!src){ p.pause(); return; }
    p.src = src; p.loop = true; p.play().catch(console.warn);
  }
  async function onSend(){
    const email = document.getElementById("email").value.trim();
    const consent = document.getElementById("consent").checked;
    if(!email){ document.getElementById("sendStatus").innerHTML = '<span class="error">Enter an email.</span>'; return; }
    if(!consent){ document.getElementById("sendStatus").innerHTML = '<span class="error">Please tick consent.</span>'; return; }
    const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
    const payload = { email, consent:true, timestamp:new Date().toISOString(), result: saved.results || null };
    document.getElementById("sendStatus").textContent = "Sendingâ€¦";
    try{
      await fetch(SHEETS_URL, { method:"POST", mode:"no-cors", headers:{"Content-Type":"application/json"}, body: JSON.stringify(payload) });
      document.getElementById("sendStatus").innerHTML = '<span class="success">Saved. We will follow up by email in ~24 hours.</span>';
    }catch(err){
      console.error(err);
      document.getElementById("sendStatus").innerHTML = '<span class="error">Could not send. Try again later.</span>';
    }
  }

  // Narrator
  function buildNarration(){
    const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
    const r = saved.results; if(!r || !longDB) return "Your reading is ready.";
    const get = (n)=> longDB.numbers[String(n)];
    const join = (label, n, obj)=> obj? (label+" "+n+". "+obj.overview):"";
    return [
      "Your spirit guide is " + r.guide + ".",
      join("Life Path", r.lifePath, get(r.lifePath)),
      join("Expression", r.expression, get(r.expression)),
      join("Soul Urge", r.soulUrge, get(r.soulUrge)),
      join("Personality", r.personality, get(r.personality)),
      join("Birthday", r.birthday, get(r.birthday)),
      join("Maturity", r.maturity, get(r.maturity)),
      join("Balance", r.balance, get(r.balance)),
      "We will email your full four hundred word backstory in approximately twenty four hours. Please ensure your email and consent are entered."
    ].filter(Boolean).join(" ");
  }
  function speakResults(){
    try{
      stopSpeak();
      const text = buildNarration();
      const utter = new SpeechSynthesisUtterance(text);
      utter.rate = 1; utter.pitch = 1;
      speechSynthesis.speak(utter);
      window.__utter = utter;
    }catch(e){ console.warn(e); }
  }
  function stopSpeak(){
    try{
      if(speechSynthesis.speaking) speechSynthesis.cancel();
      window.__utter = null;
    }catch(e){}
  }
  </script>
</body>
</html>
