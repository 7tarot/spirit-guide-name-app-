<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Spirit Guide App — Classic (Complete Bundle)</title>
<meta name="description" content="Numerology snapshot, backstory in 24h, optional ambient.">
<style>
  :root{ --bg:#05090a; --card:#081215; --edge:#102227; --text:#d1f7ff; --mint:#7efcff; --muted:#9bc7d1; --ok:#a7ffd8; --err:#ff9b9b; }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1000px;margin:0 auto;padding:22px 16px 40px}
  h1{margin:0 0 6px;color:var(--mint)}
  .sub{margin:0 0 16px;color:var(--muted)}
  .card{background:var(--card);border:1px solid var(--edge);border-radius:14px;padding:16px;margin:14px 0;box-shadow:0 10px 30px rgba(0,0,0,.22)}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  label{font-weight:600;display:block;margin:.4rem 0 .2rem}
  input,select,button{font:inherit;border-radius:10px;border:1px solid var(--edge);background:#0b1214;color:var(--text);padding:.6rem .75rem}
  button{cursor:pointer}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(210px,1fr));gap:12px}
  .kpi{background:#0b1214;border:1px solid var(--edge);border-radius:10px;padding:12px}
  .kpi h3{margin:0 0 6px;color:var(--mint);font-size:15px}
  .kpi div{font-weight:700;font-size:20px;font-family:ui-monospace,Menlo,Consolas,monospace}
  .tiny{font-size:12px} .muted{color:var(--muted)}
  .long{white-space:pre-line;background:#0b1214;border:1px solid var(--edge);padding:12px;border-radius:10px;line-height:1.5}
  .banner{background:linear-gradient(90deg,#10353a,#0f2b2f);border:1px solid var(--edge);padding:14px;border-radius:12px}
  .primary{background:#1aa37a;border-color:#1aa37a;color:#001e11;font-weight:700}
  .ok{color:var(--ok)} .err{color:var(--err)}
</style>
</head>
<body>
  <div class="wrap">
    <h1>🔮 Spirit Guide App</h1>
    <p class="sub">Classic dark/mint UI • Snapshot now • Backstory in 24 hours • Optional ambient.</p>

    <!-- NAME + DOB + AMBIENT -->
    <section class="card">
      <div class="row">
        <div style="flex:1 1 260px">
          <label for="name">Your Name</label>
          <input id="name" placeholder="e.g., Steven Abbott">
        </div>
        <div style="flex:1 1 220px">
          <label for="dob">Date of Birth</label>
          <input id="dob" type="date">
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div class="row">
          <button id="demoBtn">Demo</button>
          <button id="calcBtn">Calculate</button>
          <button id="resetBtn">Reset</button>
          <button id="copyBtn">Copy summary</button>
        </div>
        <div class="row" style="margin-left:auto">
          <select id="ambient">
            <option value="">Ambient: None</option>
            <option value="ambient/binaural.mp3">Ambient: binaural.mp3</option>
          </select>
          <label class="tiny muted" style="display:flex;align-items:center;gap:8px">
            Volume <input type="range" id="ambientVol" min="0" max="1" step="0.05" value="0.35" style="width:160px">
          </label>
          <button id="stopAudio">Stop</button>
        </div>
      </div>
    </section>

    <!-- SNAPSHOT -->
    <section class="card" id="resultsCard" style="display:none">
      <h2 id="guideName">Your Spirit Guide</h2>
      <div class="grid">
        <div class="kpi"><h3>Life Path</h3><div id="lifePath">—</div></div>
        <div class="kpi"><h3>Expression</h3><div id="expression">—</div></div>
        <div class="kpi"><h3>Soul Urge</h3><div id="soulUrge">—</div></div>
        <div class="kpi"><h3>Personality</h3><div id="personality">—</div></div>
        <div class="kpi"><h3>Birthday</h3><div id="birthday">—</div></div>
        <div class="kpi"><h3>Maturity</h3><div id="maturity">—</div></div>
        <div class="kpi"><h3>Karmic Debts</h3><div id="karmicDebts">—</div></div>
        <div class="kpi"><h3>Karmic Lessons</h3><div id="karmicLessons">—</div></div>
        <div class="kpi"><h3>Balance</h3><div id="balance">—</div></div>
      </div>
    </section>

    <!-- EMAIL + CONSENT -->
    <section class="card" id="emailCard" style="display:none">
      <div class="banner">
        <strong>📩 We’ll email your full 400‑word backstory in <u>24 hours</u>.</strong>
        <div class="tiny muted">Enter your email and tick consent so we can send it.</div>
        <div class="row" style="margin-top:8px">
          <input id="email" type="email" placeholder="you@example.com" style="flex:1 1 280px">
          <label class="tiny"><input type="checkbox" id="consent"> I agree to be contacted about my result.</label>
          <button id="sendBtn" class="primary">Send my result</button>
        </div>
        <div id="sendStatus" class="tiny muted"></div>
      </div>
    </section>

    <!-- LONG EXPLANATIONS -->
    <section class="card" id="longCard" style="display:none">
      <h3>📖 Life Path — Deep Meaning</h3>
      <div id="lifePathLong" class="long">—</div>
      <h3 style="margin-top:10px">🗣️ Expression — How You Operate</h3>
      <div id="expressionLong" class="long">—</div>
      <h3 style="margin-top:10px">💗 Soul Urge — What Your Heart Wants</h3>
      <div id="soulUrgeLong" class="long">—</div>
      <h3 style="margin-top:10px">🪞 Personality — How Others See You</h3>
      <div id="personalityLong" class="long">—</div>
      <h3 style="margin-top:10px">🎂 Birthday — Your Natural Gift</h3>
      <div id="birthdayLong" class="long">—</div>
      <h3 style="margin-top:10px">🌱 Maturity — Your Long Arc</h3>
      <div id="maturityLong" class="long">—</div>
      <h3 style="margin-top:10px">⚖️ Balance — How You Re‑centre</h3>
      <div id="balanceLong" class="long">—</div>
    </section>

    <!-- COUNTDOWN -->
    <section class="card" id="countdownCard" style="display:none">
      <strong>🕒 Backstory unlocks in: <span id="countdown">—</span></strong>
      <div class="tiny muted">(24 hours after first calculation on this device)</div>
    </section>
  </div>

  <audio id="player" preload="none"></audio>
  <iframe name="sheetSink" style="display:none"></iframe>

<script>
const SHEETS_URL = "https://script.google.com/macros/s/AKfycbxlNWaWtYEnn4rizDRYRhkxey6CfGczi2oYkmDgRKs7rUHvnyWs0FTaQr1XB8FzJmhi/exec";
const STORAGE_KEY = "spirit-guide-complete-v1";
const $ = (id)=>document.getElementById(id);

let longDB=null, timer=null;

// Ambient
const p = $('player'); const volEl=$('ambientVol');
function applyVolume(){ p.volume = parseFloat(volEl.value||'0.35'); localStorage.setItem('sg-vol', p.volume); }
const savedVol = parseFloat(localStorage.getItem('sg-vol')); if(!isNaN(savedVol)) volEl.value = savedVol.toFixed(2);
volEl.oninput = applyVolume; applyVolume();
$('ambient').onchange = (e)=>{ const src=e.target.value; if(!src){p.pause();return;} p.src=src; p.loop=true; applyVolume(); p.play().catch(()=>alert("If blocked, click Calculate once then choose again.")); };
$('stopAudio').onclick = ()=>{ p.pause(); p.currentTime=0; };

// Numerology helpers
function onlyLetters(str){ return (str||'').toUpperCase().replace(/[^A-Z]/g,''); }
function sumDigits(n){ n = String(n).replace(/[^0-9]/g,''); return n.split('').reduce((a,b)=>a+Number(b),0); }
function reduceNum(n){ n = Number(n); while (![11,22,33].includes(n) && n>9){ n = sumDigits(n); } return n; }
function nameNumber(name, type){
  const map={A:1,B:2,C:3,D:4,E:5,F:6,G:7,H:8,I:9,J:1,K:2,L:3,M:4,N:5,O:6,P:7,Q:8,R:9,S:1,T:2,U:3,V:3,W:5,X:6,Y:7,Z:8};
  const vowels=new Set(['A','E','I','O','U','Y']);
  let cleaned=onlyLetters(name), val=0;
  for(const ch of cleaned){ const v=map[ch]||0;
    if(type==='vowels'&&vowels.has(ch)) val+=v; else if(type==='consonants'&&!vowels.has(ch)) val+=v; else if(type==='all') val+=v;
  } return reduceNum(val);
}
function dateToNumbers(dstr){ const d=new Date(dstr); if(isNaN(d)) return {lifePath:null,birthday:null}; const yyyy=d.getUTCFullYear(),mm=d.getUTCMonth()+1,dd=d.getUTCDate(); const lifePath=reduceNum(sumDigits(yyyy)+sumDigits(mm)+sumDigits(dd)); return {lifePath,birthday:reduceNum(dd)}; }
function deterministicGuide(name,dob){ const g=["Zoriel","Nymera","Elarion","Serapha","Kael","Aven","Lyra","Thalen","Mireth","Orin"]; const seed=(onlyLetters(name)+dob).split('').reduce((a,c)=>a+c.charCodeAt(0),0); return g[seed%g.length]; }
function formatKarmicDebts(totalStr){ const debts=[]; for(const k of [13,14,16,19]) if(totalStr.includes(String(k))) debts.push(k); return debts.length? debts.join(", "):"None"; }
function timeLeftString(ms){ if(ms<=0) return "0m"; const s=Math.floor(ms/1000),h=Math.floor(s/3600),m=Math.floor((s%3600)/60),sc=s%60; return h+"h "+m+"m "+sc+"s"; }

function customiseText(info,label,n){ let text=[info.overview,info.strengths,info.challenges,info.relationships,info.watchouts,info.coaching].filter(Boolean).join("\n\n"); const re1=new RegExp("^\s*Life\s*Path\s*"+n+"\b","i"); text=text.replace(re1,label+" "+n); const re2=new RegExp("^\s*Master\s*Number\s*"+n+"\b","i"); text=text.replace(re2,label+" "+n+" (Master Number)"); return text; }

function renderResults(r){
  $('guideName').textContent="Your Spirit Guide: "+r.guide;
  $('lifePath').textContent=r.lifePath; $('expression').textContent=r.expression; $('soulUrge').textContent=r.soulUrge;
  $('personality').textContent=r.personality; $('birthday').textContent=r.birthday; $('maturity').textContent=r.maturity;
  $('karmicDebts').textContent=r.karmicDebts; $('karmicLessons').textContent=r.karmicLessons; $('balance').textContent=r.balance;
  if(longDB&&longDB.numbers){
    const fmt=(n,label)=>{ const info=longDB.numbers[String(n)]; return info?customiseText(info,label,n):(label+" "+n+": Detailed meaning coming soon."); };
    $('lifePathLong').textContent=fmt(r.lifePath,"Life Path"); $('expressionLong').textContent=fmt(r.expression,"Expression");
    $('soulUrgeLong').textContent=fmt(r.soulUrge,"Soul Urge"); $('personalityLong').textContent=fmt(r.personality,"Personality");
    $('birthdayLong').textContent=fmt(r.birthday,"Birthday"); $('maturityLong').textContent=fmt(r.maturity,"Maturity"); $('balanceLong').textContent=fmt(r.balance,"Balance");
  }
}

function setupCountdown(firstCalcAt){
  const unlockAt = firstCalcAt + 24*60*60*1000;
  document.getElementById('countdownCard').style.display="block";
  clearInterval(timer);
  timer = setInterval(()=>{
    const left = unlockAt - Date.now();
    document.getElementById('countdown').textContent = timeLeftString(left);
    if(left<=0){ clearInterval(timer); document.getElementById('countdown').textContent = "0m"; }
  }, 1000);
}

// Buttons
document.getElementById('demoBtn').onclick = ()=>{ $('name').value="Alex Example"; $('dob').value="1990-07-14"; };
document.getElementById('calcBtn').onclick = ()=>{
  const nm=$('name').value.trim(), d=$('dob').value;
  if(!nm||!d) return alert("Please enter your name and date of birth.");
  const dn = dateToNumbers(d);
  const res = {
    name:nm, dob:d, guide:deterministicGuide(nm,d),
    lifePath:dn.lifePath, expression:nameNumber(nm,'all'), soulUrge:nameNumber(nm,'vowels'),
    personality:nameNumber(nm,'consonants'), birthday:dn.birthday,
    maturity:reduceNum(dn.lifePath + nameNumber(nm,'all')),
    karmicDebts:formatKarmicDebts(d.replace(/-/g,'')),
    karmicLessons:"—",
    balance:reduceNum(nameNumber(nm[0]||'','all') + (new Date(d)).getUTCDate())
  };
  localStorage.setItem(STORAGE_KEY, JSON.stringify({results:res, firstCalcAt: Date.now()}));
  document.getElementById('resultsCard').style.display=document.getElementById('emailCard').style.display=document.getElementById('longCard').style.display="block";
  renderResults(res);
  const saved = JSON.parse(localStorage.getItem(STORAGE_KEY)||"{}");
  setupCountdown(saved.firstCalcAt || Date.now());
};
document.getElementById('resetBtn').onclick = ()=>{ localStorage.removeItem(STORAGE_KEY); location.reload(); };
document.getElementById('copyBtn').onclick = ()=>{ const s=localStorage.getItem(STORAGE_KEY); if(!s) return alert("Nothing to copy yet."); navigator.clipboard.writeText(s).then(()=>alert("Copied.")); };

// Load numerology long text if present
fetch('numerology_descriptions.json?v='+Date.now())
  .then(r=>r.ok?r.json():Promise.reject())
  .then(db=>{ longDB=db; const s=JSON.parse(localStorage.getItem(STORAGE_KEY)||"{}"); if(s.results) renderResults(s.results); })
  .catch(()=>{ /* optional file */ });

// *** SHEET SEND — hidden form via iframe (bypasses CORS) ***
document.getElementById('sendBtn').onclick = ()=>{
  const email = $('email').value.trim(); const consent = $('consent').checked;
  const statusEl = $('sendStatus');
  if(!email){ statusEl.textContent = "Enter an email."; statusEl.className="tiny err"; return; }
  if(!consent){ statusEl.textContent = "Please tick consent."; statusEl.className="tiny err"; return; }

  const saved = JSON.parse(localStorage.getItem(STORAGE_KEY)||"{}");
  const r = saved.results || {};

  const payload = {
    email, consent: consent ? "Yes":"No", timestamp: new Date().toISOString(),
    name: r.name || "", dob: r.dob || "",
    guide: r.guide ?? "", lifePath: r.lifePath ?? "", expression: r.expression ?? "", soulUrge: r.soulUrge ?? "",
    personality: r.personality ?? "", birthday: r.birthday ?? "", maturity: r.maturity ?? "",
    karmicDebts: r.karmicDebts ?? "", karmicLessons: r.karmicLessons ?? "", balance: r.balance ?? "",
    result_json: JSON.stringify(r||{})
  };

  const form = document.createElement('form');
  form.method = 'POST'; form.action = SHEETS_URL; form.target = 'sheetSink';
  for (const k in payload) { const inp=document.createElement('input'); inp.type='hidden'; inp.name=k; inp.value=String(payload[k]); form.appendChild(inp); }
  document.body.appendChild(form);
  try { form.submit(); statusEl.textContent="Sent ✅ — check your Google Sheet for a new row."; statusEl.className="tiny ok"; }
  catch(e) { statusEl.textContent="Could not send — form submit failed."; statusEl.className="tiny err"; }
  finally { setTimeout(()=>{ try{ document.body.removeChild(form); }catch(_ ){} }, 1500); }
};

// Restore
(function restore(){
  try{ const s=JSON.parse(localStorage.getItem(STORAGE_KEY)||"{}");
    if(s.results){ renderResults(s.results); document.getElementById('resultsCard').style.display=document.getElementById('emailCard').style.display=document.getElementById('longCard').style.display="block"; setupCountdown(s.firstCalcAt || Date.now()); }
  }catch(e){}
})();
</script>
</body>
</html>
