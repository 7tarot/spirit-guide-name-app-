<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Synchronicity Reader â€” Mystical Pro v2</title>
<style>
  :root{ --bg:#05090a; --card:#081215; --edge:#102227; --text:#d1f7ff; --mint:#7efcff; --muted:#9bc7d1; --ok:#a7ffd8; --err:#ff9b9b }
  *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1000px;margin:0 auto;padding:22px 16px 40px}
  h1{margin:0 0 6px;color:var(--mint)}
  .sub{margin:0 0 16px;color:var(--muted)}
  .card{background:var(--card);border:1px solid var(--edge);border-radius:14px;padding:16px;margin:14px 0}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
  .kpi{background:#0b1214;border:1px solid var(--edge);border-radius:10px;padding:12px}
  .kpi h3{margin:0 0 6px;color:var(--mint);font-size:15px}
  .kpi div{font-weight:700;font-size:20px;font-family:ui-monospace,Menlo,Consolas,monospace}
  label{font-weight:600;display:block;margin:.4rem 0 .2rem}
  input,button,select{font:inherit;border-radius:10px;border:1px solid var(--edge);background:#0b1214;color:#d1f7ff;padding:.55rem .7rem}
  button{cursor:pointer}
  .chip{display:inline-block;border:1px solid #1f3b41;border-radius:999px;padding:4px 8px;margin:4px 6px 0 0;color:#9bc7d1;font-size:12px}
  .long{white-space:pre-line;line-height:1.7}
  .tiny{font-size:12px} .muted{color:var(--muted)} .ok{color:var(--ok)} .err{color:var(--err)}
  .tts{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .disclaimer{font-size:12px;color:#9bc7d1;margin-top:6px}
  .pill{display:inline-block;padding:4px 10px;border:1px solid #1f3940;border-radius:999px;margin-right:8px;color:#8fd7e3;font-size:12px}
  h2,h3{margin:10px 0 6px}
</style>
</head>
<body>
  <div class="wrap">
    <h1>ðŸ”¢ Synchronicity Reader â€” Mystical Pro v2</h1>
    <p class="sub">Clean narration, clearer stories. Enter the number you keep seeing.</p>

    <section class="card">
      <div class="row">
        <label>Synchronicity number
          <input id="num" placeholder="e.g., 2011, 2222, 1234" style="min-width:220px">
        </label>
        <label>Tone
          <select id="tone">
            <option value="plain">Plainâ€‘English</option>
            <option value="light" selected>Mystical â€” Light</option>
            <option value="rich">Mystical â€” Rich</option>
          </select>
        </label>
        <button id="analyzeBtn">Analyze</button>
        <button id="copyBtn">Copy reading</button>
        <button id="copyHtmlBtn">Copy as HTML</button>
        <span id="status" class="tiny muted" style="margin-left:auto"></span>
      </div>
      <div class="tts" style="margin-top:8px">
        <span class="pill">Narrator</span>
        <label>Voice <select id="voiceSelect"></select></label>
        <label class="tiny"><input type="checkbox" id="forceEnglish" checked> English only</label>
        <label class="tiny">Rate <input type="range" id="rate" min="0.6" max="1.4" step="0.02" value="0.98"></label>
        <label class="tiny">Pitch <input type="range" id="pitch" min="0.6" max="1.4" step="0.02" value="1.0"></label>
        <button id="testVoiceBtn">Test</button>
        <button id="speakBtn">Speak</button>
        <button id="stopBtn">Stop</button>
      </div>
      <div class="disclaimer">Reflective guidance only. Narration uses a cleaned version of the text (no symbols or hashes).</div>
    </section>

    <section class="card" id="resultCard" style="display:none">
      <div class="grid">
        <div class="kpi"><h3>Segments (2â€‘digit)</h3><div id="segments">â€”</div></div>
        <div class="kpi"><h3>Segment Bases</h3><div id="bases">â€”</div></div>
        <div class="kpi"><h3>Final Base</h3><div id="finalBase">â€”</div></div>
      </div>

      <h3>Tarot & Astro Mapping</h3>
      <div id="chips"></div>

      <h3>Reading</h3>
      <div id="reading" class="long">â€”</div>
    </section>

    <section class="card tiny muted">
      Data: <code>synchronicity_mapping.json</code> + <code>synchronicity_overrides.json</code>. Only <strong>Google</strong> voices are shown. Speech removes symbols like asterisks, hashes, and arrows.
    </section>
  </div>

<script>
const MAP_URL = 'synchronicity_mapping.json?v='+Date.now();
const OV_URL  = 'synchronicity_overrides.json?v='+Date.now();

const $ = id => document.getElementById(id);
let DB = null, OV = null;

// ========= helpers ==========
function splitPairsLeft(str){ const s=String(str).replace(/\\D/g,''); if(!s) return []; const out=[]; for(let i=0;i<s.length;i+=2) out.push(s.slice(i,i+2)); return out; }
function reduceDigit(n){ n=String(n).replace(/\\D/g,''); if(!n) return null; let sum=0; for(const ch of n) sum+=Number(ch); while(sum>9){ let t=0; for(const ch of String(sum)) t+=Number(ch); sum=t; } return sum; }
function segmentBase(seg){ if(OV[seg]) return { base: OV[seg].base, master: seg, ov:OV[seg] }; return { base: reduceDigit(seg), master:null, ov:null }; }
function unique(arr){ return Array.from(new Set(arr.filter(Boolean))); }
function mapDigitToEntry(d){ const db=(DB && (DB.numbers||DB))||{}; return db[String(d)] || {}; }
function minorsForBase(d){ const names={1:'Ace',2:'Two',3:'Three',4:'Four',5:'Five',6:'Six',7:'Seven',8:'Eight',9:'Nine'}; const label=names[d]; if(!label) return []; return [`${label} of Wands`,`${label} of Cups`,`${label} of Swords`,`${label} of Pentacles`]; }

// ========= content templates (simpler, speech-friendly) ==========
const ANCHOR = {
1:{title:"Clean Beginnings", theme:"initiative and clean starts",
plain:"Today favours first steps you can explain in one sentence. Keep the move small, visible, and kind to your nerves. Choose one message to send, one task to begin, and one place to start again without apology.",
light:"A door you know well opens without creak. Carry your own small light and cross the threshold. One clear sentence and one honest action begin a chapter that can hold your name.",
rich:"The ember becomes a steady flame in your hands. A key fits the door you have circled. Enter with a single true sentence and let the room shape itself around that tone."
},
2:{title:"Living Balance", theme:"cooperation and soft power",
plain:"Work with another rhythm, not against it. Share plans in simple language, agree how you will decide together, and keep your edges kind and clear.",
light:"Two currents meet and make a calmer river. Walk the middle board with a friend. The answer is a conversation that repeats until it becomes trust.",
rich:"Mist gathers where the streams braid. A lantern meets your lantern on the bridge. Balance is dialogue made visible; step in time and arrive together."
},
3:{title:"True Expression", theme:"expression and creative links",
plain:"Say the useful thing and keep it brief. Share a small example, ask for one response, and move on. Your words work when they serve.",
light:"The market is bright, but you choose three stalls only. Speak, listen, adjust. Your voice finds its shape when someone hears it.",
rich:"Bells open the day; you select colour, page, and tune. A child repeats your line and you polish it. Expression becomes a path others can walk."
},
4:{title:"Good Structure", theme:"structure and foundations",
plain:"Make one system that reduces effort tomorrow. Write a checklist, prune a step, and protect a ninetyâ€‘minute focus block.",
light:"A simple workshop waits: four stones, a clean bench. You choose a rule you can keep and let it hold the day steady.",
rich:"A room with high windows, tools in their homes, four stones at the compass points. You draw a line between what serves and what delays. The frame becomes a kindness."
},
5:{title:"Gentle Change", theme:"movement and flexibility",
plain:"Try one safe experiment. Keep stakes low, keep notes, and decide after you catch your breath.",
light:"A short wind shifts and you adjust your sail. Travel by honest signs and let curiosity lead you to water.",
rich:"The caravan moves on light feet. Tents appear and vanish without scar. Trade certainty for a good question and let it guide you."
},
6:{title:"Caring Harmony", theme:"responsibility and healing",
plain:"Offer help that does not exhaust you. Define one standard of care and keep it. Make home more home today.",
light:"The hearth warms, the garden listens. Small repairs change the air. Choose the action that quiets the room.",
rich:"Cinnamon rises; soil loosens. A chair slides and the doorway tells the truth. Care is geometry that lets everyone pass."
},
7:{title:"Quiet Insight", theme:"study and spiritual focus",
plain:"Reduce noise. Give one hour to a single question and stop when the answer is good enough to act on.",
light:"Fog thins around a small window. You study one pattern until it reveals the simple next move.",
rich:"Cedar and ink; a hooded lamp. Symbols populate the silence and one of them raises its hand. You follow it one yard only."
},
8:{title:"Calm Strength", theme:"resources and sustained effort",
plain:"Choose one routine you can keep for eight days. Track results, not moods. Power grows when it is gentle and regular.",
light:"The forge hums at a low heat. Repetition becomes a prayer your hands understand.",
rich:"Coals as a small constellation, steam writing shy scripture. Strength is the courtesy of repetition; mastery arrives without announcement."
},
9:{title:"Clean Completion", theme:"release and service",
plain:"Finish one thing. Bless what was useful, archive what is done, and free your energy for what returns.",
light:"Tide pulls light into itself and gives it back. You keep one shell for music and let the rest go.",
rich:"A box once heavy becomes light by the waterline. Grief and relief share a coat. You keep a single note that still sings and return the others to the tide."
}
};

const CAT = {
1:{love:"Name a desire warmly and invite a simple yes or no. Start a weekly ritual that is easy to keep.", work:"Draft a oneâ€‘page charter and ship a tiny first version today.", confusion:"Reduce inputs to one clear question and act on the next fact.", family:"Open the conversation kindly and be concrete about what happens next.", frustration:"Turn the feeling into motion; send the shortest message that moves the block."},
2:{love:"Treat love like a duet. Agree on a rhythm you both can keep.", work:"Write basic agreements: who does what by when, and how you decide.", confusion:"Balance the scale; ask one trusted mirror what they heard between your words.", family:"Translate gently instead of taking sides; set one shared plan.", frustration:"Breathe in fours, then act only on what is truly yours."},
3:{love:"Offer a specific appreciation. If conflict, write before you speak, then soften once.", work:"Show a small example and ask for one piece of feedback.", confusion:"Choose one channel for a dayâ€”writing, voice note, or sketch.", family:"Add lightness: a song, a story, a game.", frustration:"Express, then choose the smallest publishable act."},
4:{love:"Build the hearth: a weekly date, a kind budget, a shared checklist.", work:"Choose one template, prune a step, protect a focus block.", confusion:"Name what decision this is really about; use one clear criterion.", family:"Create a simple routine everyone can keep and praise the keeping.", frustration:"Tighten one bolt you control; repeat tomorrow."},
5:{love:"Invite a microâ€‘adventure that feels safe to the body.", work:"Pilot one change with one metric for one week.", confusion:"Lower the wind: fewer voices, fewer tabs, more breath.", family:"Suggest a kinder sequence to the usual dance and thank any ease.", frustration:"Move the body; decide after the state has changed."},
6:{love:"Ask what would help and believe the answer. Make home more home.", work:"Define what good looks like and model it.", confusion:"Step back from overâ€‘empathy and choose a helpful deed that doesnâ€™t drain you.", family:"Repair softly: one apology, one boundary, one celebration.", frustration:"Return one burden to where it belongs."},
7:{love:"Share one page of your inner world and stop there.", work:"Research one knot and untie only that.", confusion:"Quiet first; take the thin silver thread one step.", family:"Offer a better question and give space for the answer.", frustration:"Find the one fact that collapses the maze."},
8:{love:"Keep one promise small and strong; warmth beats drama.", work:"Track reps, not moods; send one concise update with numbers.", confusion:"Pick the lever with the most return; pull steadily.", family:"Add structure without steamrolling; boundaries plus care.", frustration:"Channel it through craft for ten quiet minutes."},
9:{love:"Release the old story with respect and practice gentle compassion.", work:"Finish, archive, or hand off; bless the space you made.", confusion:"Treat this as an ending and choose the clean goodbye.", family:"Make a simple ritual of grace; memory is honored.", frustration:"Let the tide take what is already leaving; save your strength."}
};

// ========= narrative builders (HTML, not markdown) =========
function p(text){ return `<p>${text}</p>`; }
function h2(text){ return `<h2>${text}</h2>`; }
function h3(text){ return `<h3>${text}</h3>`; }

function segmentHTML(idx, rawSeg, base, majors, minors, signs, master, tone){
  const baseNames={1:'Ace',2:'Two',3:'Three',4:'Four',5:'Five',6:'Six',7:'Seven',8:'Eight',9:'Nine'};
  const baseName = baseNames[base]||String(base);
  const majorsTxt = majors.length? `Majors: ${majors.join(', ')}.` : '';
  const minorsTxt = minors.length? `Minors: ${minors.join(', ')}.` : '';
  const signsTxt  = signs.length? `Astro: ${signs.join(', ')}.` : '';
  const masterTxt = master? ` Master ${master} steps down to ${base}.` : '';
  const open = `Segment ${idx} (${rawSeg} â†’ ${master? master+' to ':''}${base}) asks for embodiment. ${majorsTxt} ${minorsTxt} ${signsTxt}${masterTxt}`.trim();

  let body;
  if (tone==='plain'){
    body = `Treat this as a small altar to ${baseName} energy. Protect a block of time, send one useful message, and drop one habit that wastes focus. Keep the rhythm simple and repeatable.`;
  } else if (tone==='light'){
    body = `Make a clear space for this current. Choose one boundary that protects the work, one signal that invites support, and one release so the plan can breathe.`;
  } else {
    body = `Let this current shape the day. Set a threshold that keeps noise out, invite one aligned witness, and allow an old pattern to fall away so the structure stands clean.`;
  }
  return p(open) + p(body);
}

function buildReadingHTML(num, segs, basesInfo, finalBase){
  const tone = $('tone').value;
  const anchor = ANCHOR[finalBase] || {title:'Anchor', theme:'', plain:'', light:'', rich:''};
  const story = (tone==='plain'? anchor.plain : tone==='light'? anchor.light : anchor.rich);

  const parts = [];
  parts.push(h2(`${num} â€” ${anchor.title}`));
  parts.push(p(`We split ${num} into ${segs.join(', ')}. Adding the bases resolves to ${finalBase}: ${anchor.theme}.`));

  // segments
  basesInfo.forEach((info, i)=>{
    const entry = mapDigitToEntry(info.base);
    const majors = entry.majors || entry.Majors || [];
    const signs  = unique([...(entry.signs||entry.Signs||[]), ...(info.ov && info.ov.signs || [])]);
    const minors = minorsForBase(info.base);
    parts.push(h3(`Segment ${i+1} â€” ${info.master? 'Master '+info.master+' â†’ ':''}${info.base}`));
    parts.push(segmentHTML(i+1, segs[i], info.base, majors, minors, signs, info.master, tone));
  });

  // anchor story
  parts.push(h3(`Anchor â€” ${finalBase}`));
  parts.push(p(story));

  // categories
  const cat = CAT[finalBase] || {};
  parts.push(h3(`If the question is Love`), p(cat.love||''));
  parts.push(h3(`If the question is Work/Vocation`), p(cat.work||''));
  parts.push(h3(`If the question is Confusion`), p(cat.confusion||''));
  parts.push(h3(`If the question is Family`), p(cat.family||''));
  parts.push(h3(`If the question is Frustration`), p(cat.frustration||''));

  parts.push(p(`â€” Spirit Guide App`));
  return parts.join('\n');
}

function buildChips(basesInfo, segs){
  const chipHtml = [];
  basesInfo.forEach(({base, master, ov}, idx) => {
    const entry = mapDigitToEntry(base);
    const majors = entry.majors || entry.Majors || [];
    const signs  = unique([...(entry.signs||entry.Signs||[]), ...(ov && ov.signs || [])]);
    const minors = minorsForBase(base);
    chipHtml.push(`<div class="chip">Seg ${idx+1}: ${segs[idx]} â†’ ${master? master+'â†’':''}${base} Â· ${signs.join('/')} Â· Majors: ${majors.join(', ')} Â· Minors: ${minors.join(', ')}</div>`);
  });
  return chipHtml.join('');
}

// ========= UI actions =========
function analyze(){
  const raw = $('num').value.trim();
  if(!raw){ alert('Enter a number.'); return; }

  const segs = splitPairsLeft(raw);
  const basesInfo = segs.map(s => segmentBase(s));
  const bases = basesInfo.map(x => x.base);
  const finalBase = reduceDigit(bases.reduce((a,b)=>a+b,0));

  $('resultCard').style.display = 'block';
  $('segments').textContent = segs.join(', ');
  $('bases').textContent = basesInfo.map(x => (x.master? x.master+'â†’':'') + x.base).join(', ');
  $('finalBase').textContent = String(finalBase);
  $('chips').innerHTML = buildChips(basesInfo, segs);

  const html = buildReadingHTML(raw, segs, basesInfo, finalBase);
  $('reading').innerHTML = html;

  $('status').textContent = 'Done';
  setTimeout(()=> $('status').textContent='', 2000);
}

function copyReading(){ 
  const txt = getSpeechText(($('reading').innerHTML||'').trim());
  navigator.clipboard.writeText(txt + '\nâ€” Spirit Guide App').then(()=> alert('Copied reading (speechâ€‘friendly)'));
}
function copyReadingHtml(){
  const html = $('reading').innerHTML;
  const blob = new Blob([html], {type:'text/html'});
  const reader = new FileReader();
  reader.onload = function(){ navigator.clipboard.writeText(reader.result).then(()=> alert('Copied HTML')); };
  reader.readAsText(blob);
}

$('analyzeBtn').onclick = analyze;
$('copyBtn').onclick = copyReading;
$('copyHtmlBtn').onclick = copyReadingHtml;

// ========= Narrator (Google-only) + speech sanitizer =========
const STORAGE = { name:'sg_voice_name', lang:'sg_voice_lang', force:'sg_voice_force_en', rate:'sg_voice_rate', pitch:'sg_voice_pitch' };
const prefer = ["Google UK English Female","Google UK English Male","Google US English","Google US English Female","Google US English Male"];
let voices = [];
function isGoogle(v){ return /google/i.test(v.name||''); }
function englishOnly(v){ return $('forceEnglish').checked ? /^en[-_]/i.test(v.lang||'') : true; }
function populateVoices(){
  const list = window.speechSynthesis.getVoices()||[];
  if(!list.length){ setTimeout(populateVoices, 250); return; }
  voices = list.filter(v => isGoogle(v) && englishOnly(v));
  const sel = $('voiceSelect'); sel.innerHTML='';
  voices.forEach(v=>{ const opt=document.createElement('option'); opt.value=v.name+'::'+v.lang; opt.textContent=`${v.name} (${v.lang})`; sel.appendChild(opt); });

  const savedName = localStorage.getItem(STORAGE.name), savedLang = localStorage.getItem(STORAGE.lang);
  if(savedName && savedLang){
    const idx = Array.from(sel.options).findIndex(o => o.value === (savedName+'::'+savedLang));
    if(idx>=0){ sel.selectedIndex=idx; } else { sel.selectedIndex=0; }
  } else {
    let picked=false;
    for(const p of prefer){
      const idx = Array.from(sel.options).findIndex(o => o.textContent.includes(p));
      if(idx>=0){ sel.selectedIndex=idx; picked=true; break; }
    }
    if(!picked && sel.options.length) sel.selectedIndex=0;
  }
}
function currentVoice(){
  const sel = $('voiceSelect'); if(!sel || sel.selectedIndex<0) return null;
  const [name, lang] = sel.value.split('::');
  return (window.speechSynthesis.getVoices()||[]).find(v => v.name===name && v.lang===lang) || null;
}
function savePrefs(){
  const sel = $('voiceSelect'); const [name, lang] = (sel.value||'::').split('::');
  localStorage.setItem(STORAGE.name, name||''); localStorage.setItem(STORAGE.lang, lang||'');
  localStorage.setItem(STORAGE.force, $('forceEnglish').checked ? '1':'0');
  localStorage.setItem(STORAGE.rate, String($('rate').value)); localStorage.setItem(STORAGE.pitch, String($('pitch').value));
}
function loadPrefs(){
  $('forceEnglish').checked = localStorage.getItem(STORAGE.force) === '1';
  const r = parseFloat(localStorage.getItem(STORAGE.rate)); if(!isNaN(r)) $('rate').value = r;
  const p = parseFloat(localStorage.getItem(STORAGE.pitch)); if(!isNaN(p)) $('pitch').value = p;
}

function decodeEntities(html){
  const txt = document.createElement('textarea');
  txt.innerHTML = html;
  return txt.value;
}
function getSpeechText(html){
  let text = decodeEntities(html);
  text = text.replace(/<script[\s\S]*?<\/script>/gi,' ')
             .replace(/<style[\s\S]*?<\/style>/gi,' ')
             .replace(/<[^>]+>/g,' ');
  // Replace symbols that get read out oddly
  text = text.replace(/â†’/g,' to ')
             .replace(/â€¢/g,', ')
             .replace(/[#*_`~^]/g,' ')
             .replace(/\s{2,}/g,' ')
             .trim();
  return text;
}

function speak(textHtml){
  if(!('speechSynthesis' in window)) return alert('Speech not supported here.');
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance();
  const cleaned = getSpeechText(textHtml || $('reading').innerHTML || '');
  u.text = "Reflective guidance only. " + (cleaned || 'Please analyze a number first.');
  u.rate = parseFloat($('rate').value||'1'); u.pitch = parseFloat($('pitch').value||'1'); u.volume = 1.0;
  const v = currentVoice(); if(v) u.voice = v;
  window.speechSynthesis.speak(u);
}

$('testVoiceBtn').onclick = ()=>{ savePrefs(); speak('Hello'); };
$('speakBtn').onclick     = ()=> speak();
$('stopBtn').onclick      = ()=> window.speechSynthesis && window.speechSynthesis.cancel();
$('voiceSelect').onchange = savePrefs;
$('forceEnglish').onchange= ()=>{ savePrefs(); populateVoices(); };
$('rate').oninput = savePrefs; $('pitch').oninput = savePrefs;

if('speechSynthesis' in window){
  loadPrefs();
  window.speechSynthesis.onvoiceschanged = populateVoices;
  populateVoices();
} else {
  $('status').textContent = 'Speech not supported in this browser';
}

// Ready
Promise.all([fetch(MAP_URL).then(r=>r.json()).catch(()=>null),
             fetch(OV_URL).then(r=>r.json()).catch(()=>({}))])
  .then(([map, ov]) => {
    DB = map || {}; OV = ov || {};
    $('status').textContent = 'Ready';
    setTimeout(()=> $('status').textContent='', 1500);
  });
</script>
</body>
</html>
